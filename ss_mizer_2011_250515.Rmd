---
title: "Orca_tuneparams_May25"
author: "Viv Tulloch"
date: "2025-05-21"
output:
  pdf_document: default
  html_document: default
---


## Create a mizer model

```{r message=FALSE}
remotes::install_github("sizespectrum/mizerExperimental")
library(mizerExperimental)
remotes::install_github("sizespectrum/mizerMR")
library(mizerMR)
library(tidyverse)
```


```{r}
#oprn model 
ss_species_params <-   read.csv(
  "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_Nov24/pars_241212/ss_pars_2011_241212_2.csv")

ss_gear_params<-read.csv("/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_Nov24/pars_241212/ss_gear_2011_241212.csv")

ss_interaction <-   read.csv(
    "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_Nov24/pars_241212/ss_mizer_interaction_241212.csv", row.names=1)



```

## setting fishing effort to 1, so that catchability = fishing mortality

```{r}
cur_model <- newMultispeciesParams(species_params = ss_species_params, 
                                   interaction = ss_interaction, 
                                   gear_params = ss_gear_params,
                                  initial_effort = 1,
                                   lambda = 2.05, n=0.75,  p = 0.75, w_pp_cutoff = 50, kappa = 2372072334750
                                   )
```

**Step 2: Project to steady state**

```{r}
#rm(cur_model_steady)
cur_model_steady <- steady(cur_model)
species_params(cur_model_steady)
plotlySpectra(cur_model_steady, power = 2)
```

**Step 3: Calibrate the scale**
**Step 4: Rescale species spectra**

```{r}
cur_model <- calibrateBiomass(cur_model_steady)
plotBiomassVsSpecies(cur_model)
cur_model <- matchBiomasses(cur_model)
plotBiomassVsSpecies(cur_model)
species_params(cur_model)
```


#Repeat
Rescaling the spectra of the individual species has not created another steady state. All species now experience a new prey distribution and a new predator distribution and so their growth and death rates have changed, which requires us to run the dynamics again to find the new steady state. So we essentially go back to step 2 and project to steady state:

```{r}
cur_model <- cur_model |>
     matchBiomasses() |> steady() |> matchBiomasses() |> steady() |>
   matchBiomasses() |> steady() |> matchBiomasses() |> steady() 

plotSpectra(cur_model, power = 2)
plotDiet(cur_model)#, species = "California_sea_lions")
plotGrowthCurves(cur_model, species_panel = TRUE)
plotlyFeedingLevel(cur_model)
getReproductionLevel(cur_model)
species_params(cur_model)
```

## Tune parameters (web interface)

```{r}
tuneParams(cur_model)
```

```{r}
tuned_model <- readRDS("~/Downloads/tuned_params (51).rds")
dft1<-species_params(tuned_model)
species_params(tuned_model)
getReproductionLevel(tuned_model)
plotDiet(tuned_model)#, species = "California_sea_lions")
plotGrowthCurves(tuned_model, species_panel = TRUE)
plotlyFeedingLevel(tuned_model)
tuned_model@resource_params$kappa
tuned_model@species_params$biomass_model[5]
```


# explore initial projections based on tuned model
```{r}
 sim1 <- project(tuned_model, effort = 1, t_max = 30, t_save=3)
 plot(sim1)
 
 animateSpectra(sim1, total = TRUE, power = 1)
 plotlyBiomassRelative(sim1)

```


```{r}
saveParams(tuned_model, "ss_mizerout2011_pars_241212_fishing1.rds")
dfnew<-(species_params(tuned_model))

write.csv(dfnew, "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_Nov24/pars_241212/ss_mizerout2011_pars_241212_fishing1.csv")
saveParams(tuned_model, "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_Nov24/pars_241212/ss_mizerout2011_pars_241212_fishing1.rds")
```

## TUNE RESILIENCE - FISHING
```{r}
cm1<-tuned_model
cm1 <- setBevertonHolt(cm1, erepro = 0.7)
species_params(cm1) |> select(erepro, R_max)
getRDI(cm1) / getRDD(cm1)
plotSpectra(cm1, power = 2)
```

Setting generic gear selectivity
If you have system specific data on how changes in fishing under system specific gear parameters change species biomasses, you should use these system specific details. We do not have such data for Curonian Lagoon, so we will explore species responses in general. For that purpose, for this exploration of the resilience of species, we set the gear parameters in such a way that all species are fished similarly.
To tune the resilience of each species to extra mortality we will set catchability of all species to 1, so that effort values directly reflect fishing mortality. We will also set gear 50% selectivity to half the maturation length of each species and 25% selection to half the 25% maturation length.

Gear selectivity parameters are defined by length, so we will first convert w_mat and w_mat25 to length values.
```{r}
weight_to_length <- function(w, cm1) {
    a <- species_params(cm1)$a
    b <- species_params(cm1)$b
    (w / a) ^ (1 / b)
}

l_mat = weight_to_length(species_params(cm1)$w_mat, cm1)
l_25mat = weight_to_length(species_params(cm1)$w_mat25, cm1)

```

We assign the model that uses these new gear parameters in a new variable cm_generic_gear so that we can keep the old model around.
```{r}
# We start with the current gear parameters
gp <- gear_params(cm1)
# and update values in l50 and l25 columns
gp$l50 <- l_mat / 2
gp$l25 <- l_25mat / 2
# and set all catchability to 1
gp$catchability <- 1


cm1_generic_gear <- cm1
# Set new gear parameters for the new model 
gear_params(cm1_generic_gear) <- gp
plotFMort(cm1_generic_gear)
```
As always after having changed model parameters, we need to bring the model to steady state again.
```{r}
cm1_generic_gear <- steady(cm1_generic_gear)
```


Exploring yield curves
To measure the resilience of our species to fishing, we will change the fishing mortality for one species at a time and check how their yields, spawning-stock biomasses (SSB) and reproduction rate (RDD) change in response. We keep the fishing mortality for the other species fixed. For our selected species we run through a range of fishing mortalities between 0 and a maximum. For each fishing mortality we run the projection until the system has settled down to a new steady state. Then we calculates the yield, the spawning stock biomass SSB and the reproduction rate RDD in that steady state. After doing that for all fishing mortalities we can plot all the results in a graph. The plotYieldCurve() function does all that for us. Here we plot the yield curve for smallfish.
```{r}
# First we save current reproduction level into a vector 
rep_level <- getReproductionLevel(cm1_generic_gear)
```


# inverts
```{r}
plotYieldVsF(cm1_generic_gear, species = "Invertebrates", F_max = 2)
getReproductionLevel(cm1_generic_gear)["Invertebrates"]
```

```{r}

# then we replace our species' reproduction level with a new value 
rep_level["Invertebrates"] <- 0.7
# and asign it back to the model 
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)

# and plot F curves again
plotYieldVsF(cm1_generic_gear, species = "Invertebrates", F_max = 1)
```

#herring
```{r}
plotYieldVsF(cm1_generic_gear, species = "Pacific_Herring", F_max = 2)
getReproductionLevel(cm1_generic_gear)["Pacific_Herring"]
```

We do not know how much we need to reduce the reproduction level to get a sufficiently low F MSY. We just try some values. Letâ€™s try 0.3.

```{r}
# then we replace our species' reproduction level with a new value 
rep_level["Pacific_Herring"] <- 0.5
# and asign it back to the model 
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)

# and plot F curves again
plotYieldVsF(cm1_generic_gear, species = "Pacific_Herring", F_max = 1)
```

#small plankt fish
```{r}
plotYieldVsF(cm1_generic_gear, species = "Small_Planktivorous_Fish", F_max = 2)
getReproductionLevel(cm1_generic_gear)["Small_Planktivorous_Fish"]
```

```{r}
# then we replace our species' reproduction level with a new value 
rep_level["Small_Planktivorous_Fish"] <- 0.5
# and asign it back to the model 
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)

# and plot F curves again
plotYieldVsF(cm1_generic_gear, species = "Small_Planktivorous_Fish", F_max = 1)
```

#hake
```{r}
plotYieldVsF(cm1_generic_gear, species = "Hake", F_max = 1)
```

```{r}
rep_level["Hake"] <- 0.26
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)
plotYieldVsF(cm1_generic_gear, species = "Hake", F_max = 1)
```

#lingcod
```{r}
plotYieldVsF(cm1_generic_gear, species = "Lingcod", F_max = 1)
```

```{r}
rep_level["Lingcod"] <- 0.6
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)
plotYieldVsF(cm1_generic_gear, species = "Lingcod", F_max = 1)
```

#rockfish
```{r}
plotYieldVsF(cm1_generic_gear, species = "Rockfish", F_max = 1)
```

```{r}
rep_level["Rockfish"] <- 0.3
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)

plotYieldVsF(cm1_generic_gear, species = "Rockfish", F_max = 1)
```

#halibut
```{r}
plotYieldVsF(cm1_generic_gear, species = "Halibut", F_max = 1)
```

```{r}
rep_level["Halibut"] <- 0.35
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)

plotYieldVsF(cm1_generic_gear, species = "Halibut", F_max = 1)
```

#salmon
```{r}
plotYieldVsF(cm1_generic_gear, species = "Chinook_Hatch_Adult", F_max = 1)
```
```{r}
rep_level["Chinook_Hatch_Adult"] <- 0.75
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)
plotYieldVsF(cm1_generic_gear, species = "Chinook_Hatch_Adult", F_max = 1)
```

```{r}
plotYieldVsF(cm1_generic_gear, species = "Coho_Hatch_Adult", F_max = 1)
```

```{r}
rep_level["Coho_Hatch_Adult"] <- 0.78
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)
plotYieldVsF(cm1_generic_gear, species = "Coho_Hatch_Adult", F_max = 1)
```

```{r}
plotYieldVsF(cm1_generic_gear, species = "Coho_Wild_Adult", F_max = 1)
```

```{r}
rep_level["Coho_Wild_Adult"] <- 0.78
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)

plotYieldVsF(cm1_generic_gear, species = "Coho_Wild_Adult", F_max = 1)
```

```{r}
plotYieldVsF(cm1_generic_gear, species = "Chinook_Hatch_Resident", F_max = 1)
rep_level["Chinook_Hatch_Resident"]
```

```{r}
rep_level["Chinook_Hatch_Resident"] <- 0.78
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)

plotYieldVsF(cm1_generic_gear, species = "Chinook_Hatch_Resident", F_max = 1)
```

```{r}
plotYieldVsF(cm1_generic_gear, species = "Chinook_Wild_Resident", F_max = 1)
rep_level["Chinook_Wild_Resident"]
```

```{r}
rep_level["Chinook_Wild_Resident"] <- 0.78
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)
plotYieldVsF(cm1_generic_gear, species = "Chinook_Wild_Resident", F_max = 1)
```

```{r}
plotYieldVsF(cm1_generic_gear, species = "Other_fish", F_max = 1)
rep_level["Other_fish"]
```

```{r}
rep_level["Other_fish"] <-   0.9
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)
plotYieldVsF(cm1_generic_gear, species = "Other_fish", F_max = 1)
```


#####################
##Set new reproduction levels
Above we studied the resilience of species to changes in their mortality imposed by an artificial fishing gear. We used guidance from a classification of species into resilience classes and the expected F MSY  derived from very simple single-species models to adjust the reproduction levels for our species. Now we will use those reproduction levels in our model with the original gear parameters.
  
```{r}
cm1 <- setBevertonHolt(cm1, reproduction_level = rep_level)
saveParams(cm1, "cur_model_resilient_tunedMay25b.rds")
dfcm1<-(species_params(cm1))

write.csv(dfcm1, "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_Jan25/ss_mizerout2011_pars_250523_fishing1_restune2.csv")
saveParams(cm1, "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_Jan25/ss_mizerout2011_pars_250523_fishing1_restune2.rds")
```

##Scenario 1: Change fishing effort
We use the model with tuned reproduction and change the total fishing effort. We run the simulation with the changed effort long enough so that it again settles down to a steady state and then look at how the system evolved over this time period.


## status quo
```{r}
initial_effort(cm1)
simt1 <- project(cm1, t_max = 100,t_save=5)
animateSpectra(simt1, power = 2)
 plotlyBiomassRelative(simt1)
```

## increase fishing 20%
```{r}
simt1_fish <- project(cm1, effort =1.2, t_max = 100,t_save=5)
animateSpectra(simt1_fish, power = 2)
 plotlyBiomassRelative(simt1_fish)
```

#manually tune parameters
```{r}

params_e3<-cm1
species_params(params_e3)$gamma[4] <- species_params(params_e3)$gamma[4] *2

params_e3<- setParams(params_e3)

params_e3 <-  params_e3 |> steady() |> 
  matchBiomasses() |> steady() |> matchBiomasses() |> steady()

 species_params(params_e3)
  plotGrowthCurves(params_e3, species_panel = TRUE)
 
simte3 <- project(params_e3, effort=1, t_max = 100, t_save=5)
plotlyBiomassRelative(simte3)
```


```{r}
saveParams(params_e3, "cur_model_resilient_tunedMay25b.rds")
dfcm1<-(species_params(params_e3))

write.csv(dfcm1, "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_Jan25/ss_mizerout2011_pars_250523_fishing1_restune2.csv")
saveParams(params_e3, "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_Jan25/ss_mizerout2011_pars_250523_fishing1_restune2.rds")
```

















