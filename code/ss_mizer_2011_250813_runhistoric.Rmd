---
title: "Orca_tuneparams_May25"
author: "Viv Tulloch"
date: "2025-05-21"
output:
  pdf_document: default
  html_document: default
editor_options: 
  markdown: 
    wrap: 72
---

## Create a mizer model

```{r message=FALSE}
remotes::install_github("sizespectrum/mizerExperimental")
library(mizerExperimental)
remotes::install_github("sizespectrum/mizerMR")
library(mizerMR)
library(tidyverse)
#rm(cur_model_steady)
```

## try fixing the fishing catch for sog for herring as it seems to be under (should be ~0.5)
### STATUS QUO

```{r}
tuned_model3 <- readRDS("C:/Users/MCSHANEV/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_May25/ss_mizerout2011_pars_250602c_newsplitfishing_histeffort_updpinn.rds")

gear_params_updherring <- read.csv("C:/Users/MCSHANEV/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/fisheries/time series fisheries/gear_params2011_allfisheries_250813.csv") 

```


```{r}

new_model<- tuned_model3
gear_params(new_model)<-gear_params_updherring

new_model <- setFishing(new_model, initial_effort=1)

 new_model <-  new_model |> steady() |> matchBiomasses() |> steady()  |> 
     matchBiomasses() |> steady() |>  matchBiomasses() |> steady() |> matchBiomasses() |> steady() |> 
     matchBiomasses() |> steady() |>  matchBiomasses() |> steady() |> matchBiomasses() |> steady() |> 
      matchBiomasses() |> steady() |>  matchBiomasses() |> steady() |> matchBiomasses() |> steady() 

 species_params(new_model)
 #gear_params(cm_cohoupd)
 getReproductionLevel(new_model)
 plotlyFeedingLevel(new_model)
 plotGrowthCurves(new_model, species_panel=TRUE)
 
sim_h<- project(new_model, t_max = 100,effort=1,  t_save=5)
#animateSpectra(sim_fish, power = 2)
 plotlyBiomassRelative(sim_h)


```

Tune PARAMS

```{r}

new_model1<- new_model

species_params(new_model1)$h[1] <- species_params(new_model1)$h[1]*1.5
species_params(new_model1)$gamma[1] <- species_params(new_model1)$gamma[1] * 1.5 #3

species_params(new_model1)$h[4] <- species_params(new_model1)$h[5]*1
species_params(new_model1)$gamma[4] <- species_params(new_model1)$gamma[5] * 1.5 #3
#species_params(new_model1)$w_min[4] <- species_params(new_model1)$w_min[4] * 0.8 #3
#species_params(new_model1)$w_mat25[4] <- species_params(new_model1)$w_mat25[4] * 0.8 #3
#pecies_params(new_model1)$w_mat[4] <- species_params(new_model1)$w_mat[4] * 0.8 #3
species_params(new_model1)$b[4] <- species_params(new_model1)$b[5] #


species_params(new_model1)$h[19] <- species_params(new_model1)$h[19]*0.8
species_params(new_model1)$gamma[19] <- species_params(new_model1)$gamma[19] * 1.3 #3

species_params(new_model1)$h[24] <- species_params(new_model1)$h[24]*0.9
species_params(new_model1)$gamma[24] <- species_params(new_model1)$gamma[24] * 0.8 #3

species_params(new_model1)$h[23] <- species_params(new_model1)$h[23]*0.9
species_params(new_model1)$gamma[23] <- species_params(new_model1)$gamma[23] * 0.8 #3

new_model1 <- setParams(new_model1)

 new_model1 <-  new_model1 |> steady() |> matchBiomasses() |> steady()  |> 
     matchBiomasses() |> steady() |>  matchBiomasses() |> steady() |> matchBiomasses() |> steady() |> 
   matchBiomasses() |> steady() |>  matchBiomasses() |> steady() |> matchBiomasses() |> steady() |> 
      matchBiomasses() |> steady() |>  matchBiomasses() |> steady() |> matchBiomasses() |> steady() 

 species_params(new_model1)
 #gear_params(cm_cohoupd)
 getReproductionLevel(new_model1)
 plotlyFeedingLevel(new_model1)
 plotGrowthCurves(new_model1, species_panel=TRUE)
 
sim_h<- project(new_model1, t_max = 100,effort=1,  t_save=5)
#animateSpectra(sim_fish, power = 2)
 plotlyBiomassRelative(sim_h)


```



#tuned_params <- readRDS("C:/Users/MCSHANEV/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/~/orcamizerps_upd/tuned_params_aug25_3.rds")

# species_params(tuned_params)
##gear_params(cm_cohoupd)
# getReproductionLevel(tuned_params)
# plotlyFeedingLevel(tuned_params)
# plotGrowthCurves(tuned_params, species_panel=TRUE)
 
#sim_1<- project(tuned_params, t_max = 100,effort=1,  t_save=5)
# plotlyBiomassRelative(sim_1)



### TRY TO RUN HISTORICAL MODEL

```{r}

All_fisheries_effort_array <- as(read.csv("C:/Users/MCSHANEV/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/fisheries/time series fisheries/All_fisheries_effort_array_250526_modhake.csv", row.names = 1), "matrix")

relative_effort <- sweep(All_fisheries_effort_array, 2, All_fisheries_effort_array["2011", ], "/")
relative_effort[as.character(1986:2011), ]
relative_effort[is.nan(relative_effort)] <- 0

#remove years after 2011
new_rel_effort<-head(relative_effort,-7)
```

We could just project forward with these relative efforts. However, the
population dynamics in the early years will be strongly determined by
the initial population abundances (known as the transient behaviour -
essentially the initial behaviour before the long term dynamics are
reached). As this is ecology, we don’t know what the initial abundance
are. One way around this is to project forward at a constant fishing
mortality equal to the mortality in the first historical year until
equilibrium is reached. We then use this steady state as the initial
state for the simulation. This approach reduces the impact of transient
dynamics.

```{r}
#project to zero fishing rate 
new_model_hist0 <- projectToSteady(new_model1, effort = 0, t_max=50)
new_model_hist1 <- projectToSteady(new_model, effort = 1)
#new_model02 <- projectToSteady(new_model, effort = 0)
```

```{r}

sim0 <- project(new_model_hist0, 
                        effort = 0,  
                        t_max=50,
                        return_sim = TRUE)
plotlyBiomassRelative(sim0)

```


```{r}
#new_rel_effortX<-tail(new_rel_effort,-11)
t_per=0.9

new_model_hist <- projectToSteady(new_model_hist0, 
                                #new_model01,
                                 distance_func = distanceSSLogN,
                                  t_per = 0.3,
                               # t_max = 100,
                              #  dt = 0.1,
                               # return_sim = FALSE,
                               #  progress_bar = TRUE,
                                tol = 0.5 * t_per,
                                effort = new_rel_effort["1986", ])
```

We now have our parameter object and out matrix of efforts relative to
1986. We use this effort matrix as the effort argument to the project()
function. We use dt = 0.25 (the simulation will run faster than with the
default value of 0.1, but tests show that the results are still stable)
and save the results every year.

```{r}
sim_hist <- project(new_model_hist, 
                  #new_model01,
                    effort = new_rel_effort, 
                    t_max=100, 
                    dt = 0.1, t_save = 1)
plotlyBiomassRelative(sim_hist)
plotYield(sim_hist)
plotlyBiomass(sim_hist)

```

To explore the state of the community it is useful to calculate
indicators of the unexploited community. Therefore we also project
forward to the steady state with 0 fishing effort.

```{r}

sim0 <- project(new_model_hist0, 
                        effort = 0,  
                        t_max=100,
                        return_sim = TRUE)
plotlyBiomassRelative(sim0)

```

```{r}

saveParams(new_model_hist0, "ss_mizerout2011_pars_250813_updherring.rds")
dfnew<-(species_params(new_model_hist0))

write.csv((species_params(new_model_hist0)), 
          "C:/Users/MCSHANEV/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_May25/ss_mizerout2011_pars_250813_updherring.csv")

write.csv((gear_params(new_model_hist0)), 
          "C:/Users/MCSHANEV/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_May25/ss_mizerout2011_gears_250813.csv")
saveParams(new_model_hist0, "C:/Users/MCSHANEV/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_May25/ss_mizerout2011_pars_250813_updherring.rds")

```

##marine mammals need to be updated they aren't changing

```{r}
new_model_histcR <- new_model_hist1
species_params(new_model_histcR)$z0[19] <- species_params(new_model_histcR)$z0[19]*0.8
species_params(new_model_histcR)$z0[20:21] <- species_params(new_model_histcR)$z0[20:21]*0.1
species_params(new_model_histcR)$erepro[19:21] <- species_params(new_model_histcR)$erepro[19:21]*1.8
species_params(new_model_histcR)$gamma[20:21] <- species_params(new_model_histcR)$gamma[20:21]*2
species_params(new_model_histcR)$h[20:21] <- species_params(new_model_histcR)$h[20:21]*0.8


species_params(new_model_histcR)$z0[23] <- species_params(new_model_histcR)$z0[23]*1.08
species_params(new_model_histcR)$erepro[24:25] <- species_params(new_model_histcR)$erepro[24:25]*1.6
species_params(new_model_histcR)$z0[24:25] <- species_params(new_model_histcR)$z0[24:25]*0.45

new_model_histcR<-setParams(new_model_histcR)

##spin up
new_model_spinup <- projectToSteady(new_model_histcR, effort = 0)

##regular projection
sim_histc <- project(new_model_spinup, 
                  #new_model_histcR,
                    effort = new_rel_effort, 
                    t_max=50, 
                    dt = 0.1, t_save = 1)
#plots
plotlyBiomassRelative(sim_histc)
plotYield(sim_histc)
plotlyBiomass(sim_histc)
 plotlyFeedingLevel(sim_histc)
 species_params(new_model_spinup)
#plotlyBiomassRelative(sim_histc, species="Resident_Orca_S")
#plotlyBiomassRelative(sim_histc, species="Resident_Orca_N")
#plotlyBiomassRelative(sim_histc, species="Transient_Orca")
#plotlyBiomassRelative(sim_histc, species="Harbor_seals")
#plotlyBiomassRelative(sim_histc, species="Steller_sealions")



```

#save params new_model_histc in ss_pars

```{r}

saveParams(new_model_spinup, "ss_mizerout2011_pars_250813_new_model_spinup2.rds")
dfnewspin<-(species_params(new_model_spinup))

write.csv((species_params(new_model_spinup)), 
          "C:/Users/MCSHANEV/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_May25/ss_mizerout2011_pars_250813_new_model_spinup2.csv")

write.csv((gear_params(new_model_spinup)), 
          "C:/Users/MCSHANEV/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_May25/ss_mizerout2011_gears_250813_new_model_spinup2.csv")
saveParams(new_model_spinup, "C:/Users/MCSHANEV/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_May25/ss_mizerout2011_pars_250813_new_model_spinup2.rds")

```

```{r}
#PROP LARGE FISH
write.csv(getProportionOfLargeFish(sim_histc), "C:/Users/MCSHANEV/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250813/sim_fishing_hist_proplrgfish_Fin.csv") ##fishing=0

#SPAWNING STOCK BIOMASS
write.csv(getSSB(sim_histc), "C:/Users/MCSHANEV/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250813/sim_fishing_hist_SSB_Fin.csv") ##

##predation mortality
write.csv(getM2(sim_histc), "C:/Users/MCSHANEV/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250813/sim_fishing_hist_predmort_Fin.csv") 

## yield
write.csv(getYield(sim_histc), "C:/Users/MCSHANEV/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250813/sim_fishing_hist_yield_Fin.csv")

## yield
write.csv(getN(sim_histc), "C:/Users/MCSHANEV/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250813/sim_fishing_hist_yield_Fin.csv")
```

######################### CHECKS!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
### check N for 2011 from sim compared to initial N

```{r}
# Load required libraries
library(ggplot2)
library(dplyr)
library(reshape2)

# Extract N from simulation for 2011 and calculate total biomass by species
N_2011 <- sim_histc@n["2011", , ]  # Get abundance matrix for 2011

# Get the size bins (body weights)
w_sizes <- as.numeric(dimnames(sim_histc@n)$w)

# Calculate biomass by species (abundance * weight, summed across size classes)
# N is abundance, w is weight, so biomass = N * w
biomass_sim_2011 <- apply(N_2011, 1, function(n) sum(n * w_sizes))

# Get observed biomass from species_params
species_names <- names(biomass_sim_2011)
observed_biomass <- species_params(tuned_model3)$biomass_observed
names(observed_biomass) <- species_params(tuned_model3)$species

# Create comparison data frame
comparison_df <- data.frame(
  species = species_names,
  simulated_biomass = biomass_sim_2011,
  observed_biomass = observed_biomass[species_names],
  stringsAsFactors = FALSE
)

# Remove species with NA observed biomass
comparison_df <- comparison_df[!is.na(comparison_df$observed_biomass), ]

# Calculate ratio and percentage difference
comparison_df$ratio_sim_to_obs <- comparison_df$simulated_biomass / comparison_df$observed_biomass
comparison_df$percent_diff <- ((comparison_df$simulated_biomass - comparison_df$observed_biomass) / 
                               comparison_df$observed_biomass) * 100

# Print comparison table
cat("Biomass Comparison: Simulated vs Observed (2011)\n")
cat(paste(rep("=", 60), collapse = ""), "\n")
print(comparison_df)


# Summary statistics
cat("\nSummary Statistics:\n")
cat("Mean ratio (sim/obs):", round(mean(comparison_df$ratio_sim_to_obs), 3), "\n")
cat("Median ratio (sim/obs):", round(median(comparison_df$ratio_sim_to_obs), 3), "\n")
cat("Mean absolute percentage difference:", round(mean(abs(comparison_df$percent_diff)), 1), "%\n")

# Create visualization - Scatter plot
p1 <- ggplot(comparison_df, aes(x = observed_biomass, y = simulated_biomass)) +
  geom_point(size = 3, alpha = 0.7, color = "#2166AC") +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red", size = 1) +
  geom_text(aes(label = species), vjust = -0.5, hjust = 0.5, size = 3) +
  scale_x_log10(labels = scales::scientific) +
  scale_y_log10(labels = scales::scientific) +
  labs(
    x = "Observed Biomass",
    y = "Simulated Biomass (2011)",
    title = "Simulated vs Observed Biomass",
    subtitle = "Red dashed line = perfect agreement"
  ) +
  theme_classic(base_size = 12) +
  theme(
    axis.text = element_text(color = "black"),
    axis.title = element_text(face = "bold"),
    plot.title = element_text(face = "bold", size = 14)
  )

print(p1)

# Create bar plot comparison
comparison_long <- melt(comparison_df[, c("species", "simulated_biomass", "observed_biomass")],
                       id.vars = "species",
                       variable.name = "type",
                       value.name = "biomass")

p2 <- ggplot(comparison_long, aes(x = reorder(species, biomass), y = biomass, fill = type)) +
  geom_bar(stat = "identity", position = "dodge", alpha = 0.8) +
  scale_y_log10(labels = scales::scientific) +
  scale_fill_manual(values = c("simulated_biomass" = "#2166AC", "observed_biomass" = "#D73027"),
                   labels = c("Simulated", "Observed")) +
  labs(
    x = "Species",
    y = "Biomass (log scale)",
    title = "Biomass Comparison by Species (2011)",
    fill = "Type"
  ) +
  theme_classic(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, color = "black"),
    axis.text.y = element_text(color = "black"),
    axis.title = element_text(face = "bold"),
    plot.title = element_text(face = "bold", size = 14),
    legend.position = "top"
  )

print(p2)

# Create ratio plot
p3 <- ggplot(comparison_df, aes(x = reorder(species, ratio_sim_to_obs), y = ratio_sim_to_obs)) +
  geom_col(fill = "#2166AC", alpha = 0.7) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "red", size = 1) +
  labs(
    x = "Species",
    y = "Ratio (Simulated / Observed)",
    title = "Simulation Performance by Species",
    subtitle = "Red line = perfect agreement (ratio = 1)"
  ) +
  theme_classic(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, color = "black"),
    axis.text.y = element_text(color = "black"),
    axis.title = element_text(face = "bold"),
    plot.title = element_text(face = "bold", size = 14)
  )

print(p3)

# Identify species with largest discrepancies
cat("\nSpecies with largest overestimation (ratio > 2):\n")
overestimated <- comparison_df[comparison_df$ratio_sim_to_obs > 2, ]
if(nrow(overestimated) > 0) {
  print(overestimated[, c("species", "ratio_sim_to_obs", "percent_diff")])
} else {
  cat("None\n")
}

cat("\nSpecies with largest underestimation (ratio < 0.5):\n")
underestimated <- comparison_df[comparison_df$ratio_sim_to_obs < 0.5, ]
if(nrow(underestimated) > 0) {
  print(underestimated[, c("species", "ratio_sim_to_obs", "percent_diff")])
} else {
  cat("None\n")
}

# Alternative method: Compare using getN() function (total biomass)
# This gives you the same result but using mizer's built-in function
biomass_total_2011 <- getN(sim_histc)["2011", ]

cat("\n\nVerification using getN() function:\n")
cat("Results should be identical to manual calculation above\n")
verification_df <- data.frame(
  species = names(biomass_total_2011),
  getN_biomass = as.numeric(biomass_total_2011),
  manual_biomass = biomass_sim_2011[names(biomass_total_2011)]
)
print(head(verification_df))

# Check if results match
cat("Manual and getN() results identical:", 
    all.equal(verification_df$getN_biomass, verification_df$manual_biomass), "\n")

# Save comparison results
write.csv(comparison_df, "biomass_comparison_2011.csv", row.names = FALSE)
cat("\nResults saved to 'biomass_comparison_2011.csv'\n")
```

```{r}
# Method 1: Get initial N from MizerParams object
N_initial <- new_model_spinup@initial_n

# Check the dimensions and structure
cat("Dimensions of N matrix:\n")
cat("Species:", nrow(N_initial), "\n")
cat("Size classes:", ncol(N_initial), "\n")

# View the structure
str(N_initial)

# Method 8: Compare with biomass_observed if available
if("biomass_observed" %in% colnames(species_params(new_model_spinup))) {
  observed_biomass1 <- species_params(new_model_spinup)$biomass_observed
  names(observed_biomass) <- species_params(new_model_spinup)$species
  
  comparison <- data.frame(
    species = names(biomass_sim_2011),
    observed_biomass_2011= species_params(tuned_model3)$biomass_observed,
      observed_biomass1 <- species_params(new_model_spinup)$biomass_observed
  )
  
  
  cat("\nComparison with observed biomass:\n")
  print(comparison)
}
```

##################### PLOTTING ########################################

```{r}
library(dplyr)
library(reshape2)
library(ggplot2)

df<-read.csv("C:/Users/MCSHANEV/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/survey_MM_hist.csv")
df_rel<-read.csv("C:/Users/MCSHANEV/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/survey_MM_hist_rel.csv")

## GET SURVEY
df_surv <- melt(df_rel, id.vars = "time", variable.name = "sp", value.name = "value")

MMsp<- c("Harbor_seals","Steller_sealions", "California_sealions", "Resident_Orca_S", "Resident_Orca_N", "Transient_Orca")

#### GET RELATIVE BIOMASS PREDICTIONS
# Get the full biomass matrix (all species)
biomass <- getN(sim_histc)
# Subset the matrix to keep only the desired species (columns)
biomass_selected <- biomass[, MMsp]
# Relative to initial biomass
B_initial <- biomass_selected["2011", ]  # vector: species
relative_biomass <- sweep(biomass_selected, 2, B_initial, "/")

# Convert to long for ggplot
relative_biomass_long <- melt(relative_biomass, varnames = c("time", "sp"), value.name = "relative_biomass")

# Recode species names
relative_biomass_long <- relative_biomass_long %>%
  mutate(sp = recode(sp,
    "Harbor_seals" = "Harbor Seals",
    "Steller_sealions" = "Steller Sea Lions",
    "California_sealions" = "California Sea Lions",
    "Resident_Orca_S" = "SRKW",
    "Resident_Orca_N" = "NRKW",
    "Transient_Orca" = "TKW"
  ))

df_surv <- df_surv %>%
  mutate(sp = recode(sp,
    "Harbor_seals" = "Harbor Seals",
    "Steller_sealions" = "Steller Sea Lions",
    "California_sealions" = "California Sea Lions",
    "Resident_Orca_S" = "SRKW",
    "Resident_Orca_N" = "NRKW",
    "Transient_Orca" = "TKW"
  ))

# CLEAN THE DATA - Remove rows with missing or infinite values
df_surv_clean <- df_surv %>%
  filter(is.finite(value) & !is.na(value))

# Check how much data was removed
cat("Original survey data rows:", nrow(df_surv), "\n")
cat("Cleaned survey data rows:", nrow(df_surv_clean), "\n")
cat("Rows removed:", nrow(df_surv) - nrow(df_surv_clean), "\n")

# Plot without trendline
ggplot(relative_biomass_long) +
    geom_line(aes(x = time, y = relative_biomass)) +
    geom_point(data = df_surv_clean, aes(x = time, y = value), color = "blue", size = 0.8) +
    facet_wrap(~sp, scales = "free", nrow = 2) +
    theme(legend.position = "none") +
    labs(x = "Year", y = "Relative Biomass")

# Plot with trendline (using cleaned data)
ggplot(relative_biomass_long) +
  geom_line(aes(x = time, y = relative_biomass)) +
  geom_point(data = df_surv_clean, aes(x = time, y = value), color = "blue", size = 1.5) +
  geom_smooth(
    data = df_surv_clean,
    aes(x = time, y = value),
    method = "lm",
    color = "blue",
    linetype = "dashed",
    size = 0.5,
    se = FALSE
  ) +
  facet_wrap(~sp, scales = "free", nrow = 2) +
  theme(legend.position = "none") +
  labs(x = "Year", y = "Relative Biomass")

# Alternative: Suppress warnings if you don't want to see them
# suppressWarnings({
#   your_plot_code_here
# })
```
```{r}

# Load additional packages for better formatting
library(ggplot2)
library(dplyr)
library(scales)
library(grid)
library(gridExtra)

# Create publication-ready plot
p1 <- ggplot(relative_biomass_long) +
  # Model predictions as solid line
  geom_line(aes(x = time, y = relative_biomass), 
            color = "black", 
            size = 0.8,
            alpha = 0.8) +
  
  # Survey data points
  geom_point(data = df_surv_clean, 
             aes(x = time, y = value), 
             color = "#2166AC",  # Professional blue
             size = 2,
             alpha = 0.8,
             stroke = 0.5) +
  
  # Trend line for survey data
  geom_smooth(data = df_surv_clean,
              aes(x = time, y = value),
              method = "lm",
              color = "#2166AC",
              linetype = "dashed",
              size = 0.7,
              se = FALSE,
              alpha = 0.7) +
  
  # Faceting
  facet_wrap(~sp, scales = "free_y", nrow = 2, ncol = 3) +
  
  # Clean theme
  theme_bw(base_size = 12) +
  theme(
    # Remove grid lines
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    
    # Clean panel appearance
    panel.border = element_rect(color = "black", fill = NA, size = 0.7),
    panel.background = element_rect(fill = "white"),
    
    # Strip (facet label) formatting
    strip.background = element_rect(fill = "grey90", color = "black", size = 0.7),
    strip.text = element_text(size = 11, face = "bold", color = "black"),
    
    # Axis formatting
    axis.text = element_text(size = 10, color = "black"),
    axis.title = element_text(size = 12, face = "bold", color = "black"),
    axis.ticks = element_line(color = "black", size = 0.5),
    
    # Remove legend
    legend.position = "none",
    
    # Plot margins
    plot.margin = margin(t = 10, r = 15, b = 10, l = 10, unit = "pt")
  ) +
  
  # Axis labels
  labs(x = "Year", 
       y = "Relative biomass") +
  
  # Better axis formatting
  scale_x_continuous(breaks = seq(1985, 2010, 5),
                     expand = c(0.02, 0)) +
  scale_y_continuous(labels = scales::number_format(accuracy = 0.1),
                     expand = expansion(mult = c(0.05, 0.05)))

# Display the plot
print(p1)

# Save as high-resolution image for publication
ggsave("marine_mammal_biomass.png", 
       plot = p1,
       width = 10, height = 6, 
       dpi = 300, 
       units = "in",
       bg = "white")

ggsave("marine_mammal_biomass.pdf", 
       plot = p1,
       width = 10, height = 6, 
       units = "in")

# Alternative version with different color scheme and legend
p2 <- ggplot(relative_biomass_long) +
  geom_line(aes(x = time, y = relative_biomass, linetype = "Model"), 
            color = "black", 
            size = 0.8) +
  
  geom_point(data = df_surv_clean, 
             aes(x = time, y = value, shape = "Survey data"), 
             color = "#D73027",  # Professional red
             size = 2.5,
             alpha = 0.8) +
  
  geom_smooth(data = df_surv_clean,
              aes(x = time, y = value, linetype = "Survey trend"),
              method = "lm",
              color = "#D73027",
              size = 0.7,
              se = FALSE,
              alpha = 0.8) +
  
  facet_wrap(~sp, scales = "free_y", nrow = 2, ncol = 3) +
  
  theme_classic(base_size = 12) +
  theme(
    strip.background = element_rect(fill = "white", color = "black"),
    strip.text = element_text(size = 11, face = "bold"),
    axis.text = element_text(color = "black"),
    axis.title = element_text(face = "bold"),
    legend.position = "bottom",
    legend.title = element_blank(),
    legend.text = element_text(size = 10),
    panel.border = element_rect(color = "black", fill = NA),
    plot.margin = margin(t = 10, r = 15, b = 10, l = 10, unit = "pt")
  ) +
  
  labs(x = "Year", 
       y = "Relative biomass") +
  
  scale_x_continuous(breaks = seq(1985, 2010, 5)) +
  scale_linetype_manual(values = c("Model" = "solid", 
                                   "Survey trend" = "dashed")) +
  scale_shape_manual(values = c("Survey data" = 16)) +
  
  guides(linetype = guide_legend(override.aes = list(color = c("black", "#D73027"))),
         shape = guide_legend(override.aes = list(color = "#D73027")))

print(p2)

# Additional formatting options for different journals:

# For grayscale journals
p3 <- ggplot(relative_biomass_long) +
  geom_line(aes(x = time, y = relative_biomass), 
            color = "black", size = 0.8) +
  geom_point(data = df_surv_clean, 
             aes(x = time, y = value), 
             color = "black", 
             fill = "white",
             shape = 21,
             size = 2.5,
             stroke = 0.8) +
  geom_smooth(data = df_surv_clean,
              aes(x = time, y = value),
              method = "lm",
              color = "black",
              linetype = "dashed",
              size = 0.7,
              se = FALSE) +
  facet_wrap(~sp, scales = "free_y", nrow = 2, ncol = 3) +
  theme_classic(base_size = 12) +
  theme(
    strip.background = element_rect(fill = "grey95", color = "black"),
    strip.text = element_text(size = 11, face = "bold"),
    axis.text = element_text(color = "black"),
    axis.title = element_text(face = "bold"),
    panel.border = element_rect(color = "black", fill = NA)
  ) +
  labs(x = "Year", y = "Relative biomass") +
  scale_x_continuous(breaks = seq(1985, 2010, 5))

print(p3)
```

## save indicator outputs to output folder

```{r}

saveParams(new_model_hist1, "ss_mizerout2011_pars_250813_Fin.rds")
dfnewspin<-(species_params(new_model_hist1))

write.csv((species_params(new_model_hist1)), 
          "C:/Users/MCSHANEV/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250813/ss_mizerout2011_pars_250813_Fin.csv")

write.csv((gear_params(new_model_hist1)), 
          "C:/Users/MCSHANEV/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250813/ss_mizerout2011_gears_250813_Fin.csv")
saveParams(new_model_hist1, "C:/Users/MCSHANEV/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250813/ss_mizerout2011_pars_250813_Fin.rds")


write.csv(getBiomass(new_model_hist1), "C:/Users/MCSHANEV/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250813/sim_fishing_hist_biomass_Fin.csv") ##fishing=0

write.csv(getN(new_model_hist1), "C:/Users/MCSHANEV/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250813/sim_fishing_hist_N_Fin.csv") ##fishing=0

```


#################### AUGUST 13 - future scenarios

###Future projections As well as investigating the historical
simulations, we can run projections into the future. Here we run
twoprojections to 2050 with different fishing scenarios.

Continue fishing at 2010 levels (the status quo scenario). From 2010
to2015 linearly change the fishing mortality to approach and then
continueat until 2050. Rather than looking at community indicators here,
we willcalculate the SSB of each species in the model and compare the
projectedlevels to a biodiversity target based on the reference point

Before we can run the simulations, we need to set up arrays of
futureeffort. We will continue to use effort relative to the level in
1990.Here we build on our existing array of relative effort to make an
arrayfor the first scenario. Note the use of the t() command to
transpose thearray. This is needed because R recycles by rows, so we
need to buildthe array with the dimensions rotated to start with. We
make an array ofthe future effort, and then bind it underneath the
relative_effort arrayused in the previous section.


## SCENARIO 1 - STATUS QUO


```{r}
library(abind)
# Step 1: Ensure it's an array and has year dimension names
# (Assume new_rel_effort is a 2D array with years as rownames)
dimnames(new_rel_effort)[[1]] <- as.character(dimnames(new_rel_effort)[[1]])

# Step 2: Subset to only 1986–2011
effort_base <- new_rel_effort[as.character(1986:2011), , drop = FALSE]

# Step 3: Get values for 2011 to use as reference
reference_2011 <- new_rel_effort["2011", ]

#reference_2011 <- 1.5

# Step 4: Create new array for 100yearsa, repeating 2011 values
n_years_new <- length(2012:2111)
effort_new <- array(rep(reference_2011, each = n_years_new),
                    dim = c(n_years_new, dim(new_rel_effort)[2]),
                    dimnames = list(as.character(2012:2111), dimnames(new_rel_effort)[[2]]))

# Step 5: Combine old and new arrays
scenario1 <- effort_new
scenario1comb <- abind::abind(effort_base, effort_new, along = 1)

```

#scenario2

```{r}
library(abind)
# Step 1: Ensure it's an array and has year dimension names
# (Assume new_rel_effort is a 2D array with years as rownames)
dimnames(new_rel_effort)[[1]] <- as.character(dimnames(new_rel_effort)[[1]])

# Step 2: Subset to only 1986–2011
effort_base <- new_rel_effort[as.character(1986:2011), , drop = FALSE]

# Step 3: Get values for 2011 to use as reference
#reference_2011 <- new_rel_effort["2011", ]

reference2 <- 1.5

# Step 4: Create new array for 2012–2111, repeating 2011 values
n_years_new <- length(2012:2111)
effort_new2 <- array(rep(reference2, each = n_years_new),
                    dim = c(n_years_new, dim(new_rel_effort)[2]),
                    dimnames = list(as.character(2012:2111), dimnames(new_rel_effort)[[2]]))

# Step 5: Combine old and new arrays
scenario2<-effort_new2
scenario2comb <- abind::abind(effort_base, effort_new2, along = 1)

```

NOW - lets decrease the catchability for salmon \# scenario 1

```{r}
#new_model_spinup

# Step 1: Get dimensions from combined_effort
years_all <- rownames(scenario1)        # "100 years
sectors <- colnames(scenario1)          # fleets/sectors

# Step 2: Create a baseline matrix of 1s
scenario2b <- scenario1

# Step 3: Create named vector of reduction multipliers
reducedcatchS <- c(
  Invertebrates_PS = 1.2,
  Pacific_Herring_PS = 1.2,
  Small_Planktivorous_Fish_PS = 1.2,
  Chinook_Hatch_Adult_PS = 0.5,
  Chinook_Wild_Adult_PS = 0.5,
  Coho_Hatch_Adult_PS = 0.5,
  Coho_Wild_Adult_PS = 0.5,
  Chum_Adult_PS = 0.5,
  Sockeye_Adult_PS = 0.5,
  Chinook_Hatch_Resident_PS = 0.5,
  Chinook_Wild_Resident_PS = 0.5,
  Coho_Hatch_Resident_PS = 0.5,
  Coho_Wild_Resident_PS = 0.5,
  Hake_PS = 1.2,
  Lingcod_PS = 1.2,
  Rockfish_PS = 1.2,
  Other_fish_PS = 1.2,
  Halibut_PS = 1.2,
  SOG_bottom_trawl = 1.2,
  SOG_hook_and_line = 1.2,
  SOG_midwater_trawl = 1.2,
  SOG_herring = 1.2,
  SOG_commercial = 1.2,
  SOG_recreational = 1.2,
  SOG_salmon = 0.5,
  SOG_recreational_salmon = 0.5,
  Seal_mort = 0,
  Pinniped_bycatch = 0,
  Cetacean_bycatch = 0,
  Incidental = 0,
  Other_fish = 1.2
)

# Step 4: Apply reductions from 2012 to 2112
years_to_modify <- as.character(2011:2111)

for (col in sectors) {
  if (col %in% names(reducedcatchS)) {
    scenario2b[years_to_modify, col] <- reducedcatchS[col]
  } else {
    warning(paste("No reduction specified for:", col, "- using 1"))
    scenario2b[years_to_modify, col] <- 1
  }
}


```

#scenario 2 - something wrong with this one

```{r}
library(ggplot2)
library(dplyr)

scenario2c <- scenario1
targetF <- 0.05
select_gear <- "SOG_salmon"

# Fix 1: Correct indexing for the sequence
# Assuming scenario2c has at least 39 rows and select_gear is a column name
scenario2c[1:10, select_gear] <- seq(from = scenario2c[1, select_gear], to = targetF, length.out = 10)

# Then hold at target from year 11 to 39
scenario2c[11:39, select_gear] <- targetF

# Fix 2: Plotting with ggplot
# Create a data frame with years and effort for the selected gear
scenario_df <- data.frame(
  year = 2011:(2011 + nrow(scenario2c) - 1),
  effort = scenario2c[, select_gear]
)

# Plot with ggplot
p1 <- ggplot(scenario_df, aes(x = year, y = effort)) +
  geom_line(size = 1, color = "blue") +
  geom_point(size = 2, color = "blue", alpha = 0.7) +
  labs(x = "Year", y = "Fishing Effort", 
       title = paste("Fishing Effort Scenario for", select_gear)) +
  theme_classic()

print(p1)

# Alternative Method B: Base R plot
plot(scenario_df$year, scenario_df$effort, 
     type = "b", 
     xlab = "Year", 
     ylab = "Fishing Effort",
     main = paste("Fishing Effort Scenario for", select_gear),
     col = "blue", 
     pch = 16)

# Method C: Plot multiple gears if more than one column
if (ncol(scenario2c) > 1) {
  scenario_long <- data.frame(
    year = rep(scenario_df$year, ncol(scenario2c)),
    gear = rep(colnames(scenario2c), each = nrow(scenario2c)),
    effort = as.vector(as.matrix(scenario2c))
  )
  
  p2 <- ggplot(scenario_long, aes(x = year, y = effort, color = gear)) +
    geom_line(size = 1) +
    geom_point(size = 2, alpha = 0.7) +
    labs(x = "Year", y = "Fishing Effort", 
         title = "Fishing Effort Scenarios by Gear") +
    theme_classic() +
    theme(legend.position = "bottom")
  
  print(p2)
}

# Method D: Highlight selected gear
if (ncol(scenario2c) > 1) {
  scenario_long <- data.frame(
    year = rep(scenario_df$year, ncol(scenario2c)),
    gear = rep(colnames(scenario2c), each = nrow(scenario2c)),
    effort = as.vector(as.matrix(scenario2c))
  )
  
  scenario_long <- scenario_long %>%
    mutate(is_selected = (gear == select_gear))
  
  p3 <- ggplot(scenario_long, aes(x = year, y = effort)) +
    geom_line(aes(color = is_selected, group = gear), 
              size = ifelse(scenario_long$is_selected, 1.5, 0.8),
              alpha = ifelse(scenario_long$is_selected, 1, 0.5)) +
    scale_color_manual(values = c("TRUE" = "red", "FALSE" = "grey")) +
    labs(x = "Year", y = "Fishing Effort", 
         title = paste("Fishing Effort - Highlighting", select_gear)) +
    theme_classic() +
    theme(legend.position = "none")
  
  print(p3)
}

# Verification outputs
cat("First 5 years of", select_gear, "effort:\n")
print(scenario2c[1:5, select_gear])

cat("\nLast 5 years of", select_gear, "effort:\n")
print(scenario2c[35:39, select_gear])

cat("\nTarget effort:", targetF, "\n")
cat("Final effort:", scenario2c[39, select_gear], "\n")

```


#scenario 2D - INCREASE CATCH OF SALMON

```{r}
#new_model_histS<-new_model_hist

# Step 1: Get dimensions from combined_effort
years_all <- rownames(scenario1)        # lets do it from 2011
sectors <- colnames(scenario1)          # fleets/sectors

# Step 2: Create a baseline matrix of 1s
scenario2d <- scenario1

# Step 3: Create named vector of reduction multipliers
reducedcatchS <- c(
  Invertebrates_PS = 1.01,
  Pacific_Herring_PS = 1.01,
  Small_Planktivorous_Fish_PS = 1.01,
  Chinook_Hatch_Adult_PS = 2,
  Chinook_Wild_Adult_PS = 2,
  Coho_Hatch_Adult_PS = 2,
  Coho_Wild_Adult_PS = 2,
  Chum_Adult_PS = 2,
  Sockeye_Adult_PS = 2,
  Chinook_Hatch_Resident_PS = 2,
  Chinook_Wild_Resident_PS = 2,
  Coho_Hatch_Resident_PS = 2,
  Coho_Wild_Resident_PS = 2,
  Hake_PS = 1.01,
  Lingcod_PS = 1.01,
  Rockfish_PS = 1.01,
  Other_fish_PS = 1.01,
  Halibut_PS = 1.01,
  SOG_bottom_trawl = 1.01,
  SOG_hook_and_line = 1.01,
  SOG_midwater_trawl = 1.01,
  SOG_herring = 1.01,
  SOG_commercial = 1.01,
  SOG_recreational = 1.01,
  SOG_salmon = 2,
  SOG_recreational_salmon = 2,
  Seal_mort = 0.1,
  Pinniped_bycatch = 0,
  Cetacean_bycatch = 0,
  Incidental = 0,
  Other_fish = 1.01
)

# Step 4: Apply reductions to 100 years
years_to_modify <- as.character(2011:2111)

for (col in sectors) {
  if (col %in% names(reducedcatchS)) {
    scenario2d[years_to_modify, col] <- reducedcatchS[col]
  } else {
    warning(paste("No reduction specified for:", col, "- using 1"))
    scenario2d[years_to_modify, col] <- 1
  }
}

```

#simulations - old
```{r}
sim1 <- project(new_model_spinup, effort = scenario1, dt = 0.25)
sim2 <- project(new_model_spinup, effort = scenario2, dt = 0.25) ##increase effort across the board
sim2b <- project(new_model_spinup, effort = scenario2b, dt = 0.25) ##ddecrease salmon effort
sim2c <- project(new_model_spinup, effort = scenario2c, dt = 0.25) ##change salmon SOG gear catch
sim2d <- project(new_model_spinup, effort = scenario2d, dt = 0.25) ##change salmon SOG gear catch


```


# Use different model - not spinup model
```{r}
sim1 <- project(new_model_hist1, effort = scenario1, dt = 0.25)
sim2 <- project(new_model_hist1, effort = scenario2, dt = 0.25) ##increase effort across the board
sim2b <- project(new_model_hist1, effort = scenario2b, dt = 0.25) ##ddecrease salmon effort
sim2c <- project(new_model_hist1, effort = scenario2c, dt = 0.25) ##change salmon SOG gear catch
sim2d <- project(new_model_hist1, effort = scenario2d, dt = 0.25) ##change salmon SOG gear catch


```



We can now compare the projected SSB values in both scenarios to the
biodiversity reference points. First we calculate the biodiversity
reference points (from the final time step in the unexploited sim0
simulation): #ssb0

```{r}
ssb0 <- getSSB(sim0)[final, ]

```

Now we build a data.frame of the projected SSB for each species. We make
use of the melt() function to transform arrays into data frames. \##
plot the historical trajectories

```{r}
years <- 2011:2111
ssb1_df <- melt(getSSB(sim1))
ssb2_df <- melt(getSSB(sim2))
ssb_df <- rbind(
    #transform(ssb1_df, scenario = "Unexploited"),
    transform(ssb2_df, scenario = "Historical fishing effort"))
ssb_unexploited_df <- cbind(expand.grid(
    sp = sim_species,  # Use simulation species names
  #sp = names(ssb0),
    time = 1986:2050),
   # value = as.numeric(ssb0),
    value = as.numeric(ssb0),
    scenario = "Unexploited")
ssb_reference_df <- cbind(expand.grid(
  sp = sim_species,  # Use simulation species names
   # sp = names(ssb0),
    time = 1986:2050),
    value = as.numeric(ssb0 * 0.5),
    scenario = "Reference")
#ssb_all_df <- rbind(ssb_df, ssb_unexploited_df, ssb_reference_df)
ssb_all_df <- rbind(ssb_df)#, ssb_unexploited_df)
colours <- c("Unexploited" = "orange", 
             "Historical fishing effort" = "blue"#,
            # "Unexploited" = "blue"#, 
            # "Reference" = "purple"
             )
ggplot(ssb_all_df) +
    geom_line(aes(x = time, y = value, colour = scenario)) +
    facet_wrap(~sp, scales = "free", nrow = 5) +
    theme(legend.position = "none") +
    scale_colour_manual(values = colours)

ggplot(ssb_df) +
    geom_line(aes(x = time, y = value, colour = scenario)) +
    facet_wrap(~sp, scales = "free", nrow = 5) +
    theme(legend.position = "none") +
    scale_colour_manual(values = colours)

```

Historical and projected SSB under two fishing scenarios. Status quo
(red), Fmsy (yellow). Unexploited (blue) and reference levels (purple)
are also shown.

######### USING CM CONST INSTEAD OF MANUALLY TUNED - WORKS BETTER

```{r}
ssb0c <- getSSB(sim0c)[final, ]

```

```{r}
years <- 1986:2050
ssb1_dfc <- melt(getSSB(sim0c))
ssb2_dfc <- melt(getSSB(sim_histc))
ssb_dfc <- rbind(
    #transform(ssb1_dfc, scenario = "Unexploited"),
    transform(ssb2_dfc, scenario = "Historical fishing effort"))
ssb_unexploited_dfc <- cbind(expand.grid(
    sp = sim_species,  # Use simulation species names
  #sp = names(ssb0),
    time = 1986:2050),
   # value = as.numeric(ssb0),
    value = as.numeric(ssb0c),
    scenario = "Unexploited")
ssb_reference_dfc <- cbind(expand.grid(
  sp = sim_species,  # Use simulation species names
   # sp = names(ssb0),
    time = 1986:2050),
    value = as.numeric(ssb0c * 0.5),
    scenario = "Reference")
#ssb_all_dfc <- rbind(ssb_dfc, ssb_unexploited_dfc, ssb_reference_dfc)
ssb_all_dfc <- rbind(ssb_dfc)#, ssb_unexploited_dfc)
colours <- c("Unexploited" = "orange", 
             "Historical fishing effort" = "blue"#,
            # "Unexploited" = "blue"#, 
            # "Reference" = "purple"
             )
ggplot(ssb_dfc) +
    geom_line(aes(x = time, y = value, colour = scenario)) +
    facet_wrap(~sp, scales = "free", nrow = 5) +
    theme(legend.position = "none") +
    scale_colour_manual(values = colours)

```

###### 2 June plotting adfd biomass to marine mamma;ls

```{r}
N0c <- getN(sim0c)[final, ]

```

##getN and plot

```{r}
years <- 1986:2050
ssb1_dfc <- melt(getN(sim0c))
ssb2_dfc <- melt(getN(sim_histspin))
ssb_dfc <- rbind(
    #transform(ssb1_dfc, scenario = "Unexploited"),
    transform(ssb2_dfc, scenario = "Historical fishing effort"))
ssb_unexploited_dfc <- cbind(expand.grid(
    sp = sim_species,  # Use simulation species names
  #sp = names(ssb0),
    time = 1986:2050),
   # value = as.numeric(ssb0),
    value = as.numeric(ssb0c),
    scenario = "Unexploited")
ssb_reference_dfc <- cbind(expand.grid(
  sp = sim_species,  # Use simulation species names
   # sp = names(ssb0),
    time = 1986:2050),
    value = as.numeric(ssb0c * 0.5),
    scenario = "Reference")
#ssb_all_dfc <- rbind(ssb_dfc, ssb_unexploited_dfc, ssb_reference_dfc)
ssb_all_dfc <- rbind(ssb_dfc)#, ssb_unexploited_dfc)
colours <- c("Unexploited" = "orange", 
             "Historical fishing effort" = "blue"#,
            # "Unexploited" = "blue"#, 
            # "Reference" = "purple"
             )
ggplot(ssb_dfc) +
    geom_line(aes(x = time, y = value, colour = scenario)) +
    facet_wrap(~sp, scales = "free", nrow = 5) +
    theme(legend.position = "none") +
    scale_colour_manual(values = colours)

```

### 2 June PLOTTING - points

```{r}
#sim_histc = sim_hist
### FISHING=0

 
write.csv(getBiomass(sim_histc), "C:/Users/MCSHANEV/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250813/sim_fishing_histc_biomass2.csv") ##fishing=0

write.csv(getN(sim_histc), "C:/Users/MCSHANEV/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250813/sim_fishing_histc_N2.csv") ##fishing=0

#PROP LARGE FISH
write.csv(getProportionOfLargeFish(sim_histc), "C:/Users/MCSHANEV/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250813/sim_fishing_histc_proplrgfish2.csv") ##fishing=0

#SPAWNING STOCK BIOMASS
write.csv(getSSB(sim_histc), "C:/Users/MCSHANEV/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250813/sim_fishing_histc_SSB2.csv") ##

##predation mortality
write.csv(getM2(sim_histc), "C:/Users/MCSHANEV/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250813/sim_fishing_histc_predmort2.csv") 

## yield
write.csv(getYield(sim_histc), "C:/Users/MCSHANEV/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250813/sim_fishing_histc_yield2.csv")

```

##### PLOT MARINE MAMMALS RELATIVE CHANGE WITH BIOMASS

```{r}
library(ggplot2)
library(readr)
library(dplyr)

# Load and prepare the data
### add catches
dat<-read.csv("C:/Users/MCSHANEV/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250527/sim_histfish_yieldsalmon_wcatches.csv")



dat <- dat %>%
  mutate(
    Year = as.numeric(Year),
    Yield = as.numeric(Yield) / 1000000 ,  # Convert grams to tonnes (1 tonne = 1,000,000 grams),
    Catch = as.numeric(Catch) / 1000000   # Convert grams to tonnes (1 tonne = 1,000,000 grams)
  )

# Define selected gears#
#selected_gears <- c(
#  "Chinook_Hatch_Adult_PS", "Chinook_Wild_Adult_PS",
#  "Chinook_Hatch_Resident_PS", "Chinook_Wild_Resident_PS",
#  "Coho_Hatch_Adult_PS", "Coho_Wild_Adult_PS",
#  "Coho_Hatch_Resident_PS", "Coho_Wild_Resident_PS"
#)

# Filter the data
dat_filtered <- dat %>%
  filter(New_Gear %in% selected_gears)

# Plot (correctly terminated)
plotPS<- ggplot(dat, aes(x = Year)) +
  geom_line(aes(y = Yield), color = "darkgreen") +
  geom_point(aes(y = Catch), color = "blue", size = 2) +
  facet_wrap(~New_Gear, scales = "free_y", ncol = 2) +
  labs(
    title = "Yield and Catch Over Time (Selected Gears)",
    y = "Total yield/catch (tonnes)",
    x = "Year"
  ) +
  theme_minimal()
plotPS
```

###### Fishing through time: projecting into the future

Now let’s see what happens if we change fishing in the future. To do
this we set up two scenarios, one where the model starts with the last
time step of the fished scenario and continues into the future (the
“status quo”). The other will be designed to explore a “more
sustainable” scenario.


#####FUTURE SIMULATIONS

### STATUS QUO

```{r}
# Create a high productivity scenario
params_quo<- new_model_spinup
#params_quo <- tuned_model3

# Run projection
sim_quo<- project(params_quo, effort=1.01, t_save=0.25)
```

### INCREASE PRODUCTIVITY OF CHINOOK SALMON By 50%

```{r}
# Create a high productivity scenario
params_high_prod <- new_model_spinup
#params_high_prod <- tuned_model3

# Combine multiple improvements
species_params(params_high_prod)$erepro[4] <- species_params(params_high_prod)$erepro[4] *1.03
#species_params(params_high_prod)$z0[19] <- species_params(params_high_prod)$z0[19] *0.99
species_params(params_high_prod)$z0[4:5] <- species_params(params_high_prod)$z0[4:5] * 0.5
species_params(params_high_prod)$z0[10:11] <- species_params(params_high_prod)$z0[10:11] * 0.5
#resource_params(params_high_prod)$kappa <- 114602882651 * 1.1
# Get current resource capacity
current_capacity <- resource_capacity(params_high_prod)
params_high_prod <- setResource(params_high_prod, 
                    resource_capacity = current_capacity * 1.2)

# Recalculate parameters
params_high_prod <- setParams(params_high_prod)

# Run projection
sim_high_prod <- project(params_high_prod, effort=1.01, t_save=0.25)
```

### DECREASE PRODUCTIVITY OF CHINOOK SALMON by 50%

```{r}
# Create a high productivity scenario
params_low_prod <- new_model_spinup


# Combine multiple improvements
#species_params(params_high_prod)$erepro[4] <- species_params(params_high_prod)$erepro[4] *1.03
#species_params(params_high_prod)$z0[19] <- species_params(params_high_prod)$z0[19] *0.99
species_params(params_low_prod)$z0[4:5] <- species_params(params_low_prod)$z0[4:5] * 1.5
species_params(params_low_prod)$z0[10:11] <- species_params(params_low_prod)$z0[10:11] * 1.5
#resource_params(params_high_prod)$kappa <- 114602882651 * 1.1
# Get current resource capacity
#current_capacity <- resource_capacity(params_low_prod)
#params_low_prod <- setResource(params_low_prod, 
#                    resource_capacity = current_capacity * 1.2)

# Recalculate parameters
params_low_prod <- setParams(params_low_prod)

# Run projection
sim_low_prod <- project(params_low_prod, effort=1.01, t_save=0.25)
```

### DECREAESE PROD OF SEALS AND SEA LIONS by 10%

```{r}
# Create a high productivity scenario
params_pinn <- new_model_spinup
#params_high_prod <- tuned_model3

# Combine multiple improvements
#species_params(params_pinn)$erepro[19:21] <- species_params(params_pinn)$erepro[19:21] *0.99
species_params(params_pinn)$z0[19:21] <- species_params(params_pinn)$z0[19:21] *1.1

#species_params(params_pinn)$z0[4:5] <- species_params(params_pinn)$z0[4:5] * 1.1

#resource_params(params_high_prod)$kappa <- 114602882651 * 1.1
# Get current resource capacity
current_capacity <- resource_capacity(params_pinn)
params_pinn <- setResource(params_pinn, 
                    resource_capacity = current_capacity * 1.2)

# Recalculate parameters
params_pinn <- setParams(params_pinn)

# Run projection
sim_pinn <- project(params_pinn, effort=1.01, t_save=0.25)
```

```{r}
#years <- 1986:2050
ssb1f_df <- melt(getSSB(sim_quo))
ssb2f_df <- melt(getSSB(sim_high_prod))
ssb3f_df <- melt(getSSB(sim_low_prod))
ssb4f_df <- melt(getSSB(sim_pinn))
ssb_df <- rbind(
    transform(ssb1f_df, scenario = "Status quo"),
    transform(ssb2f_df, scenario = "Increase salmon productivity"),
  transform(ssb3f_df, scenario = "Decrease salmon productivity"),
  transform(ssb4f_df, scenario = "Decrease pinniped productivity"))
colours <- c("Status quo" = "orange", "Increase salmon productivity" = "blue"#,
            # "Unexploited" = "blue"#, 
            # "Reference" = "purple"
             )
ggplot(ssb_df) +
    geom_line(aes(x = time, y = value, colour = scenario)) +
    facet_wrap(~sp, scales = "free", nrow = 4) +
    theme(legend.position = "none") +
    scale_colour_manual(values = colours)

# Plot only specific species (e.g., Cod and Haddock)
target_species <- c("Chinook_Hatch_Adult","Chinook_Wild_Adult", "Coho_Hatch_Adult","Coho_Wild_Adult","Chinook_Hatch_Resident","Chinook_Wild_Resident", "Coho_Hatch_Resident","Coho_Wild_Resident",  "Harbor_seals", "Steller_sealions", "California_sealions", "Harbor_porpoise",  "Resident_Orca_S",  "Resident_Orca_N",   "Transient_Orca"  )



ggplot(ssb_df[ssb_df$sp %in% target_species, ]) +
    geom_line(aes(x = time, y = value, colour = scenario)) +
    facet_wrap(~sp, scales = "free", nrow = 2) +
    theme(legend.position = "none") +
    scale_colour_manual(values = colours)



```

### perfect - SRKW increase when we increase chinook stocks

```{r}
# Calculate relative values (as proportion of starting year)
ssb_relative <- ssb_df
ssb_relative$value <- with(ssb_relative, {
    ave(value, sp, scenario, FUN = function(x) x / x[1])
})

# Plot with y-axis starting at 0
ggplot(ssb_relative) +
    geom_line(aes(x = time, y = value, colour = scenario)) +
    facet_wrap(~sp, scales = "free_x", nrow = 4) +  # Only free x-axis
    #scale_y_continuous(limits = c(0, NA)) +  # Force y-axis to start at 0
    theme(legend.position = "none") +
    scale_colour_manual(values = colours) +
    labs(y = "Relative biomass (proportion of starting year)")


ggplot(ssb_relative[ssb_relative$sp %in% target_species, ]) +
    geom_line(aes(x = time, y = value, colour = scenario)) +
    facet_wrap(~sp, scales = "free", nrow = 3) +
    theme(legend.position = "none") +
    scale_colour_manual(values = colours)


```

### try playing with variability - set seed and create a future set of scenarios with variability
```{r}
library(dplyr)
library(ggplot2)
library(reshape2)

# Read the gear parameters data
gear_data <- gear_params

# Display the structure to understand the data
head(gear_data)
str(gear_data)

# Get unique gears
unique_gears <- unique(gear_data$gear)
cat("Available gears:\n")
print(unique_gears)

# Extract catchability values by gear (this represents effort/fishing pressure)
effort_by_gear <- gear_data %>%
  group_by(gear) %>%
  summarise(
    mean_catchability = mean(catchability, na.rm = TRUE),
    median_catchability = median(catchability, na.rm = TRUE),
    sd_catchability = sd(catchability, na.rm = TRUE),
    min_catchability = min(catchability, na.rm = TRUE),
    max_catchability = max(catchability, na.rm = TRUE),
    n_species = n(),
    .groups = 'drop'
  ) %>%
  # Remove gears with zero catchability (these are likely non-fishing gears)
  filter(mean_catchability > 0)

print("Current effort levels by gear:")
print(effort_by_gear)

# Create future effort scenario
create_future_effort <- function(base_data, n_years = 39, start_year = 2011) {
  
  # Get gears with positive catchability
  fishing_gears <- base_data %>%
    filter(mean_catchability > 0) %>%
    pull(gear)
  
  # Create time series for each gear
  years <- start_year:(start_year + n_years - 1)
  future_effort <- data.frame(year = years)
  
  # For each fishing gear, create a time series with variability
  for(gear in fishing_gears) {
    
    gear_stats <- base_data[base_data$gear == gear, ]
    base_mean <- gear_stats$mean_catchability
    base_sd <- gear_stats$sd_catchability
    
    # If no variability in the data, create some based on the mean
    if(is.na(base_sd) || base_sd == 0) {
      base_sd <- base_mean * 0.15  # 15% coefficient of variation
    }
    
    # Generate time series with some temporal correlation
    # Use AR(1) process for realistic temporal patterns
    set.seed(123 + match(gear, fishing_gears))  # Reproducible but different for each gear
    
    # Generate correlated random walk
    innovations <- rnorm(n_years, mean = 0, sd = base_sd * 0.5)
    effort_series <- numeric(n_years)
    effort_series[1] <- base_mean + rnorm(1, 0, base_sd * 0.3)
    
    # AR(1) with phi = 0.7 (moderate temporal correlation)
    for(t in 2:n_years) {
      effort_series[t] <- base_mean * 0.3 + effort_series[t-1] * 0.7 + innovations[t]
    }
    
    # Ensure values stay positive and within reasonable bounds
    effort_series <- pmax(effort_series, base_mean * 0.2)  # Minimum 20% of base
    effort_series <- pmin(effort_series, base_mean * 2.0)  # Maximum 200% of base
    
    # Add to dataframe
    future_effort[[gear]] <- effort_series
  }
  
  return(future_effort)
}

# Generate future effort scenario for 100 years (2012-2112)
future_effort_df <- create_future_effort(effort_by_gear, n_years = 101, start_year = 2011)

# Display first few rows
cat("\nFuture effort dataframe (first 10 years):\n")
print(head(future_effort_df, 10))

# Create summary statistics
cat("\nSummary of future effort scenarios:\n")
effort_summary <- future_effort_df %>%
  select(-year) %>%
  summarise_all(list(mean = mean, sd = sd, min = min, max = max)) %>%
  pivot_longer(everything(), names_to = c("gear", "stat"), names_sep = "_(?=[^_]*$)") %>%
  pivot_wider(names_from = stat, values_from = value)

print(effort_summary)

# Create visualization
# Convert to long format for plotting
effort_long <- future_effort_df %>%
  pivot_longer(-year, names_to = "gear", values_to = "effort")

# Plot time series for all gears
p1 <- ggplot(effort_long, aes(x = year, y = effort, color = gear)) +
  geom_line(size = 0.8, alpha = 0.8) +
  facet_wrap(~gear, scales = "free_y", ncol = 3) +
  labs(x = "Year", y = "Fishing Effort (Catchability)", 
       title = "Future Fishing Effort Scenarios (2012-2112)",
       subtitle = "100-year projection based on 2011 baseline with realistic variability") +
  theme_classic() +
  theme(legend.position = "none",
        strip.text = element_text(size = 8),
        axis.text.x = element_text(angle = 45, hjust = 1))

print(p1)

# Create a version focusing on key fisheries
key_fisheries <- c("SOG_salmon", "SOG_commercial", "SOG_recreational", 
                   "Pacific_Herring_PS", "SOG_herring")

if(any(key_fisheries %in% colnames(future_effort_df))) {
  key_gears_present <- key_fisheries[key_fisheries %in% colnames(future_effort_df)]
  
  effort_key <- effort_long %>%
    filter(gear %in% key_gears_present)
  
  p2 <- ggplot(effort_key, aes(x = year, y = effort, color = gear)) +
    geom_line(size = 1.2) +
    geom_point(size = 1.5, alpha = 0.7) +
    labs(x = "Year", y = "Fishing Effort (Catchability)", 
         title = "Key Fisheries Effort Scenarios",
         color = "Fishery") +
    theme_classic() +
    theme(legend.position = "bottom")
  
  print(p2)
}

# Alternative approach: Use actual effort data if you have historical time series
create_future_effort_with_trend <- function(base_data, n_years = 39, start_year = 2011, 
                                           trend_factor = 0.98) {
  # This version includes a slight declining trend (2% per year by default)
  
  fishing_gears <- base_data %>%
    filter(mean_catchability > 0) %>%
    pull(gear)
  
  years <- start_year:(start_year + n_years - 1)
  future_effort <- data.frame(year = years)
  
  for(gear in fishing_gears) {
    gear_stats <- base_data[base_data$gear == gear, ]
    base_mean <- gear_stats$mean_catchability
    base_sd <- gear_stats$sd_catchability
    
    if(is.na(base_sd) || base_sd == 0) {
      base_sd <- base_mean * 0.15
    }
    
    # Generate declining trend with variability
    set.seed(456 + match(gear, fishing_gears))
    
    # Declining trend
    trend_multipliers <- trend_factor^(0:(n_years-1))
    base_series <- base_mean * trend_multipliers
    
    # Add variability around the trend
    noise <- rnorm(n_years, 0, base_sd * 0.3)
    effort_series <- base_series + noise
    
    # Keep positive
    effort_series <- pmax(effort_series, base_mean * 0.1)
    
    future_effort[[gear]] <- effort_series
  }
  
  return(future_effort)
}

# Create version with declining trend for 100 years
future_effort_declining <- create_future_effort_with_trend(effort_by_gear, 
                                                          n_years = 101,
                                                          start_year = 2011,
                                                          trend_factor = 0.992)  # 0.8% annual decline for long-term sustainability

cat("\nAlternative scenario with declining trend (first 10 years):\n")
print(head(future_effort_declining, 10))

# Save both scenarios
write.csv(future_effort_df, "future_effort_stable.csv", row.names = FALSE)
write.csv(future_effort_declining, "future_effort_declining.csv", row.names = FALSE)

cat("\nFiles saved:")
cat("\n- future_effort_stable.csv (stable effort with variability, 101 years)")
cat("\n- future_effort_declining.csv (declining trend scenario, 101 years)\n")

# Compare scenarios for a key fishery
if("SOG_salmon" %in% colnames(future_effort_df)) {
  comparison_salmon <- data.frame(
    year = future_effort_df$year,
    stable = future_effort_df$SOG_salmon,
    declining = future_effort_declining$SOG_salmon
  ) %>%
    pivot_longer(-year, names_to = "scenario", values_to = "effort")
  
  p3 <- ggplot(comparison_salmon, aes(x = year, y = effort, color = scenario)) +
    geom_line(size = 1.2) +
    geom_point(size = 1.5, alpha = 0.7) +
    labs(x = "Year", y = "Fishing Effort", 
         title = "SOG Salmon Fishery: Scenario Comparison",
         color = "Scenario") +
    theme_classic()
  
  print(p3)
}

# Function to create custom scenarios
create_custom_scenario <- function(gear_name, base_effort, years, 
                                  change_points = NULL, 
                                  change_factors = NULL,
                                  variability = 0.15) {
  # Create custom scenarios for specific gears
  n_years <- length(years)
  effort_series <- rep(base_effort, n_years)
  
  # Apply change points if specified
  if(!is.null(change_points) && !is.null(change_factors)) {
    for(i in seq_along(change_points)) {
      year_idx <- which(years >= change_points[i])
      if(length(year_idx) > 0) {
        effort_series[year_idx] <- effort_series[year_idx] * change_factors[i]
      }
    }
  }
  
  # Add variability
  set.seed(789)
  noise <- rnorm(n_years, 0, base_effort * variability)
  effort_series <- effort_series + noise
  effort_series <- pmax(effort_series, base_effort * 0.1)
  
  return(data.frame(year = years, effort = effort_series))
}

# Example custom scenario: Salmon fishery with management changes over 100 years
if("SOG_salmon" %in% colnames(future_effort_df)) {
  salmon_base <- effort_by_gear$mean_catchability[effort_by_gear$gear == "SOG_salmon"]
  
  custom_salmon <- create_custom_scenario(
    gear_name = "SOG_salmon",
    base_effort = salmon_base,
    years = 2011:2111,
    change_points = c(2025, 2050, 2075),  # Management changes every 25 years
    change_factors = c(0.9, 0.7, 0.5),    # Progressive reductions: 10%, 30%, 50%
    variability = 0.12
  )
  
  cat("\nCustom salmon scenario (first 10 years):\n")
  print(head(custom_salmon, 10))
  
  cat("\nCustom salmon scenario (last 10 years):\n")
  print(tail(custom_salmon, 10))
}
```


## Four Specific Scenarios:

1. Trend Continuation (future_effort_trend_continuation.csv)
-Uses last 10 years of historical trends and continues them into the future
-Maintains realistic year-to-year variability

2. General Decline (future_effort_declining.csv)
-Same as trend continuation but with additional 1% annual decline across all gears
-Represents general fishing pressure reduction

3. Salmon Half (future_effort_salmon_half.csv)
-Reduces salmon fishing effort by 50% compared to trend continuation
-All other gears follow normal trends
-Represents salmon conservation scenario

4. Salmon Double (future_effort_salmon_double.csv)
-Doubles salmon fishing effort compared to trend continuation
-All other gears follow normal trends
-Represents intensive salmon fishing scenario

```{r}
# Load required packages
library(dplyr)
library(tidyr)
library(ggplot2)

# Read historical effort data from CSV
# Make sure your CSV has columns: year, gear1, gear2, ...
historical_data <- new_rel_effort

# If your historical dataset has more years than needed, filter last 10
# 1. Force it into a data frame
historical_data <- as.data.frame(historical_data)

# 2. If years are rownames, move them into a column
if (!"year" %in% names(historical_data)) {
  historical_data <- tibble::rownames_to_column(historical_data, var = "year")
}

# 3. Make sure 'year' is numeric
historical_data$year <- as.numeric(historical_data$year)

# 4. Filter last 10 years
historical_data <- historical_data %>%
  dplyr::filter(year >= max(year) - 9)


# Calculate trends from historical data
calculate_trends <- function(historical_data) {
  trends <- data.frame(gear = character(), annual_trend = numeric())
  for (gear in names(historical_data)[-1]) {
    years <- historical_data$year
    effort_values <- historical_data[[gear]]
    model <- lm(effort_values ~ years)
    slope <- coef(model)[2]
    trends <- rbind(trends, data.frame(gear = gear, annual_trend = slope))
  }
  trends
}

gear_trends <- calculate_trends(historical_data)

# Baseline from last historical year
baseline_year <- max(historical_data$year)
baseline_effort <- historical_data %>%
  filter(year == baseline_year) %>%
  pivot_longer(-year, names_to = "gear", values_to = "baseline_effort") %>%
  select(-year)

# Create scenarios (keeping year column!)
create_future_scenarios <- function(baseline_data, trends_data, n_years = 100, start_year = baseline_year) {
  years <- start_year:(start_year + n_years - 1)
  scenario_params <- merge(baseline_data, trends_data, by = "gear")

  # Create empty dfs with year column intact
  scenario1_trend       <- data.frame(year = years)
  scenario2_decline     <- data.frame(year = years)
  scenario3_salmon_half <- data.frame(year = years)
  scenario4_salmon_double <- data.frame(year = years)
    scenario5_increase     <- data.frame(year = years)

  for (i in 1:nrow(scenario_params)) {
    gear <- scenario_params$gear[i]
    base_effort <- scenario_params$baseline_effort[i]
    annual_trend <- scenario_params$annual_trend[i]
    noise <- rnorm(n_years, 0, base_effort * 0.08)

    years_from_start <- 1:n_years

    # Scenario 1
    trend_effort <- base_effort + (annual_trend * years_from_start)
    scenario1_trend[[gear]] <- pmax(trend_effort + noise, base_effort * 0.2)

    # Scenario 2
    decline_rate <- annual_trend - (base_effort * 0.01)
    decline_effort <- base_effort + (decline_rate * years_from_start)
    scenario2_decline[[gear]] <- pmax(decline_effort + noise, base_effort * 0.1)

    # Scenario 3
    if (grepl("salmon", gear, ignore.case = TRUE)) {
      salmon_half <- (base_effort * 0.5) + (annual_trend * 0.5 * years_from_start)
      scenario3_salmon_half[[gear]] <- pmax(salmon_half + noise * 0.5, base_effort * 0.1)
    } else {
      scenario3_salmon_half[[gear]] <- scenario1_trend[[gear]]
    }

    # Scenario 4
    if (grepl("salmon", gear, ignore.case = TRUE)) {
      salmon_double <- (base_effort * 2.0) + (annual_trend * 2.0 * years_from_start)
      scenario4_salmon_double[[gear]] <- pmax(salmon_double + noise * 2.0, base_effort * 0.2)
    } else {
      scenario4_salmon_double[[gear]] <- scenario1_trend[[gear]]
    }
    
       # Scenario 5
    increase_rate <- annual_trend - (base_effort * 1.05)
    increase_effort <- base_effort + (increase_rate * years_from_start)
    scenario5_increase[[gear]] <- pmax(increase_effort + noise, base_effort * 0.1)
  }

  list(
    scenario1_trend       = scenario1_trend,
    scenario2_decline     = scenario2_decline,
    scenario3_salmon_half = scenario3_salmon_half,
    scenario4_salmon_double = scenario4_salmon_double,
    scenario5_increase     = scenario5_increase
  )
}

# Generate scenarios
scenarios <- create_future_scenarios(baseline_effort, gear_trends)

# Now this will work without row mismatch error:
salmon_gear_name <- names(scenarios$scenario1_trend)[grepl("salmon", names(scenarios$scenario1_trend), ignore.case = TRUE)][1]
comparison_data <- data.frame(
  year              = scenarios$scenario1_trend$year,
  trend_continuation = scenarios$scenario1_trend[[salmon_gear_name]],
  decline            = scenarios$scenario2_decline[[salmon_gear_name]],
  salmon_half        = scenarios$scenario3_salmon_half[[salmon_gear_name]],
  salmon_double      = scenarios$scenario4_salmon_double[[salmon_gear_name]],
    increase            = scenarios$scenario5_increase[[salmon_gear_name]]
)


```


### CREATE EFFORT MATRICES PROPEERLY

```{r}
# Get model gears
model_gears <- unique(gear_params(params_quo)$gear)

# List of scenario names and their corresponding data
scenario_list <- list(
  "Trend Continuation" = scenarios$scenario1_trend,
  "General Decline"    = scenarios$scenario2_decline,
  "Salmon Half"        = scenarios$scenario3_salmon_half,
  "Salmon Double"      = scenarios$scenario4_salmon_double,
    "General Increase"    = scenarios$scenario5_increase
)

# Run all scenarios
sim_results <- list()

for (scenario_name in names(scenario_list)) {
  
  # Get effort data for the scenario
  effort_matrix <- scenario_list[[scenario_name]][, !duplicated(names(scenario_list[[scenario_name]]))]
  
  # Keep only gears present in model
  effort_matrix <- effort_matrix[, intersect(names(effort_matrix), model_gears), drop = FALSE]
  
  # Reorder columns to match model order
  effort_matrix <- effort_matrix[, model_gears, drop = FALSE]
  
  # Convert to matrix
  effort_matrix <- as.matrix(effort_matrix)
  rownames(effort_matrix) <- seq_len(nrow(effort_matrix))
  
  # Run projection
  sim_results[[scenario_name]] <- project(
    new_model_hist1,
    effort = effort_matrix,
    t_max = 100,
    t_save = 0.25
  )
}

# Access example:
# sim_results[["Trend Continuation"]]
# sim_results[["General Decline"]]
#  sim_results[["Salmon Double"]]
#  sim_results[["Salmon Half"]]
# sim_results[["General Increase"]]


# Define base output directory
output_dir <- "C:/Users/MCSHANEV/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250813/"

# Save outputs for all scenarios
for (scenario_name in names(sim_results)) {
  
  # Create clean filename prefix (remove spaces and special characters)
  file_prefix <- gsub("[^A-Za-z0-9]", "_", scenario_name)
  
  # Save Proportion of Large Fish
  write.csv(getProportionOfLargeFish(sim_results[[scenario_name]]), 
            paste0(output_dir, "sim_var_fishing_hist_proplrgfish_", file_prefix, ".csv"),
            row.names = FALSE)
  
  # Save Spawning Stock Biomass
  write.csv(getSSB(sim_results[[scenario_name]]), 
            paste0(output_dir, "sim_var_fishing_hist_SSB_", file_prefix, ".csv"),
            row.names = FALSE)
  
  # Save Predation Mortality
  write.csv(getM2(sim_results[[scenario_name]]), 
            paste0(output_dir, "sim_var_fishing_hist_predmort_", file_prefix, ".csv"),
            row.names = FALSE)
  
  # Save Yield
  write.csv(getYield(sim_results[[scenario_name]]), 
            paste0(output_dir, "sim_var_fishing_hist_yield_", file_prefix, ".csv"),
            row.names = FALSE)
  
  # Save Abundance (N) - fixed the filename which was duplicating yield
  write.csv(getN(sim_results[[scenario_name]]), 
            paste0(output_dir, "sim_var_fishing_hist_abundance_", file_prefix, ".csv"),
            row.names = FALSE)
  
  # Print progress message
  cat("Saved outputs for scenario:", scenario_name, "\n")
}

```

```{r}
#PROP LARGE FISH
write.csv(getProportionOfLargeFish(sim_histc), "C:/Users/MCSHANEV/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250813/sim_fishing_hist_proplrgfish_Fin.csv") ##fishing=0

#SPAWNING STOCK BIOMASS
write.csv(getSSB(sim_histc), "C:/Users/MCSHANEV/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250813/sim_fishing_hist_SSB_Fin.csv") ##

##predation mortality
write.csv(getM2(sim_histc), "C:/Users/MCSHANEV/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250813/sim_fishing_hist_predmort_Fin.csv") 

## yield
write.csv(getYield(sim_histc), "C:/Users/MCSHANEV/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250813/sim_fishing_hist_yield_Fin.csv")

## yield
write.csv(getN(sim_histc), "C:/Users/MCSHANEV/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250813/sim_fishing_hist_yield_Fin.csv")
```

######################################################### 
#### RUNNING SCENARIOS USING TUNED MODEL

```{r}

#params_quo<- new_model_hist0
#params_quo2 <- new_model_spinup
params_quo2 <- new_model_hist1

# Run projection
sim_quo2<- project(params_quo2, effort=1.01, t_max=100, t_save=0.25)

# Run projection
sim_eff1.5<- project(params_quo2, effort=1.5, t_max=100, t_save=0.25)


# Run projection
sim_0<- project(params_quo2, effort=0, t_max=100, t_save=0.25)

########################################################################
### INCREASE PRODUCTIVITY OF SALMON

# Create a high productivity scenario
#params_high_prod <- new_model_hist0
#params_high_prod2 <- new_model_spinup
params_high_prod2 <- new_model_hist1

# Combine multiple improvements
#species_params(params_high_prod2)$erepro[4:5] <- species_params(params_high_prod2)$erepro[4:5] *1.03
#species_params(params_high_prod2)$erepro[10:11] <- species_params(params_high_prod2)$erepro[10:11] *1.03

#species_params(params_high_prod2)$z0[4:5] <- species_params(params_high_prod2)$z0[4:5] * 0.5
#species_params(params_high_prod2)$z0[10:11] <- species_params(params_high_prod2)$z0[10:11] * 0.5

species_params(params_high_prod2)$z0[4:11] <- species_params(params_high_prod2)$z0[4:11] * 0.5
#resource_params(params_high_prod)$kappa <- 114602882651 * 1.1
# Get current resource capacity
current_capacity <- resource_capacity(params_high_prod2)
params_high_prod2 <- setResource(params_high_prod2, 
                    resource_capacity = current_capacity * 1.2)

# Recalculate parameters
params_high_prod2 <- setParams(params_high_prod2)

# Run projection
sim_high_prod2 <- project(params_high_prod2, effort=1.01, t_max=100,t_save=0.25)


######################################
### DECREASE PRODUCTIVITY OF SALMON

#params_low_prod <- new_model_hist0
#params_low_prod2 <- new_model_spinup
params_low_prod2 <- new_model_hist1

# Combine multiple improvements
#species_params(params_low_prod2)$z0[4:5] <- species_params(params_low_prod2)$z0[4:5] * 2
#species_params(params_low_prod2)$z0[10:11] <- species_params(params_low_prod2)$z0[10:11] * 2
species_params(params_low_prod2)$z0[4:11] <- species_params(params_low_prod2)$z0[4:11] * 2


# Get current resource capacity
current_capacity <- resource_capacity(params_low_prod2)
params_low_prod2 <- setResource(params_low_prod2, 
                    resource_capacity = current_capacity * 1.2)

# Recalculate parameters
params_low_prod2 <- setParams(params_low_prod2)

# Run projection
sim_low_prod2 <- project(params_low_prod2, effort=1.01, t_max=100,t_save=0.25)

#############################################################################
### DECREAESE PROD OF SEALS AND SEA LIONS - DOUBLE THEIR MORTALITY

#params_pinn <- new_model_hist0
#params_pinn2 <- new_model_spinup
params_pinn2 <- new_model_hist1

# Combine multiple improvements
#species_params(params_pinn)$erepro[19:21] <- species_params(params_pinn)$erepro[19:21] *0.99
species_params(params_pinn2)$z0[19:21] <- species_params(params_pinn2)$z0[19:21] *1.5
species_params(params_pinn2)$z0[22] <- species_params(params_pinn2)$z0[22] *0.8
#species_params(params_pinn)$z0[4:5] <- species_params(params_pinn)$z0[4:5] * 1.1

# Get current resource capacity
current_capacity <- resource_capacity(params_pinn2)
params_pinn2 <- setResource(params_pinn2, 
                    resource_capacity = current_capacity * 1.2)

# Recalculate parameters
params_pinn2 <- setParams(params_pinn2)

# Run projection
sim_pinn2 <- project(params_pinn2, effort=1.01,t_max=100, t_save=0.25)


#############################################################################
### INCREASE TRANSIENTS

#params_pinn <- new_model_hist0
#params_trans2 <- new_model_spinup
params_trans2 <- new_model_hist1

# Combine multiple improvements
#species_params(params_pinn)$erepro[19:21] <- species_params(params_pinn)$erepro[19:21] *0.99
species_params(params_trans2)$z0[25] <- species_params(params_trans2)$z0[25] *0.965

#species_params(params_pinn)$z0[4:5] <- species_params(params_pinn)$z0[4:5] * 1.1

# Get current resource capacity
current_capacity <- resource_capacity(params_trans2)
params_trans2 <- setResource(params_trans2, 
                    resource_capacity = current_capacity * 1.2)

# Recalculate parameters
params_trans2 <- setParams(params_trans2)

# Run projection
sim_trans2 <- project(params_trans2, effort=1.01,t_max=100,t_save=0.25)

########################################################################
### INCREASE HATCHERY PRODUCTIVITY OF SALMON

# Create a high productivity scenario
#params_high_prod <- new_model_hist0
#params_high_prod2h <- new_model_spinup
params_high_prod2h <- new_model_hist1

# Combine multiple improvements
#species_params(params_high_prod2)$erepro[4] <- species_params(params_high_prod2)$erepro[4] *1.03
#species_params(params_high_prod2)$erepro[10] <- species_params(params_high_prod2)$erepro[10] *1.03

species_params(params_high_prod2h)$z0[4] <- species_params(params_high_prod2h)$z0[4] * 0.5
species_params(params_high_prod2h)$z0[10] <- species_params(params_high_prod2h)$z0[10] * 0.5
species_params(params_high_prod2h)$z0[6] <- species_params(params_high_prod2h)$z0[6] * 0.5
species_params(params_high_prod2h)$z0[12] <- species_params(params_high_prod2h)$z0[12] * 0.5
#resource_params(params_high_prod)$kappa <- 114602882651 * 1.1
# Get current resource capacity
current_capacity <- resource_capacity(params_high_prod2h)
params_high_prod2h <- setResource(params_high_prod2h, 
                    resource_capacity = current_capacity * 1.2)

# Recalculate parameters
params_high_prod2h <- setParams(params_high_prod2h)

# Run projection
sim_high_prod2h <- project(params_high_prod2h, effort=1.01,t_max=100, t_save=0.25)




#############################################################################
### DECREAESE PROD OF SEALS AND SEA LIONS AND INCREASE SALMON FISHING

#params_pinn <- new_model_hist0
#params_pinn2b <- new_model_spinup
params_pinn2b <- new_model_hist1

# Combine multiple improvements
#species_params(params_pinn)$erepro[19:21] <- species_params(params_pinn)$erepro[19:21] *0.99
#species_params(params_pinn2b)$z0[19:21] <- species_params(params_pinn2b)$z0[19:21] *1.5

#species_params(params_pinn2b)$z0[4] <- species_params(params_pinn2b)$z0[4] * 0.99
#species_params(params_pinn2b)$z0[10] <- species_params(params_pinn2b)$z0[10] * 0.99
#species_params(params_pinn2b)$z0[6] <- species_params(params_pinn2b)$z0[6] * 0.99
#species_params(params_pinn2b)$z0[12] <- species_params(params_pinn2b)$z0[12] * 0.99

species_params(params_pinn2b)$z0[4:8] <- species_params(params_pinn2b)$z0[4:8] * 1.1
species_params(params_pinn2b)$z0[10:13] <- species_params(params_pinn2b)$z0[10:13] * 1.1

gear_params(params_pinn2b)["Harbor_seals, Seal_mort", "catchability"] <- 0.1

#gear_params(params_pinn2b)$catchability[19] <-  0.25
#gear_params(params_pinn2b)$catchability[19] <-  0.25

# Get current resource capacity
current_capacity <- resource_capacity(params_pinn2b)
params_pinn2b <- setResource(params_pinn2b, 
                    resource_capacity = current_capacity * 1.2)

# Recalculate parameters
params_pinn2b <- setParams(params_pinn2b)
params_pinn2b <- setFishing(params_pinn2b, effort=1)

# Run projection
sim_pinn2b <- project(params_pinn2b, effort=1.01,t_max=100, t_save=0.25)



#############################################################################
###variability

#  "Trend Continuation" = scenarios$scenario1_trend,
#  "General Decline" = scenarios$scenario2_decline,
#  "Salmon Half" = scenarios$scenario3_salmon_half,
#  "Salmon Double" = scenarios$scenario4_salmon_double

### DECREAESE PROD OF SEALS AND SEA LIONS - DOUBLE THEIR MORTALITY
#### THIS CODE DOESN"T WORK



```


##PREDATION MORTALITY
```{r}
salmon_species <- c("Chinook_Hatch_Adult","Chinook_Wild_Adult", "Coho_Hatch_Adult","Coho_Wild_Adult","Chinook_Hatch_Resident","Chinook_Wild_Resident", "Coho_Hatch_Resident","Coho_Wild_Resident" )

plotFMort(sim_quo2, species = salmon_species)

```

##PLOT ALL TOGETHER

```{r}

ssb0_df2 <- melt(getSSB(sim_0))
ssb1.5_df2 <- melt(getSSB(sim_eff1.5))
ssb1f_df2 <- melt(getSSB(sim_quo2))
ssb2f_df2 <- melt(getSSB(sim_high_prod2))
ssb2hf_df2 <- melt(getSSB(sim_high_prod2h))
ssb3f_df2 <- melt(getSSB(sim_low_prod2))
ssb4f_df2 <- melt(getSSB(sim_pinn2))

ssbvar1 <- melt(getSSB (sim_results[["Trend Continuation"]]))
ssbvar2 <- melt(getSSB (sim_results[["General Decline"]]))
ssbvar3 <- melt(getSSB ( sim_results[["Salmon Double"]]))
ssbvar4 <- melt(getSSB(  sim_results[["Salmon Half"]]))
ssbvar5 <- melt(getSSB (sim_results[["General Increase"]]))

 ssb_df2 <- rbind(
     #transform(ssb1.5_df2 , scenario = "Fishing effort increase"),
      transform(ssb1f_df2, scenario = "Status quo"),
   #     transform(ssb4f_df2, scenario = "Decrease pinniped productivity"),
    transform(ssb2f_df2, scenario = "Increase salmon productivity"),
        transform(ssb2hf_df2, scenario = "Increase hatchery productivity"),
  transform(ssb3f_df2, scenario = "Decrease salmon productivity")#,
  # transform(ssbvar1, scenario = "Status quo with variability"),
 # transform(ssbvar3, scenario = "Chinook fishing x 2")
)
colours <- c("Status quo" = "black", 
            # "Fishing effort increase" = "grey", 
             "Increase salmon productivity" = "green", #BOTTOM UP
               "Increase hatchery productivity" = "green4", #BOTTOM UP
             # "Decrease pinniped productivity" = "purple" #TOP DOWN,
               "Decrease salmon productivity" = "red", #BOTTOM UP,
            "Status quo with variability" = "grey",
            "Chinook fishing x 2" = "darkred"
             )
             
#ggplot(ssb_df2) +
#    geom_line(aes(x = time, y = value, colour = scenario)) +
#    facet_wrap(~sp, scales = "free", nrow = 4) +
#    theme(legend.position = "none") +
#    scale_colour_manual(values = colours)

# Plot only specific species (e.g., Cod and Haddock)
target_species <- c("Pacific_Herring", "Chinook_Hatch_Adult","Chinook_Wild_Adult", "Coho_Hatch_Adult","Coho_Wild_Adult","Chinook_Hatch_Resident","Chinook_Wild_Resident", "Coho_Hatch_Resident","Coho_Wild_Resident", "Hake",  "Harbor_seals", "Steller_sealions", "California_sealions", "Harbor_porpoise",  "Resident_Orca_S",  "Resident_Orca_N",   "Transient_Orca"  )

##ALL SPECIES
#ggplot(ssb_df2[ssb_df2$sp %in% target_species, ]) +
#    geom_line(aes(x = time, y = value, colour = scenario)) +
#    facet_wrap(~sp, scales = "free", nrow = 2) +
#    theme(legend.position = "none") +
#    scale_colour_manual(values = colours)


# Calculate relative values (as proportion of starting year)
ssb_relative2 <- ssb_df2
ssb_relative2$value <- with(ssb_relative2, {
    ave(value, sp, scenario, FUN = function(x) x / x[1])
})

# Plot with y-axis starting at 0
ggplot(ssb_relative2) +
    geom_line(aes(x = time, y = value, colour = scenario)) +
    facet_wrap(~sp, scales = "free_x", nrow = 4) +  # Only free x-axis
    #scale_y_continuous(limits = c(0, NA)) +  # Force y-axis to start at 0
    theme(legend.position = "none") +
    scale_colour_manual(values = colours) +
    labs(y = "Relative biomass (proportion of starting year)")

###SPECIFIC SPECIES
ggplot(ssb_relative2[ssb_relative2$sp %in% target_species, ]) +
    geom_line(aes(x = time, y = value, colour = scenario)) +
    facet_wrap(~sp, scales = "free", nrow = 4) +
    theme(legend.position = "none") +
    scale_colour_manual(values = colours)


```

############### TOP DOWN CONTROLS

```{r}
#years <- 1986:2050
ssb0_df3 <- melt(getSSB(sim_0))
ssb1f_df3 <- melt(getSSB(sim_quo2))
ssb4f_df3 <- melt(getSSB(sim_pinn2))
ssb5f_df3 <- melt(getSSB(sim_trans2))
ssb4f_df3b <- melt(getSSB(sim_pinn2b))

ssb_df3 <- rbind(
      transform(ssb1f_df3, scenario = "Status quo"),
      transform(ssb4f_df3, scenario = "Decrease pinniped productivity"),
      transform(ssb4f_df3b, scenario = "Pinniped reduction and fishing")
)
colours <- c("Status quo" = "black", 
             "Decrease pinniped productivity" = "green3", 
             "Pinniped reduction and fishing" = "blue"
             )
             
#ggplot(ssb_df2) +
#    geom_line(aes(x = time, y = value, colour = scenario)) +
#    facet_wrap(~sp, scales = "free", nrow = 4) +
#    theme(legend.position = "none") +
#    scale_colour_manual(values = colours)

# Plot only specific species (e.g., Cod and Haddock)
target_species <- c("Pacific_Herring", "Chinook_Hatch_Adult","Chinook_Wild_Adult", "Coho_Hatch_Adult","Coho_Wild_Adult","Chinook_Hatch_Resident","Chinook_Wild_Resident", "Coho_Hatch_Resident","Coho_Wild_Resident",  "Harbor_seals", "Steller_sealions", "California_sealions", "Harbor_porpoise",  "Resident_Orca_S",  "Resident_Orca_N",   "Transient_Orca"  )

##ALL SPECIES
#ggplot(ssb_df2[ssb_df2$sp %in% target_species, ]) +
#    geom_line(aes(x = time, y = value, colour = scenario)) +
#    facet_wrap(~sp, scales = "free", nrow = 2) +
#    theme(legend.position = "none") +
#    scale_colour_manual(values = colours)


# Calculate relative values (as proportion of starting year)
ssb_relative3 <- ssb_df3
ssb_relative3$value <- with(ssb_relative3, {
    ave(value, sp, scenario, FUN = function(x) x / x[1])
})

# Plot with y-axis starting at 0
ggplot(ssb_relative3) +
    geom_line(aes(x = time, y = value, colour = scenario)) +
    facet_wrap(~sp, scales = "free_x", nrow = 4) +  # Only free x-axis
    scale_y_continuous(limits = c(0.5, 1.5)) +  # Force y-axis to start at 0
    theme(legend.position = "none") +
    scale_colour_manual(values = colours) +
    labs(y = "Relative biomass (proportion of starting year)")

###SPECIFIC SPECIES
ggplot(ssb_relative3[ssb_relative3$sp %in% target_species, ]) +
    geom_line(aes(x = time, y = value, colour = scenario)) +
    facet_wrap(~sp, scales = "free", nrow = 4) +
   #   scale_y_continuous(limits = c(0.8, 1.2)) +  # Force y-axis to start at 0
    theme(legend.position = "none") +
    scale_colour_manual(values = colours)


```

################ PROFESSIONAL PLOTTING ####################

### TARGET SPECIES ONLY
```{r}
# Load required libraries
library(ggplot2)
library(reshape2)
library(dplyr)

# Set years from 2011 to 2111
years <- 2011:2111

# Prepare data
ssb0_df3 <- melt(getSSB(sim_0))
ssb1f_df3 <- melt(getSSB(sim_quo2))
ssb4f_df3 <- melt(getSSB(sim_pinn2))
ssb5f_df3 <- melt(getSSB(sim_trans2))
ssb4f_df3b <- melt(getSSB(sim_pinn2b))
ssb_eff1.5_df3 <- melt(getSSB(sim_eff1.5))
ssb_high_prod2_df3 <- melt(getSSB(sim_high_prod2))
ssb_low_prod2_df3 <- melt(getSSB(sim_low_prod2))
ssb_high_prod2h_df3 <- melt(getSSB(sim_high_prod2h))
ssb_pinn3_df3 <- melt(getSSB(sim_pinn3))

# Combine data with scenario labels
ssb_df3 <- rbind(
    transform(ssb1f_df3, scenario = "Status quo"),
    transform(ssb4f_df3, scenario = "Decrease pinniped productivity"),
    transform(ssb4f_df3b, scenario = "Pinniped reduction and fishing"),
    transform(ssb_eff1.5_df3, scenario = "Increase fishing effort"),
    transform(ssb_high_prod2_df3, scenario = "Increase salmon production"),
    transform(ssb_low_prod2_df3, scenario = "Decrease salmon production"),
    transform(ssb_high_prod2h_df3, scenario = "Increase salmon hatchery production"),
    transform(ssb_pinn3_df3, scenario = "Increase fishing and pinniped decline")
)

# Update time to years (assuming time starts at 1 and corresponds to 2011)
ssb_df3$time <- ssb_df3$time + 2010

# Define professional color palette
colours <- c(
    "Status quo" = "#2c3e50", 
    "Decrease pinniped productivity" = "#27ae60", 
    "Pinniped reduction and fishing" = "#3498db",
    "Increase fishing effort" = "#e74c3c",
    "Increase salmon production" = "#f39c12",
    "Decrease salmon production" = "#8e44ad",
    "Increase salmon hatchery production" = "#16a085",
    "Increase fishing and pinniped decline" = "#e67e22"
)

# Define target species
target_species <- c("Pacific_Herring", "Chinook_Hatch_Adult", "Chinook_Wild_Adult", 
                   "Coho_Hatch_Adult", "Coho_Wild_Adult", "Chinook_Hatch_Resident",
                   "Chinook_Wild_Resident", "Coho_Hatch_Resident", "Coho_Wild_Resident",  
                   "Harbor_seals", "Steller_sealions", "California_sealions", 
                   "Harbor_porpoise", "Resident_Orca_S", "Resident_Orca_N", "Transient_Orca")

# Calculate relative values (as proportion of starting year)
ssb_relative3 <- ssb_df3 %>%
    group_by(sp, scenario) %>%
    mutate(value = value / first(value)) %>%
    ungroup()

# Clean species names (remove underscores and improve formatting)
ssb_relative3$sp_clean <- gsub("_", " ", ssb_relative3$sp)
ssb_relative3$sp_clean <- gsub("Hatch", "Hatchery", ssb_relative3$sp_clean)
ssb_relative3$sp_clean <- gsub("sealions", "Sea Lions", ssb_relative3$sp_clean)

# Filter for target species
ssb_filtered <- ssb_relative3#[ssb_relative3$sp %in% target_species, ]

# Create ordered factor to maintain original species order
target_species_clean <- gsub("_", " ", target_species)
target_species_clean <- gsub("Hatch", "Hatchery", target_species_clean)
target_species_clean <- gsub("sealions", "Sea Lions", target_species_clean)

ssb_filtered$sp_clean <- factor(ssb_filtered$sp_clean, levels = target_species_clean)

# Create professional plot
p <- ggplot(ssb_filtered, aes(x = time, y = value, colour = scenario)) +
    geom_line(size = 0.8, alpha = 0.9) +
    facet_wrap(~sp_clean, scales = "free_y", nrow = 4) +
    scale_x_continuous(
        name = "Years",
        breaks = seq(2020, 2100, 20),
        minor_breaks = seq(2010, 2110, 10)
    ) +
    scale_y_continuous(
        name = "Proportional change"
    ) +
    scale_colour_manual(
        name = "Scenario",
        values = colours
    ) +
    theme_minimal() +
    theme(
        # Text formatting
        text = element_text(size = 10),
        axis.title = element_text(size = 12, face = "bold"),
        axis.text = element_text(size = 9),
        strip.text = element_text(size = 10, face = "bold"),
        legend.title = element_text(size = 11, face = "bold"),
        legend.text = element_text(size = 10),
        
        # Panel formatting
        panel.grid.major = element_line(color = "grey90", size = 0.5),
        panel.grid.minor = element_line(color = "grey95", size = 0.25),
        panel.border = element_rect(color = "black", fill = NA, size = 0.5),
        
        # Strip formatting
        strip.background = element_rect(fill = "grey95", color = "black", size = 0.5),
        
        # Legend formatting
        legend.position = "bottom",
        legend.box = "horizontal",
        legend.margin = margin(t = 10),
        legend.key.width = unit(1.2, "cm"),
        
        # Plot margins
        plot.margin = margin(t = 10, r = 15, b = 10, l = 10),
        
        # Facet spacing
        panel.spacing = unit(0.5, "lines")
    ) +
    guides(
        colour = guide_legend(
            override.aes = list(size = 1.2)#,
            #ncol = 3
        )
    )

# Display the plot
print(p)

# Optional: Save as high-resolution figure for journal submission
ggsave("species_biomass_projection.png", p, 
       width = 10, height = 14, dpi = 300, bg = "white")
ggsave("species_biomass_projection.pdf", p, 
       width = 10, height = 14, bg = "white")
```


### ALL SPECIES
```{r}
# Load required libraries
library(ggplot2)
library(reshape2)
library(dplyr)

# Set years from 2011 to 2111
years <- 2011:2111

# Prepare data
ssb0_df3 <- melt(getSSB(sim_0))
ssb1f_df3 <- melt(getSSB(sim_quo2))
ssb4f_df3 <- melt(getSSB(sim_pinn2))  ## increase just seals
ssb5f_df3 <- melt(getSSB(sim_trans2))
ssb4f_df3b <- melt(getSSB(sim_pinn2b)) ## increase mortality of seals and sea lions and increase fishing effort
ssb_eff1.5_df3 <- melt(getSSB(sim_eff1.5))
ssb_high_prod2_df3 <- melt(getSSB(sim_high_prod2))
ssb_low_prod2_df3 <- melt(getSSB(sim_low_prod2))
ssb_high_prod2h_df3 <- melt(getSSB(sim_high_prod2h))
#ssb_pinn3_df3 <- melt(getSSB(sim_pinn3))

# Combine data with scenario labels
ssb_df3 <- rbind(
    transform(ssb1f_df3, scenario = "Status quo"),
    transform(ssb4f_df3, scenario = "Decrease pinniped productivity"),
    transform(ssb4f_df3b, scenario = "Decrease salmon production, pinniped decline"),
    transform(ssb_eff1.5_df3, scenario = "Increase fishing effort"),
    transform(ssb_high_prod2_df3, scenario = "Increase salmon production"),
    transform(ssb_low_prod2_df3, scenario = "Decrease salmon production"),
    transform(ssb_high_prod2h_df3, scenario = "Increase salmon hatchery production")
    #transform(ssb_pinn3_df3, scenario = "Decrease salmon production, pinniped declineX")
)

# Update time to years (assuming time starts at 1 and corresponds to 2011)
ssb_df3$time <- ssb_df3$time + 2010

# Define professional color palette
colours <- c(
    "Status quo" = "#2c3e50", 
    "Decrease pinniped productivity" = "#E31A1C", 
    #"Decrease salmon production, pinniped decline1" = "#3450db",
    "Increase fishing effort" = "#33A02C",
    "Increase salmon production" = "#FB9A99",
    "Decrease salmon production" = "#1F78B4", 
    "Increase salmon hatchery production" = "#6A3D9A",
    "Decrease salmon production, pinniped decline" =  "#FF7F00"
    
    
)

ssb_relative3 <- ssb_df3 %>%
    group_by(sp, scenario) %>%
    mutate(value = value / first(value)) %>%
    ungroup()

# Get all species from the data (original order from data)
all_species <- unique(ssb_relative3$sp)

# Calculate relative values (as proportion of starting year)
ssb_relative3 <- ssb_df3 %>%
    group_by(sp, scenario) %>%
    mutate(value = value / first(value)) %>%
    ungroup()

# Clean species names (remove underscores and improve formatting)
ssb_relative3$sp_clean <- gsub("_", " ", ssb_relative3$sp)
ssb_relative3$sp_clean <- gsub("Hatch", "Hatchery", ssb_relative3$sp_clean)
ssb_relative3$sp_clean <- gsub("sealions", "Sea Lions", ssb_relative3$sp_clean)
# Fix orca naming
ssb_relative3$sp_clean <- gsub("Resident Orca S", "SRKW", ssb_relative3$sp_clean)
ssb_relative3$sp_clean <- gsub("Resident Orca N", "NRKW", ssb_relative3$sp_clean)
ssb_relative3$sp_clean <- gsub("Transient Orca", "TKW", ssb_relative3$sp_clean)

# Use all species (no filtering)
ssb_filtered <- ssb_relative3

# Create ordered factor to maintain original species order from data
all_species_clean <- gsub("_", " ", all_species)
all_species_clean <- gsub("Hatch", "Hatchery", all_species_clean)
all_species_clean <- gsub("sealions", "Sea Lions", all_species_clean)
# Fix orca naming in the levels
all_species_clean <- gsub("Resident Orca S", "SRKW", all_species_clean)
all_species_clean <- gsub("Resident Orca N", "NRKW", all_species_clean)
all_species_clean <- gsub("Transient Orca", "TKW", all_species_clean)

ssb_filtered$sp_clean <- factor(ssb_filtered$sp_clean, levels = all_species_clean)

# Create professional plot
p <- ggplot(ssb_filtered, aes(x = time, y = value, colour = scenario)) +
    geom_line(size = 0.8, alpha = 0.9) +
    facet_wrap(~sp_clean, scales = "free_y",  ncol = 4) +
    scale_x_continuous(
        name = "Years",
        breaks = seq(2020, 2100, 20),
        minor_breaks = seq(2010, 2110, 10)
    ) +
    scale_y_continuous(
        name = "Proportional change"
    ) +
    scale_colour_manual(
        name = "Scenario",
        values = colours
    ) +
    theme_minimal() +
    theme(
        # Text formatting
        text = element_text(size = 10),
        axis.title = element_text(size = 12, face = "bold"),
        axis.text = element_text(size = 9),
        strip.text = element_text(size = 10, face = "bold"),
        legend.title = element_text(size = 11, face = "bold"),
        legend.text = element_text(size = 10),
        
        # Panel formatting
        panel.grid.major = element_line(color = "grey90", size = 0.5),
        panel.grid.minor = element_line(color = "grey95", size = 0.25),
        panel.border = element_rect(color = "black", fill = NA, size = 0.5),
        
        # Strip formatting
        strip.background = element_rect(fill = "grey95", color = "black", size = 0.5),
        
        # Legend formatting
        legend.position = "bottom",
        legend.box = "horizontal",
        legend.margin = margin(t = 10),
        legend.key.width = unit(1.2, "cm"),
        
        # Plot margins
        plot.margin = margin(t = 10, r = 15, b = 10, l = 10),
        
        # Facet spacing
        panel.spacing = unit(0.5, "lines")
    ) +
    guides(
        colour = guide_legend(
            override.aes = list(size = 1.2),
            ncol = 3
        )
    )

# Display the plot
print(p)

# Optional: Save as high-resolution figure for journal submission
ggsave("species_biomass_projection.png", p, 
       width = 10, height = 14, dpi = 300, bg = "white")
ggsave("species_biomass_projection.pdf", p, 
       width = 10, height = 14, bg = "white")

```

```{r}
# Export data to CSV file
write.csv(ssb_filtered, "C:/Users/MCSHANEV/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250813/species_biomass_data.csv", row.names = FALSE)
print("Data exported to 'species_biomass_data.csv'")

# Optional: Export summary statistics
summary_stats <- ssb_filtered %>%
    group_by(sp_clean, scenario) %>%
    summarise(
        start_value = first(value),
        end_value = last(value),
        min_value = min(value),
        max_value = max(value),
        mean_value = mean(value),
        final_change = (last(value) - first(value)) / first(value) * 100,
        .groups = 'drop'
    )

write.csv(summary_stats, "C:/Users/MCSHANEV/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250813/species_biomass_summary.csv", row.names = FALSE)
print("Summary statistics exported to 'species_biomass_summary.csv'")


```
##################### ANNUAL YIELD
```{r}
# Method 1: Get total yield using getYield()
# This gives you total catch by species and time
yield_sim1 <- getYield(sim_pinn2)  # Replace with your simulation object
yield_sim2 <- getYield(sim_pinn2b)  # For comparison

# Check dimensions: [time, species]
print("Yield dimensions:")
print(dim(yield_sim1))
print("Species names:")
print(dimnames(yield_sim1)$sp)

# Method 2: Get yield by gear type using getYieldGear()
# This shows catch by gear and species
#yield_by_gear_sim1 <- getYieldGear(sim_pinn3)
yield_by_gear_sim1 <- getYieldGear(sim_pinn2b)

print("Yield by gear dimensions:")
print(dim(yield_by_gear_sim1))
print("Gear names:")
print(dimnames(yield_by_gear_sim1)$gear)

# Method 3: Convert yield data to long format for analysis
library(reshape2)
library(dplyr)

# Total yield by species
yield_df1 <- melt(yield_sim1, varnames = c("time", "sp"), value.name = "yield")
yield_df1$scenario <- "Scenario 1"

yield_df2 <- melt(yield_sim2, varnames = c("time", "sp"), value.name = "yield")
yield_df2$scenario <- "Scenario 2"

# Combine scenarios
yield_combined <- rbind(yield_df1, yield_df2)

# Convert time to actual years (assuming simulation starts at 2011)
yield_combined$time <- yield_combined$time + 2010

# Method 4: Compare yields across all scenarios
sim_list <- list(
    "Status quo" = sim_quo2,
    "Decrease pinniped productivity" = sim_pinn2,
    #"Pinniped reduction and fishing" = sim_pinn2b,
    "Increase fishing effort" = sim_eff1.5,
    "Increase salmon production" = sim_high_prod2,
    "Decrease salmon production" = sim_low_prod2,
    "Increase salmon hatchery production" = sim_high_prod2h,
    "Decrease salmon production, pinniped decline" = sim_pinn2b
)

# Extract yield for all scenarios
yield_all_scenarios <- map_dfr(sim_list, function(sim) {
    yield_data <- getYield(sim)
    yield_df <- melt(yield_data, varnames = c("time", "sp"), value.name = "yield")
    yield_df$time <- yield_df$time + 2010  # Convert to actual years
    return(yield_df)
}, .id = "scenario")

# Method 5: Filter for only fished species (those with non-zero catches)
fished_species <- yield_all_scenarios %>%
    group_by(sp) %>%
    summarise(total_yield = sum(yield, na.rm = TRUE), .groups = 'drop') %>%
    filter(total_yield > 0) %>%
    pull(sp)

print("Fished species:")
print(fished_species)

# Filter data for fished species only
yield_fished <- yield_all_scenarios %>%
    filter(sp %in% fished_species & sp != "Harbor_seals")

# Clean species names
yield_fished$sp_clean <- gsub("_", " ", yield_fished$sp)
yield_fished$sp_clean <- gsub("Hatch", "Hatchery", yield_fished$sp_clean)

# Method 6: Calculate summary statistics
yield_summary <- yield_fished %>%
    group_by(sp_clean, scenario) %>%
    summarise(
        mean_annual_yield = mean(yield, na.rm = TRUE),
        total_yield = sum(yield, na.rm = TRUE),
        max_annual_yield = max(yield, na.rm = TRUE),
        min_annual_yield = min(yield, na.rm = TRUE),
        final_year_yield = last(yield),
        first_year_yield = first(yield),
        yield_change_percent = (last(yield) - first(yield)) / first(yield) * 100,
        .groups = 'drop'
    )

# Method 7: Get yield by gear type for detailed analysis
yield_by_gear_all <- map_dfr(sim_list, function(sim) {
    gear_yield <- getYieldGear(sim)
    gear_df <- melt(gear_yield, varnames = c("time", "gear", "sp"), value.name = "yield")
    gear_df$time <- gear_df$time + 2010
    return(gear_df)
}, .id = "scenario")

# Filter for fished species
yield_gear_fished <- yield_by_gear_all %>%
    filter(sp %in% fished_species, yield > 0)

# Method 8: Plot annual yield over time
library(ggplot2)

# Define professional colors for scenarios
colours <- c(
    "Status quo" = "#2c3e50", 
    "Decrease pinniped productivity" = "#27ae60", 
    #"Decrease salmon production, pinniped decline1" = "#3450db",
    "Increase fishing effort" = "#e74c3c",
    "Increase salmon production" = "#f39c12",
    "Decrease salmon production" = "#8e44ad",
    "Increase salmon hatchery production" = "#e67e22",
    "Decrease salmon production, pinniped decline" = "#3498db"
)

# Plot yield trends
p_yield <- ggplot(yield_fished, aes(x = time, y = yield/1000, color = scenario)) +
    geom_line(size = 0.8, alpha = 0.9) +
    facet_wrap(~sp_clean, scales = "free_y", nrow = 5) +
    scale_x_continuous(
        name = "Years",
        breaks = seq(2020, 2100, 20),
        minor_breaks = seq(2010, 2110, 10)
    ) +
    scale_y_continuous(
        name = "Annual Yield (tonnes × 1000)"
    ) +
    scale_colour_manual(
        name = "Scenario",
        values = colours
    ) +
    theme_minimal() +
    theme(
        text = element_text(size = 10),
        axis.title = element_text(size = 12, face = "bold"),
        axis.text = element_text(size = 9),
        strip.text = element_text(size = 10, face = "bold"),
        legend.position = "bottom",
        legend.title = element_text(size = 11, face = "bold"),
        panel.grid.major = element_line(color = "grey90", size = 0.5),
        panel.border = element_rect(color = "black", fill = NA, size = 0.5),
        strip.background = element_rect(fill = "grey95", color = "black", size = 0.5)
    ) +
    guides(colour = guide_legend(ncol = 4))

print(p_yield)

# Method 9: Export data to CSV files
write.csv(yield_fished, "annual_yield_timeseries.csv", row.names = FALSE)
write.csv(yield_summary, "annual_yield_summary.csv", row.names = FALSE)
write.csv(yield_gear_fished, "annual_yield_by_gear.csv", row.names = FALSE)

# Method 10: Calculate cumulative yield over projection period
cumulative_yield <- yield_fished %>%
    group_by(sp_clean, scenario) %>%
    arrange(time) %>%
    mutate(cumulative_yield = cumsum(yield)) %>%
    ungroup()

write.csv(cumulative_yield, "cumulative_yield.csv", row.names = FALSE)

# Save yield plot
ggsave("annual_yield_projections.png", p_yield, 
       width = 14, height = 10, dpi = 300, bg = "white")
ggsave("annual_yield_projections.pdf", p_yield, 
       width = 14, height = 10, bg = "white")

print("Annual yield analysis complete!")
print("Files saved:")
print("- annual_yield_timeseries.csv")
print("- annual_yield_summary.csv") 
print("- annual_yield_by_gear.csv")
print("- cumulative_yield.csv")
print("- annual_yield_projections.png/pdf")
```


########## PREDATION MORTALITY FUTRE
```{r}
# Method 1: Get predation mortality using getPredMort()
# This gives you predation mortality by species, time, and size
pred_mort_sim0 <- getPredMort(sim_quo2)  # For comparison
pred_mort_sim1 <- getPredMort(sim_pinn2)  # Replace with your simulation object
pred_mort_sim2 <- getPredMort(sim_pinn2b)  # For comparison

# Check dimensions: [time, species, size_class]
print("Predation mortality dimensions:")
print(dim(pred_mort_sim1))

# Method 2: Get total mortality (includes predation + fishing + background)
total_mort_sim1 <- getM2(sim_pinn2)  # M2 is predation mortality
total_mort_sim2 <- getM2(sim_pinn2b)

# Method 3: Extract predation mortality time series for specific species
library(reshape2)

# Convert to long format for plotting
pred_mort_df <- melt(pred_mort_sim1, varnames = c("time", "sp", "w"), value.name = "pred_mortality")

# Add scenario information
pred_mort_df$scenario <- "Your Scenario Name"

# If you want size-averaged predation mortality by species and time
pred_mort_by_species <- pred_mort_df %>%
    group_by(time, sp, scenario) %>%
    summarise(avg_pred_mortality = mean(pred_mortality, na.rm = TRUE),
              weighted_pred_mortality = weighted.mean(pred_mortality, w, na.rm = TRUE),
              .groups = 'drop')

# Method 4: Compare predation mortality between scenarios
# Get predation mortality for multiple simulations
sim_list <- list(
    "Status quo" = sim_quo2,
    "Pinniped scenario" = sim_pinn2,
    "Other scenario" = sim_pinn2b
)

# Extract predation mortality for all scenarios
pred_mort_comparison <- map_dfr(sim_list, function(sim) {
    pred_mort <- getPredMort(sim)
    pred_mort_df <- melt(pred_mort, varnames = c("time", "sp", "w"), value.name = "pred_mortality")
    
    # Size-averaged by species and time
    pred_mort_df %>%
        group_by(time, sp) %>%
        summarise(avg_pred_mortality = mean(pred_mortality, na.rm = TRUE), .groups = 'drop')
}, .id = "scenario")

# Convert time to years (assuming your simulation starts at 2011)
pred_mort_comparison$time <- pred_mort_comparison$time + 2010

# Method 5: Get predation mortality for specific species
target_species <- c("Pacific_Herring", "Chinook_Hatch_Adult", "Harbor_seals")

pred_mort_targets <- pred_mort_comparison %>%
    filter(sp %in% target_species)

# Clean species names
pred_mort_targets$sp_clean <- gsub("_", " ", pred_mort_targets$sp)
pred_mort_targets$sp_clean <- gsub("Hatch", "Hatchery", pred_mort_targets$sp_clean)

# Method 6: Plot predation mortality over time
library(ggplot2)

p_pred_mort <- ggplot(pred_mort_targets, aes(x = time, y = avg_pred_mortality, color = scenario)) +
    geom_line(size = 0.8) +
    facet_wrap(~sp_clean, scales = "free_y", nrow = 2) +
    labs(x = "Years", 
         y = "Average Predation Mortality (year⁻¹)",
         color = "Scenario",
         title = "Predation Mortality Over Time") +
    theme_minimal() +
    theme(
        legend.position = "bottom",
        strip.text = element_text(size = 10, face = "bold")
    )

print(p_pred_mort)

# Method 7: Export predation mortality data
write.csv(pred_mort_comparison, "predation_mortality_timeseries.csv", row.names = FALSE)

# Method 8: Get predation mortality by predator-prey relationships
# This requires more advanced analysis using the interaction matrix
pred_rates <- getPredRate(sim_pinn2)  # Predation rates
print("Predation rates dimensions:")
print(dim(pred_rates))

# Method 9: Summary statistics
pred_mort_summary <- pred_mort_comparison %>%
    group_by(sp, scenario) %>%
    summarise(
        mean_pred_mort = mean(avg_pred_mortality, na.rm = TRUE),
        max_pred_mort = max(avg_pred_mortality, na.rm = TRUE),
        min_pred_mort = min(avg_pred_mortality, na.rm = TRUE),
        final_pred_mort = last(avg_pred_mortality),
        change_pred_mort = (last(avg_pred_mortality) - first(avg_pred_mortality)) / first(avg_pred_mortality) * 100,
        .groups = 'drop'
    )

write.csv(pred_mort_summary, "predation_mortality_summary.csv", row.names = FALSE)

print("Predation mortality analysis complete!")
print("Files saved:")
print("- predation_mortality_timeseries.csv")
print("- predation_mortality_summary.csv")

```

##################INDICATORS


```{r}
# plot change in biomass under each scenario relative to unfished values
# get saved values from steady state without fishing that we generated earlier 
#sim0 
# get the unfished biomasses
B_unfished <- getBiomass(sim_0)[1, ]
#scen 1
Brel_scen1_2050 <- getBiomass(sim_eff1.5)["50", ] / B_unfished

#scen 2
Brel_scen2_2050 <- getBiomass(sim_quo)["50", ] / B_unfished

Brel_scens <- rbind(data.frame(species = names(Brel_scen1_2050),
                               value = Brel_scen1_2050, scen = "Increase fishing 20%"),
                    data.frame(species = names(Brel_scen2_2050),
                               value = Brel_scen2_2050, scen = "Status quo"))

# barplot comparing the 2 scenarios by 2050
ggplot(Brel_scens, aes(fill = scen, y = value, x = species)) + 
    geom_bar(position = "dodge", stat = "identity") + 
     geom_hline(yintercept = 1, linetype = 2, colour = "red", size = 0.5) + 
    scale_y_log10(name = "log10(Biomass/Biomass Unfished)")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

###Exploring the model outputs Here we look at some of the ways the
results of the simulation can be explored. We calculate the community
indicators mean maximum weight, mean individual weight, community slope
and the large fish indicator (LFI) over the simulation period, and
compare them to the unexploited values. We also compare the simulated
values of the LFI to a community target based on achieving a high
proportion of the unexploited value of the LFI of .

The indicators are calculated using the functions described in the
section about indicator functions. Here we calculate the LFI and the
other community indicators for the unexploited community. When
calculating these indicators we only include demersal species and
individuals in the size range 10 g to 100 kg, and the LFI is based on
species larger than 40 cm. Each of these functions returns a time
series. We are interested only in the equilibrium unexploited values so
we just select the final time step.

```{r}
salmon_species <- c(#"Chinook_Hatch_Adult","Chinook_Wild_Adult", "Coho_Hatch_Adult", "Coho_Wild_Adult",
                  "Chinook_Hatch_Resident","Chinook_Wild_Resident", "Coho_Hatch_Resident","Coho_Wild_Resident",
                    "Chum_Adult","Sockeye_Adult")
fishery_species <- c(#"Chinook_Hatch_Adult","Chinook_Wild_Adult", "Coho_Hatch_Adult", "Coho_Wild_Adult",
                     "Chinook_Hatch_Resident", "Chinook_Wild_Resident", "Coho_Hatch_Resident",  "Coho_Wild_Resident",
                   # "Chum_Adult","Sockeye_Adult",
                    "Halibut", 
                    "Rockfish",
                    "Lingcod", 
                    "Pacific_Herring",
                    "Small_Planktivorous_Fish",
                    "Other_fish",
                        "Hake")


final <- idxFinalT(sim0)
lfi0 <- getProportionOfLargeFish(sim0, 
                                 #species = salmon_species,
                                 species = fishery_species, 
                                 min_w = 10, max_w = 100e3, 
                                 threshold_l = 40)[[final]]
mw0 <- getMeanWeight(sim0, 
                     #species = salmon_species,
                     species = fishery_species, 
                     min_w = 100, 
                     max_w = 100e3)[[final]]
mmw0 <- getMeanMaxWeight(sim0, 
                         species = fishery_species, 
                         #species = salmon_species,
                         min_w = 10, max_w = 100e3)[final, "mmw_biomass"]
slope0 <- getCommunitySlope(sim0, 
                            species = fishery_species, 
                            #species = salmon_species,
                            min_w = 10, max_w = 100e2)[final, "slope"]

#We also calculate the time series of these indicators for the exploited community:
lfi <- getProportionOfLargeFish(sim_histc, #species = salmon_species,
                                species = fishery_species, 
                                min_w = 10, max_w = 100e3, 
                                threshold_l = 40
                                )
mw <- getMeanWeight(sim_histc,
                    species = fishery_species, 
                    min_w = 100, max_w = 100e3)
mmw <- getMeanMaxWeight(sim_histc, 
                        species = fishery_species, 
                        min_w = 10,
                        max_w = 100e3)[, "mmw_biomass"]
slope <- getCommunitySlope(sim_histc,  
                           species = fishery_species, 
                           min_w = 10,
                           max_w = 100e2)[, "slope"]
```

We can plot the exploited and unexploited indicators, along LFI
reference level. Here we do it using ggplot2 which uses data.frames. We
make three data.frames (one for the time series, one for the unexploited
levels and one for the reference level): Each data.frame is a data.frame
of each of the measures, stacked on top of each other.

```{r}
library(ggplot2)
years <- 1986:2011
# Simulated data
community_plot_data <- rbind(
    data.frame(year = years, measure = "LFI", data = lfi),
    data.frame(year = years, measure = "Mean Weight", data = mw),
    data.frame(year = years, measure = "Mean Max Weight", data = mmw),
    data.frame(year = years, measure = "Slope", data = slope))
# Unexploited data
community_unfished_data <- rbind(
    data.frame(year = years, measure = "LFI", data = lfi0),
    data.frame(year = years, measure = "Mean Weight", data = mw0),
    data.frame(year = years, measure = "Mean Max Weight", data = mmw0),
    data.frame(year = years, measure = "Slope", data = slope0))
# Reference level
community_reference_level <-
    data.frame(year = years, measure = "LFI", data = lfi0 * 0.9)
# Build up the plot
ggplot(community_plot_data) + 
    geom_line(aes(x = year, y = data)) +
    facet_wrap(~measure, scales = "free") + 
    geom_line(aes(x = year, y = data), linetype = "dashed",
              data = community_unfished_data) +
    geom_line(aes(x = year, y = data), linetype = "dotted",
              data = community_reference_level)

```

```{r}
salmon_species <- c(#"Chinook_Hatch_Adult","Chinook_Wild_Adult", "Coho_Hatch_Adult", "Coho_Wild_Adult",
                    # "Chum_Adult","Sockeye_Adult"
                     "Chinook_Hatch_Resident", "Chinook_Wild_Resident", 
                  "Coho_Hatch_Resident",  "Coho_Wild_Resident"
                )

final <- idxFinalT(sim0)
lfi0 <- getProportionOfLargeFish(sim0, 
                                 species = salmon_species,
                                 #species = fishery_species, 
                                 min_w = 10, max_w = 100e3, 
                                 threshold_l = 40)[[final]]
mw0 <- getMeanWeight(sim0, 
                     species = salmon_species,
                     #species = fishery_species, 
                     min_w = 10, max_w = 100e3)[[final]]
mmw0 <- getMeanMaxWeight(sim0, 
                         #species = fishery_species, 
                         species = salmon_species,
                         min_w = 10, max_w = 100e3)[final, "mmw_biomass"]
slope0 <- getCommunitySlope(sim0, 
                           # species = fishery_species, 
                            species = salmon_species,
                            min_w = 10, max_w = 100e3)[final, "slope"]

#We also calculate the time series of these indicators for the exploited community:
lfi <- getProportionOfLargeFish(sim_hist, 
                                species = salmon_species,
                                #species = fishery_species, 
                                min_w = 10, max_w = 100e3, 
                                threshold_l = 40
                                )
mw <- getMeanWeight(sim_hist, 
                    species = salmon_species,
                    #species = fishery_species, 
                    min_w = 10, max_w = 100e3)
mmw <- getMeanMaxWeight(sim_hist, 
                        species = salmon_species, 
                        #species = fishery_species, 
                        min_w = 10,
                        max_w = 100e3)[, "mmw_biomass"]
slope <- getCommunitySlope(sim_hist, 
                           species = salmon_species, 
                           #species = fishery_species, 
                           min_w = 10,
                           max_w = 100e3)[, "slope"]
```

We can plot the exploited and unexploited indicators, along LFI
reference level. Here we do it using ggplot2 which uses data.frames. We
make three data.frames (one for the time series, one for the unexploited
levels and one for the reference level): Each data.frame is a data.frame
of each of the measures, stacked on top of each other.

```{r}
library(ggplot2)
years <- 1986:2011
# Simulated data
community_plot_data <- rbind(
    data.frame(year = years, measure = "LFI", data = lfi),
    data.frame(year = years, measure = "Mean Weight", data = mw),
    data.frame(year = years, measure = "Mean Max Weight", data = mmw),
    data.frame(year = years, measure = "Slope", data = slope))
# Unexploited data
community_unfished_data <- rbind(
    data.frame(year = years, measure = "LFI", data = lfi0),
    data.frame(year = years, measure = "Mean Weight", data = mw0),
    data.frame(year = years, measure = "Mean Max Weight", data = mmw0),
    data.frame(year = years, measure = "Slope", data = slope0))
# Reference level
community_reference_level <-
    data.frame(year = years, measure = "LFI", data = lfi0 * 0.9)
# Build up the plot
ggplot(community_plot_data) + 
    geom_line(aes(x = year, y = data)) +
    facet_wrap(~measure, scales = "free") + 
    geom_line(aes(x = year, y = data), linetype = "dashed",
              data = community_unfished_data) +
    geom_line(aes(x = year, y = data), linetype = "dotted",
              data = community_reference_level)

```

Historical LFI in the region has been below the reference level


