---
title: "Orca_tuneparams_May24"
author: "Viv Tulloch"
date: "2024-05-21"
output:
  pdf_document: default
  html_document: default
editor_options: 
  markdown: 
    wrap: 72
---

## Create a mizer model

```{r message=FALSE}
remotes::install_github("sizespectrum/mizerExperimental")
library(mizerExperimental)
remotes::install_github("sizespectrum/mizerMR")
library(mizerMR)
library(tidyverse)
#rm(cur_model_steady)
```

```{r}
#oprn model 
ss_species_params <-   read.csv(
  "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_Nov24/pars_241212/ss_pars_2011_241212_2.csv")

ss_gear_params<-read.csv("/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_Nov24/pars_241212/ss_gear_2011_241212.csv")

## interaction matrix set to 0,1 - need to modify this based on prey preferences
ss_interaction <-   read.csv(
    "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_Nov24/pars_241212/ss_mizer_interaction_241212.csv", row.names=1)

#read in time-averaged  catches 
#params<- cur_model
#cdat<-read.csv(
#  "C:/Users/vtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Puget_Sound/spp_Aug2023_CM/05_fisheries/ts_fishe#ries_rev_avyield_addtrans.csv") ### units: tonnes


```

## setting fishing effort to 1, so that catchability = fishing mortality

```{r}
cur_model <- newMultispeciesParams(species_params = ss_species_params, 
                                   interaction = ss_interaction, 
                                   gear_params = ss_gear_params,
                                  initial_effort = 1,
                                   lambda = 2.05, n=0.75,  p = 0.75, w_pp_cutoff = 50, kappa = 2372072334750
                                   )
```

**Step 2: Project to steady state**

```{r}
#rm(cur_model_steady)
cur_model_steady <- steady(cur_model)
species_params(cur_model_steady)
plotlySpectra(cur_model_steady, power = 2)
```

**Step 3: Calibrate the scale** **Step 4: Rescale species spectra**

```{r}
cur_model <- calibrateBiomass(cur_model_steady)
plotBiomassVsSpecies(cur_model)
cur_model <- matchBiomasses(cur_model)
plotBiomassVsSpecies(cur_model)
species_params(cur_model)
```

Step 5: Rinse and repeat

Rescaling the spectra of the individual species has not created another
steady state. All species now experience a new prey distribution and a
new predator distribution and so their growth and death rates have
changed, which requires us to run the dynamics again to find the new
steady state. So we essentially go back to step 2 and project to steady
state:

```{r}
cur_model <- cur_model |>
     matchBiomasses() |> steady() |> matchBiomasses() |> steady() |>
   matchBiomasses() |> steady() |> matchBiomasses() |> steady() 
```

```{r}
cur_model <- cur_model |>
  matchBiomasses() |> steady() |> matchBiomasses() |> steady() |>
  matchBiomasses() |> steady() |> matchBiomasses() |> steady() |>
 matchBiomasses() |> steady() |> matchBiomasses() |> steady() |>
matchBiomasses() |> steady() |> matchBiomasses() |> steady() 

```

```{r}
#species_params(ss_mizerout1979_pars_240521_fishing075)
```

```{r}
#plotBiomassVsSpecies(cur_model)
plotSpectra(cur_model, power = 2            )

```

plot works? YAAAAAAAAAAAAA

```{r}

plotDiet(cur_model)#, species = "California_sea_lions")
plotGrowthCurves(cur_model, species_panel = TRUE)
plotlyFeedingLevel(cur_model)
getReproductionLevel(cur_model)
species_params(cur_model)
```

tuneParams(cur_model)

```{r}
tuned_model <- readRDS("~/Downloads/tuned_params (51).rds")
tuneParams(tuned_model)

```

```{r}
tuned_model <- readRDS("~/Downloads/tuned_params (59).rds")
dft1<-species_params(tuned_model)
species_params(tuned_model)
getReproductionLevel(tuned_model)
plotDiet(tuned_model)#, species = "California_sea_lions")
plotGrowthCurves(tuned_model, species_panel = TRUE)
plotlyFeedingLevel(tuned_model)

```

```{r}
tuned_model@resource_params$kappa
tuned_model@species_params$biomass_model[5]
```

```{r}
 sim1 <- project(tuned_model, effort = 1, t_max = 30, t_save=3)
 plot(sim1)
 
 animateSpectra(sim1, total = TRUE, power = 1)#, 
               #ylim = c(1e-8, NA), wlim = c(1e-3, NA))
 plotlyBiomassRelative(sim1)

```

tuneParams(tuned_model)

```{r}
saveParams(tuned_model, "ss_mizerout2011_pars_241212_fishing1.rds")
dfnew<-(species_params(tuned_model))

write.csv(dfnew, "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_Nov24/pars_241212/ss_mizerout2011_pars_241212_fishing1.csv")
saveParams(tuned_model, "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_Nov24/pars_241212/ss_mizerout2011_pars_241212_fishing1.rds")
```

```{r}
try(unload("mizerExperimental"), silent = TRUE)
remotes::install_github("sizespectrum/mizerExperimental", quiet = TRUE)
library(mizerExperimental)
library(tidyverse)
cur_model<- readRDS("~/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_Jan25/ss_mizerout2011_pars_250317_fishing1_updfmort_allsteady.rds")
```

```{r}
cur_model <- newMultispeciesParams(species_params = ss_species_params, 
                                   interaction = ss_interaction,
                                   gear_params = ss_gear_params,
                                  initial_effort = 1,
                                   lambda = 2.05, n=0.75,  p = 0.75, w_pp_cutoff = 50, kappa = 430335921965
                                   )
```

new kappa = 160444035711.701

#####22 APRIL 2025

```{r}
plot1<- plotDiet(params_e1)#, species = "California_sea_lions")
plot2<-plotGrowthCurves(params_e1, species_panel = TRUE)
plot3<-plotlyFeedingLevel(params_e1)

saveParams(params_e1, "cur_model_resilient_tuned_250422.rds")
dfcm4a<-(species_params(params_e1))

write.csv(dfcm4a, "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_Nov24/pars_241212/ss_mizerout2011_pars_250422_fishing1_restune_upd.csv")
saveParams(params_e1, "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_Jan25/ss_mizerout2011_pars_250422_fishing1_restune_upd.rds")
```

```{r}

sim2<- project(params_e1, t_max = 100,  t_save=5)
animateSpectra(sim2, power = 2)
plotlyBiomassRelative(sim2)
 

```

```{r}

sim10<- project(params_e1, effort=0,t_max = 100,  t_save=5)
animateSpectra(sim10, power = 2)
plotlyBiomassRelative(sim10 )
 

```

###HERE 23 May 2025

ADD NEW GEARS ADD NEW BIOMASS

HINDCAST

REDUCE EREPRO FOR SALMON

##New biomass, new catches

```{r}


#new gear and effort that splits canadian and US fisheries
gear_params2011_allfisheries_250521 <- read.csv("~/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/fisheries/time series fisheries/gear_params2011_allfisheries_250521.csv")

```

```{r}
#new_model <- cm_cohoupd

params_upd<-params_e1
  
params_upd@species_params$biomass_observed[1:25]<- c(
45458680000.00,
139582870000.00,
124791870000.00,
1533897570.00,
1207642280.00,
554290892.00,
958399600.00,
17640715150.00,
17531856000.00,
2585437994.00,
2090364063.00,
915696090.75,
963927418.67,
125724786263.13,
1510450000.00,
8032990000.00,
39532000000.00,
9582348000.00,
2354170200.00,
5584788000.00,
2894531000.00,
609420000.00,
233170000.00,
180281500.00,
99766800.00)

initial_effort(params_upd)<-1
gear_params(params_upd)<-gear_params2011_allfisheries_250521
params_upd<- setParams(params_upd)
params_upd<- setFishing(params_upd)
initial_effort(params_upd)<-1

 params_upd <-  params_upd |> steady() |> 
   matchBiomasses() |> steady() |> matchBiomasses() |> steady() |> 
      matchBiomasses() |> steady() |>  matchBiomasses() |> steady() |> matchBiomasses() |> steady()|> 
     matchBiomasses() |> steady() |>  matchBiomasses() |> steady() |> matchBiomasses() |> steady() |> 
      matchBiomasses() |> steady() |>  matchBiomasses() |> steady() |> matchBiomasses() |> steady() 

 species_params(params_upd)
 
  sim_fish1upd<- project(params_upd, t_max = 100,  t_save=5)
#animateSpectra(sim_fish, power = 2)
 plotlyBiomassRelative(sim_fish1upd)

```

## TUNE RESILIENCE 1

```{r}
cm1<-tuned_params3
cm1 <- setBevertonHolt(cm1, erepro = 0.7)
species_params(cm1) |> select(erepro, R_max)
getRDI(cm1) / getRDD(cm1)

plotSpectra(cm1, power = 2            )
```

Setting generic gear selectivity If you have system specific data on how
changes in fishing under system specific gear parameters change species
biomasses, you should use these system specific details. We do not have
such data for Curonian Lagoon, so we will explore species responses in
general. For that purpose, for this exploration of the resilience of
species, we set the gear parameters in such a way that all species are
fished similarly.

Our current gear parameters are set for a specific commercial fishery,
which selects some species but does not catch smallfish and almost no
ruffe. For smaller fish they target only adults and for largest fish
they also target juveniles. Thus the fishing mortality this gear imposes
on the different species is not suited to assess resilience equally for
all species.

To tune the resilience of each species to extra mortality we will set
catchability of all species to 1, so that effort values directly reflect
fishing mortality. We will also set gear 50% selectivity to half the
maturation length of each species and 25% selection to half the 25%
maturation length.

Gear selectivity parameters are defined by length, so we will first
convert w_mat and w_mat25 to length values.

```{r}
weight_to_length <- function(w, cm1) {
    a <- species_params(cm1)$a
    b <- species_params(cm1)$b
    (w / a) ^ (1 / b)
}

l_mat = weight_to_length(species_params(cm1)$w_mat, cm1)
l_25mat = weight_to_length(species_params(cm1)$w_mat25, cm1)

```

We assign the model that uses these new gear parameters in a new
variable cm_generic_gear so that we can keep the old model around.

```{r}
# We start with the current gear parameters
gp <- gear_params(cm1)
# and update values in l50 and l25 columns
gp$l50 <- l_mat / 2
gp$l25 <- l_25mat / 2
# and set all catchability to 1
gp$catchability <- 1


cm1_generic_gear <- params_e3
# Set new gear parameters for the new model 
gear_params(cm1_generic_gear) <- gp
plotFMort(cm1_generic_gear)
```

As always after having changed model parameters, we need to bring the
model to steady state again.

```{r}
cm1_generic_gear <- steady(cm1_generic_gear)
```

```{r}
#cm1_generic_gear <-  cm1_generic_gear |> 
#  matchBiomasses() |> steady() |> matchBiomasses() |> steady() |>
#   matchBiomasses() |> steady() |> matchBiomasses() |> steady() 
```

Exploring yield curves To measure the resilience of our species to
fishing, we will change the fishing mortality for one species at a time
and check how their yields, spawning-stock biomasses (SSB) and
reproduction rate (RDD) change in response. We keep the fishing
mortality for the other species fixed. For our selected species we run
through a range of fishing mortalities between 0 and a maximum. For each
fishing mortality we run the projection until the system has settled
down to a new steady state. Then we calculates the yield, the spawning
stock biomass SSB and the reproduction rate RDD in that steady state.
After doing that for all fishing mortalities we can plot all the results
in a graph. The plotYieldCurve() function does all that for us. Here we
plot the yield curve for smallfish.

```{r}
# First we save current reproduction level into a vector 
rep_level <- getReproductionLevel(cm1_generic_gear)
```

Pacific_Herring 0.55 Small_Planktivorous_Fish 0.493 Chinook_Hatch_Adult
0.78 Chinook_Wild_Adult 0.78 Coho_Hatch_Adult 0.5-0.69 Coho_Wild_Adult
0.5-0.69 Chum_Adult\
Sockeye_Adult\
Chinook_Hatch_Resident 0.78 Chinook_Wild_Resident 0.78
Coho_Hatch_Resident 0.5-0.69 Coho_Wild_Resident 0.5-0.69 Hake 0.4-0.45
Lingcod 0.45 Rockfish 0.5 Other_fish 0.7 Halibut 0.4

```{r}
library(mizerMR)
plotYieldVsF(cm1_generic_gear, species = "Pacific_Herring", F_max = 2)
getReproductionLevel(cm1_generic_gear)["Pacific_Herring"]
```

FMSY for herring is 0.5 - should be between 0.2 and 1

We do not know how much we need to reduce the reproduction level to get
a sufficiently low F MSY . We just try some values. Let’s try 0.3.

```{r}

# then we replace our species' reproduction level with a new value 
rep_level["Pacific_Herring"] <- 0.5
# and asign it back to the model 
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)

# and plot F curves again
plotYieldVsF(cm1_generic_gear, species = "Pacific_Herring", F_max = 1)
```

next species

```{r}
plotYieldVsF(cm1_generic_gear, species = "Invertebrates", F_max = 2)
getReproductionLevel(cm1_generic_gear)["Invertebrates"]
```

```{r}

# then we replace our species' reproduction level with a new value 
rep_level["Invertebrates"] <- 0.3
# and asign it back to the model 
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)

# and plot F curves again
plotYieldVsF(cm1_generic_gear, species = "Invertebrates", F_max = 1)
```

```{r}
plotYieldVsF(cm1_generic_gear, species = "Small_Planktivorous_Fish", F_max = 2)
getReproductionLevel(cm1_generic_gear)["Small_Planktivorous_Fish"]

```

too high - also reduce

```{r}

# then we replace our species' reproduction level with a new value 
rep_level["Small_Planktivorous_Fish"] <- 0.5
# and asign it back to the model 
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)

# and plot F curves again
plotYieldVsF(cm1_generic_gear, species = "Small_Planktivorous_Fish", F_max = 1)
```

```{r}
plotYieldVsF(cm1_generic_gear, species = "Hake", F_max = 1)
```

```{r}

# then we replace our species' reproduction level with a new value 
rep_level["Hake"] <- 0.45
# and asign it back to the model 
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)

# and plot F curves again
plotYieldVsF(cm1_generic_gear, species = "Hake", F_max = 1)
```

```{r}
plotYieldVsF(cm1_generic_gear, species = "Lingcod", F_max = 1)
```

```{r}

# then we replace our species' reproduction level with a new value 
rep_level["Lingcod"] <- 0.
# and asign it back to the model 
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)

# and plot F curves again
plotYieldVsF(cm1_generic_gear, species = "Lingcod", F_max = 1)
```

```{r}
plotYieldVsF(cm1_generic_gear, species = "Rockfish", F_max = 1)
```

```{r}

# then we replace our species' reproduction level with a new value 
rep_level["Rockfish"] <- 0.3
# and asign it back to the model 
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)

# and plot F curves again
plotYieldVsF(cm1_generic_gear, species = "Rockfish", F_max = 1)
```

```{r}
plotYieldVsF(cm1_generic_gear, species = "Halibut", F_max = 1)
```

```{r}

# then we replace our species' reproduction level with a new value 
rep_level["Halibut"] <- 0.35
# and asign it back to the model 
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)

# and plot F curves again
plotYieldVsF(cm1_generic_gear, species = "Halibut", F_max = 1)
```

```{r}
plotYieldVsF(cm1_generic_gear, species = "Chinook_Hatch_Adult", F_max = 1)
```

```{r}

# then we replace our species' reproduction level with a new value 
rep_level["Chinook_Hatch_Adult"] <- 0.4
# and asign it back to the model 
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)

# and plot F curves again
plotYieldVsF(cm1_generic_gear, species = "Chinook_Hatch_Adult", F_max = 1)
```

```{r}
plotYieldVsF(cm1_generic_gear, species = "Coho_Hatch_Adult", F_max = 1)
```

```{r}

# then we replace our species' reproduction level with a new value 
rep_level["Coho_Hatch_Adult"] <- 0.6
# and asign it back to the model 
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)

# and plot F curves again
plotYieldVsF(cm1_generic_gear, species = "Coho_Hatch_Adult", F_max = 1)
```

```{r}
plotYieldVsF(cm1_generic_gear, species = "Coho_Wild_Adult", F_max = 1)
```

```{r}

# then we replace our species' reproduction level with a new value 
rep_level["Coho_Wild_Adult"] <- 0.6
# and asign it back to the model 
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)

# and plot F curves again
plotYieldVsF(cm1_generic_gear, species = "Coho_Wild_Adult", F_max = 1)
```

```{r}
plotYieldVsF(cm1_generic_gear, species = "Chinook_Hatch_Resident", F_max = 1)
rep_level["Chinook_Hatch_Resident"]
```

```{r}

# then we replace our species' reproduction level with a new value 
rep_level["Chinook_Hatch_Resident"] <- 0.78
# and asign it back to the model 
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)

# and plot F curves again
plotYieldVsF(cm1_generic_gear, species = "Chinook_Hatch_Resident", F_max = 1)
```

```{r}
plotYieldVsF(cm1_generic_gear, species = "Chinook_Wild_Resident", F_max = 1)
rep_level["Chinook_Wild_Resident"]
```

```{r}

# then we replace our species' reproduction level with a new value 
rep_level["Chinook_Wild_Resident"] <- 0.78
# and asign it back to the model 
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)

# and plot F curves again
plotYieldVsF(cm1_generic_gear, species = "Chinook_Wild_Resident", F_max = 1)
```

```{r}

# then we replace our species' reproduction level with a new value 
rep_level["Coho_Hatch_Resident"] <- 0.6
# and asign it back to the model 
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)

# and plot F curves again
plotYieldVsF(cm1_generic_gear, species = "Coho_Hatch_Resident", F_max = 1)
```

```{r}
plotYieldVsF(cm1_generic_gear, species = "Coho_Wild_Resident", F_max = 1)
rep_level["Coho_Wild_Resident"]
```

```{r}

# then we replace our species' reproduction level with a new value 
rep_level["Coho_Wild_Resident"] <- 0.6
# and asign it back to the model 
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)

# and plot F curves again
plotYieldVsF(cm1_generic_gear, species = "Coho_Wild_Resident", F_max = 1)
```

```{r}
plotYieldVsF(cm1_generic_gear, species = "Other_fish", F_max = 1)
rep_level["Other_fish"]
```

```{r}

# then we replace our species' reproduction level with a new value 
rep_level["Other_fish"] <-   0.4
# and asign it back to the model 
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)

# and plot F curves again
plotYieldVsF(cm1_generic_gear, species = "Other_fish", F_max = 1)
```

##################### 

##Set new reproduction levels Above we studied the resilience of species
to changes in their mortality imposed by an artificial fishing gear. We
used guidance from a classification of species into resilience classes
and the expected F MSY derived from very simple single-species models to
adjust the reproduction levels for our species. Now we will use those
reproduction levels in our model with the original gear parameters.

```{r}
cm1 <- setBevertonHolt(cm1, reproduction_level = rep_level)
# Yield curve with the commercial gear
#plotYieldVsF(cm1, species = "Pacific_Herring", F_max = 1)
# Yield curve with generic gear
#plotYieldVsF(cm1_generic_gear, species = "Pacific_Herring", F_max = 1)
```

Why the difference? Let’s look how the original gear parameters differ
from our generic set

```{r}
c(l_mat = l_mat[2], 
  l50_commercial = gear_params(cm1)$l50[2],
  l50_generic = gear_params(cm1_generic_gear)$l50[2])
```

```{r}
saveParams(cm1, "cur_model_resilient_tunedMay25c.rds")
dfcm1<-(species_params(cm1))

write.csv(dfcm1, "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_Jan25/ss_mizerout2011_pars_250523_fishing1_restune3.csv")
saveParams(cm1, "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_Jan25/ss_mizerout2011_pars_250523_fishing1_restune3.rds")
```
