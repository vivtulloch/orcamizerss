---
title: "Orca_tuneparams_May24"
author: "Viv Tulloch"
date: "2024-05-21"
output:
  pdf_document: default
  html_document: default
editor_options: 
  markdown: 
    wrap: 72
---

## Create a mizer model

```{r message=FALSE}
remotes::install_github("sizespectrum/mizerExperimental")
library(mizerExperimental)
remotes::install_github("sizespectrum/mizerMR")
library(mizerMR)
library(tidyverse)
#rm(cur_model_steady)
```

```{r}
#oprn model 
ss_species_params <-   read.csv(
  "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_Nov24/pars_241212/ss_pars_2011_241212_2.csv")

ss_gear_params<-read.csv("/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_Nov24/pars_241212/ss_gear_2011_241212.csv")

## interaction matrix set to 0,1 - need to modify this based on prey preferences
ss_interaction <-   read.csv(
    "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_Nov24/pars_241212/ss_mizer_interaction_241212.csv", row.names=1)

#read in time-averaged  catches 
#params<- cur_model
#cdat<-read.csv(
#  "C:/Users/vtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Puget_Sound/spp_Aug2023_CM/05_fisheries/ts_fishe#ries_rev_avyield_addtrans.csv") ### units: tonnes


```

## setting fishing effort to 1, so that catchability = fishing mortality

```{r}
cur_model <- newMultispeciesParams(species_params = ss_species_params, 
                                   interaction = ss_interaction, 
                                   gear_params = ss_gear_params,
                                  initial_effort = 1,
                                   lambda = 2.05, n=0.75,  p = 0.75, w_pp_cutoff = 50, kappa = 2372072334750
                                   )
```

**Step 2: Project to steady state**

```{r}
#rm(cur_model_steady)
cur_model_steady <- steady(cur_model)
species_params(cur_model_steady)
plotlySpectra(cur_model_steady, power = 2)
```

**Step 3: Calibrate the scale** **Step 4: Rescale species spectra**

```{r}
cur_model <- calibrateBiomass(cur_model_steady)
plotBiomassVsSpecies(cur_model)
cur_model <- matchBiomasses(cur_model)
plotBiomassVsSpecies(cur_model)
species_params(cur_model)
```

Step 5: Rinse and repeat

Rescaling the spectra of the individual species has not created another
steady state. All species now experience a new prey distribution and a
new predator distribution and so their growth and death rates have
changed, which requires us to run the dynamics again to find the new
steady state. So we essentially go back to step 2 and project to steady
state:

```{r}
cur_model <- cur_model |>
     matchBiomasses() |> steady() |> matchBiomasses() |> steady() |>
   matchBiomasses() |> steady() |> matchBiomasses() |> steady() 
```

```{r}
cur_model <- cur_model |>
  matchBiomasses() |> steady() |> matchBiomasses() |> steady() |>
  matchBiomasses() |> steady() |> matchBiomasses() |> steady() |>
 matchBiomasses() |> steady() |> matchBiomasses() |> steady() |>
matchBiomasses() |> steady() |> matchBiomasses() |> steady() 

```

```{r}
#species_params(ss_mizerout1979_pars_240521_fishing075)
```

```{r}
#plotBiomassVsSpecies(cur_model)
plotSpectra(cur_model, power = 2            )

```

plot works? YAAAAAAAAAAAAA

```{r}

plotDiet(cur_model)#, species = "California_sea_lions")
plotGrowthCurves(cur_model, species_panel = TRUE)
plotlyFeedingLevel(cur_model)
getReproductionLevel(cur_model)
species_params(cur_model)
```

tuneParams(cur_model)

```{r}
tuned_model <- readRDS("~/Downloads/tuned_params (51).rds")
tuneParams(tuned_model)

```

```{r}
tuned_model <- readRDS("~/Downloads/tuned_params (59).rds")
dft1<-species_params(tuned_model)
species_params(tuned_model)
getReproductionLevel(tuned_model)
plotDiet(tuned_model)#, species = "California_sea_lions")
plotGrowthCurves(tuned_model, species_panel = TRUE)
plotlyFeedingLevel(tuned_model)

```

```{r}
tuned_model@resource_params$kappa
tuned_model@species_params$biomass_model[5]
```

```{r}
 sim1 <- project(tuned_model, effort = 1, t_max = 30, t_save=3)
 plot(sim1)
 
 animateSpectra(sim1, total = TRUE, power = 1)#, 
               #ylim = c(1e-8, NA), wlim = c(1e-3, NA))
 plotlyBiomassRelative(sim1)

```

tuneParams(tuned_model)

```{r}
saveParams(tuned_model, "ss_mizerout2011_pars_241212_fishing1.rds")
dfnew<-(species_params(tuned_model))

write.csv(dfnew, "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_Nov24/pars_241212/ss_mizerout2011_pars_241212_fishing1.csv")
saveParams(tuned_model, "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_Nov24/pars_241212/ss_mizerout2011_pars_241212_fishing1.rds")
```

```{r}
try(unload("mizerExperimental"), silent = TRUE)
remotes::install_github("sizespectrum/mizerExperimental", quiet = TRUE)
library(mizerExperimental)
library(tidyverse)
cur_model<- readRDS("~/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_Jan25/ss_mizerout2011_pars_250317_fishing1_updfmort_allsteady.rds")
```

```{r}
cur_model <- newMultispeciesParams(species_params = ss_species_params, 
                                   interaction = ss_interaction,
                                   gear_params = ss_gear_params,
                                  initial_effort = 1,
                                   lambda = 2.05, n=0.75,  p = 0.75, w_pp_cutoff = 50, kappa = 430335921965
                                   )
```

new kappa = 160444035711.701

#####22 APRIL 2025

```{r}
plot1<- plotDiet(params_e1)#, species = "California_sea_lions")
plot2<-plotGrowthCurves(params_e1, species_panel = TRUE)
plot3<-plotlyFeedingLevel(params_e1)

saveParams(params_e1, "cur_model_resilient_tuned_250422.rds")
dfcm4a<-(species_params(params_e1))

write.csv(dfcm4a, "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_Nov24/pars_241212/ss_mizerout2011_pars_250422_fishing1_restune_upd.csv")
saveParams(params_e1, "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_Jan25/ss_mizerout2011_pars_250422_fishing1_restune_upd.rds")
```

```{r}

sim2<- project(params_e1, t_max = 100,  t_save=5)
animateSpectra(sim2, power = 2)
plotlyBiomassRelative(sim2)
 

```

```{r}

sim10<- project(params_e1, effort=0,t_max = 100,  t_save=5)
animateSpectra(sim10, power = 2)
plotlyBiomassRelative(sim10 )
 

```

###HERE 23 May 2025

ADD NEW GEARS ADD NEW BIOMASS

HINDCAST

REDUCE EREPRO FOR SALMON

##New biomass, new catches

```{r}


#new gear and effort that splits canadian and US fisheries
gear_params2011_allfisheries_250521 <- read.csv("~/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/fisheries/time series fisheries/gear_params2011_allfisheries_250521.csv")

```

```{r}
#new_model <- cm_cohoupd

params_upd<-params_e1
  
params_upd@species_params$biomass_observed[1:25]<- c(
45458680000.00,
139582870000.00,
124791870000.00,
1533897570.00,
1207642280.00,
554290892.00,
958399600.00,
17640715150.00,
17531856000.00,
2585437994.00,
2090364063.00,
915696090.75,
963927418.67,
125724786263.13,
1510450000.00,
8032990000.00,
39532000000.00,
9582348000.00,
2354170200.00,
5584788000.00,
2894531000.00,
609420000.00,
233170000.00,
180281500.00,
99766800.00)

initial_effort(params_upd)<-1
gear_params(params_upd)<-gear_params2011_allfisheries_250521
params_upd<- setParams(params_upd)
params_upd<- setFishing(params_upd)
initial_effort(params_upd)<-1

 params_upd <-  params_upd |> steady() |> 
   matchBiomasses() |> steady() |> matchBiomasses() |> steady() |> 
      matchBiomasses() |> steady() |>  matchBiomasses() |> steady() |> matchBiomasses() |> steady()|> 
     matchBiomasses() |> steady() |>  matchBiomasses() |> steady() |> matchBiomasses() |> steady() |> 
      matchBiomasses() |> steady() |>  matchBiomasses() |> steady() |> matchBiomasses() |> steady() 

 species_params(params_upd)
 
  sim_fish1upd<- project(params_upd, t_max = 100,  t_save=5)
#animateSpectra(sim_fish, power = 2)
 plotlyBiomassRelative(sim_fish1upd)

```

## TUNE RESILIENCE 1

```{r}
cm1<-tuned_params3
cm1 <- setBevertonHolt(cm1, erepro = 0.7)
species_params(cm1) |> select(erepro, R_max)
getRDI(cm1) / getRDD(cm1)

plotSpectra(cm1, power = 2            )
```

Setting generic gear selectivity If you have system specific data on how
changes in fishing under system specific gear parameters change species
biomasses, you should use these system specific details. We do not have
such data for Curonian Lagoon, so we will explore species responses in
general. For that purpose, for this exploration of the resilience of
species, we set the gear parameters in such a way that all species are
fished similarly.

Our current gear parameters are set for a specific commercial fishery,
which selects some species but does not catch smallfish and almost no
ruffe. For smaller fish they target only adults and for largest fish
they also target juveniles. Thus the fishing mortality this gear imposes
on the different species is not suited to assess resilience equally for
all species.

To tune the resilience of each species to extra mortality we will set
catchability of all species to 1, so that effort values directly reflect
fishing mortality. We will also set gear 50% selectivity to half the
maturation length of each species and 25% selection to half the 25%
maturation length.

Gear selectivity parameters are defined by length, so we will first
convert w_mat and w_mat25 to length values.

```{r}
weight_to_length <- function(w, cm1) {
    a <- species_params(cm1)$a
    b <- species_params(cm1)$b
    (w / a) ^ (1 / b)
}

l_mat = weight_to_length(species_params(cm1)$w_mat, cm1)
l_25mat = weight_to_length(species_params(cm1)$w_mat25, cm1)

```

We assign the model that uses these new gear parameters in a new
variable cm_generic_gear so that we can keep the old model around.

```{r}
# We start with the current gear parameters
gp <- gear_params(cm1)
# and update values in l50 and l25 columns
gp$l50 <- l_mat / 2
gp$l25 <- l_25mat / 2
# and set all catchability to 1
gp$catchability <- 1


cm1_generic_gear <- params_e3
# Set new gear parameters for the new model 
gear_params(cm1_generic_gear) <- gp
plotFMort(cm1_generic_gear)
```

As always after having changed model parameters, we need to bring the
model to steady state again.

```{r}
cm1_generic_gear <- steady(cm1_generic_gear)
```

```{r}
#cm1_generic_gear <-  cm1_generic_gear |> 
#  matchBiomasses() |> steady() |> matchBiomasses() |> steady() |>
#   matchBiomasses() |> steady() |> matchBiomasses() |> steady() 
```

Exploring yield curves To measure the resilience of our species to
fishing, we will change the fishing mortality for one species at a time
and check how their yields, spawning-stock biomasses (SSB) and
reproduction rate (RDD) change in response. We keep the fishing
mortality for the other species fixed. For our selected species we run
through a range of fishing mortalities between 0 and a maximum. For each
fishing mortality we run the projection until the system has settled
down to a new steady state. Then we calculates the yield, the spawning
stock biomass SSB and the reproduction rate RDD in that steady state.
After doing that for all fishing mortalities we can plot all the results
in a graph. The plotYieldCurve() function does all that for us. Here we
plot the yield curve for smallfish.

```{r}
# First we save current reproduction level into a vector 
rep_level <- getReproductionLevel(cm1_generic_gear)
```

Pacific_Herring 0.55 Small_Planktivorous_Fish 0.493 Chinook_Hatch_Adult
0.78 Chinook_Wild_Adult 0.78 Coho_Hatch_Adult 0.5-0.69 Coho_Wild_Adult
0.5-0.69 Chum_Adult\
Sockeye_Adult\
Chinook_Hatch_Resident 0.78 Chinook_Wild_Resident 0.78
Coho_Hatch_Resident 0.5-0.69 Coho_Wild_Resident 0.5-0.69 Hake 0.4-0.45
Lingcod 0.45 Rockfish 0.5 Other_fish 0.7 Halibut 0.4

```{r}
library(mizerMR)
plotYieldVsF(cm1_generic_gear, species = "Pacific_Herring", F_max = 2)
getReproductionLevel(cm1_generic_gear)["Pacific_Herring"]
```

FMSY for herring is 0.5 - should be between 0.2 and 1

We do not know how much we need to reduce the reproduction level to get
a sufficiently low F MSY . We just try some values. Let’s try 0.3.

```{r}

# then we replace our species' reproduction level with a new value 
rep_level["Pacific_Herring"] <- 0.5
# and asign it back to the model 
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)

# and plot F curves again
plotYieldVsF(cm1_generic_gear, species = "Pacific_Herring", F_max = 1)
```

next species

```{r}
plotYieldVsF(cm1_generic_gear, species = "Invertebrates", F_max = 2)
getReproductionLevel(cm1_generic_gear)["Invertebrates"]
```

```{r}

# then we replace our species' reproduction level with a new value 
rep_level["Invertebrates"] <- 0.3
# and asign it back to the model 
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)

# and plot F curves again
plotYieldVsF(cm1_generic_gear, species = "Invertebrates", F_max = 1)
```

```{r}
plotYieldVsF(cm1_generic_gear, species = "Small_Planktivorous_Fish", F_max = 2)
getReproductionLevel(cm1_generic_gear)["Small_Planktivorous_Fish"]

```

too high - also reduce

```{r}

# then we replace our species' reproduction level with a new value 
rep_level["Small_Planktivorous_Fish"] <- 0.5
# and asign it back to the model 
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)

# and plot F curves again
plotYieldVsF(cm1_generic_gear, species = "Small_Planktivorous_Fish", F_max = 1)
```

```{r}
plotYieldVsF(cm1_generic_gear, species = "Hake", F_max = 1)
```

```{r}

# then we replace our species' reproduction level with a new value 
rep_level["Hake"] <- 0.45
# and asign it back to the model 
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)

# and plot F curves again
plotYieldVsF(cm1_generic_gear, species = "Hake", F_max = 1)
```

```{r}
plotYieldVsF(cm1_generic_gear, species = "Lingcod", F_max = 1)
```

```{r}

# then we replace our species' reproduction level with a new value 
rep_level["Lingcod"] <- 0.
# and asign it back to the model 
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)

# and plot F curves again
plotYieldVsF(cm1_generic_gear, species = "Lingcod", F_max = 1)
```

```{r}
plotYieldVsF(cm1_generic_gear, species = "Rockfish", F_max = 1)
```

```{r}

# then we replace our species' reproduction level with a new value 
rep_level["Rockfish"] <- 0.3
# and asign it back to the model 
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)

# and plot F curves again
plotYieldVsF(cm1_generic_gear, species = "Rockfish", F_max = 1)
```

```{r}
plotYieldVsF(cm1_generic_gear, species = "Halibut", F_max = 1)
```

```{r}

# then we replace our species' reproduction level with a new value 
rep_level["Halibut"] <- 0.35
# and asign it back to the model 
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)

# and plot F curves again
plotYieldVsF(cm1_generic_gear, species = "Halibut", F_max = 1)
```

```{r}
plotYieldVsF(cm1_generic_gear, species = "Chinook_Hatch_Adult", F_max = 1)
```

```{r}

# then we replace our species' reproduction level with a new value 
rep_level["Chinook_Hatch_Adult"] <- 0.4
# and asign it back to the model 
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)

# and plot F curves again
plotYieldVsF(cm1_generic_gear, species = "Chinook_Hatch_Adult", F_max = 1)
```

```{r}
plotYieldVsF(cm1_generic_gear, species = "Coho_Hatch_Adult", F_max = 1)
```

```{r}

# then we replace our species' reproduction level with a new value 
rep_level["Coho_Hatch_Adult"] <- 0.6
# and asign it back to the model 
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)

# and plot F curves again
plotYieldVsF(cm1_generic_gear, species = "Coho_Hatch_Adult", F_max = 1)
```

```{r}
plotYieldVsF(cm1_generic_gear, species = "Coho_Wild_Adult", F_max = 1)
```

```{r}

# then we replace our species' reproduction level with a new value 
rep_level["Coho_Wild_Adult"] <- 0.6
# and asign it back to the model 
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)

# and plot F curves again
plotYieldVsF(cm1_generic_gear, species = "Coho_Wild_Adult", F_max = 1)
```

```{r}
plotYieldVsF(cm1_generic_gear, species = "Chinook_Hatch_Resident", F_max = 1)
rep_level["Chinook_Hatch_Resident"]
```

```{r}

# then we replace our species' reproduction level with a new value 
rep_level["Chinook_Hatch_Resident"] <- 0.78
# and asign it back to the model 
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)

# and plot F curves again
plotYieldVsF(cm1_generic_gear, species = "Chinook_Hatch_Resident", F_max = 1)
```

```{r}
plotYieldVsF(cm1_generic_gear, species = "Chinook_Wild_Resident", F_max = 1)
rep_level["Chinook_Wild_Resident"]
```

```{r}

# then we replace our species' reproduction level with a new value 
rep_level["Chinook_Wild_Resident"] <- 0.78
# and asign it back to the model 
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)

# and plot F curves again
plotYieldVsF(cm1_generic_gear, species = "Chinook_Wild_Resident", F_max = 1)
```

```{r}

# then we replace our species' reproduction level with a new value 
rep_level["Coho_Hatch_Resident"] <- 0.6
# and asign it back to the model 
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)

# and plot F curves again
plotYieldVsF(cm1_generic_gear, species = "Coho_Hatch_Resident", F_max = 1)
```

```{r}
plotYieldVsF(cm1_generic_gear, species = "Coho_Wild_Resident", F_max = 1)
rep_level["Coho_Wild_Resident"]
```

```{r}

# then we replace our species' reproduction level with a new value 
rep_level["Coho_Wild_Resident"] <- 0.6
# and asign it back to the model 
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)

# and plot F curves again
plotYieldVsF(cm1_generic_gear, species = "Coho_Wild_Resident", F_max = 1)
```

```{r}
plotYieldVsF(cm1_generic_gear, species = "Other_fish", F_max = 1)
rep_level["Other_fish"]
```

```{r}

# then we replace our species' reproduction level with a new value 
rep_level["Other_fish"] <-   0.4
# and asign it back to the model 
cm1_generic_gear <- setBevertonHolt(cm1_generic_gear, 
                                   reproduction_level = rep_level)

# and plot F curves again
plotYieldVsF(cm1_generic_gear, species = "Other_fish", F_max = 1)
```

##################### 

##Set new reproduction levels Above we studied the resilience of species
to changes in their mortality imposed by an artificial fishing gear. We
used guidance from a classification of species into resilience classes
and the expected F MSY derived from very simple single-species models to
adjust the reproduction levels for our species. Now we will use those
reproduction levels in our model with the original gear parameters.

```{r}
cm1 <- setBevertonHolt(cm1, reproduction_level = rep_level)
# Yield curve with the commercial gear
#plotYieldVsF(cm1, species = "Pacific_Herring", F_max = 1)
# Yield curve with generic gear
#plotYieldVsF(cm1_generic_gear, species = "Pacific_Herring", F_max = 1)
```

Why the difference? Let’s look how the original gear parameters differ
from our generic set

```{r}
c(l_mat = l_mat[2], 
  l50_commercial = gear_params(cm1)$l50[2],
  l50_generic = gear_params(cm1_generic_gear)$l50[2])
```

```{r}
saveParams(cm1, "cur_model_resilient_tunedMay25c.rds")
dfcm1<-(species_params(cm1))

write.csv(dfcm1, "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_Jan25/ss_mizerout2011_pars_250523_fishing1_restune3.csv")
saveParams(cm1, "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_Jan25/ss_mizerout2011_pars_250523_fishing1_restune3.rds")
```

##Scenario 1: Change fishing effort The first option most users want to
explore is to see what happens if we start fishing more or if we reduce
fishing mortality. We will use our Curonian model with tuned
reproduction and change the total fishing effort. We will run the
simulation with the changed effort long enough so that it again settles
down to a steady state and then look at how the system evolved over this
time period.

```{r}
initial_effort(cm1)
# Keep reproduction constant at the initial level
cm1@species_params$constant_reproduction <- getRDD(cm1)
cm1const <- setReproduction(cm1, RDD = "constantRDD")


# Run the dynamics with this constant reproduction
simt1 <- project(cm1const, t_max = 100,effort=1, t_save=0.25)
#animateSpectra(simt1, power = 2)
 plotlyBiomassRelative(simt1)
 plotlySpectra(cm1const)
```

```{r}
#no effort

# Run the dynamics with this constant reproduction
simt1_redu <- project(cm1const, effort =0, t_max = 100,t_save=5)
#animateSpectra(simt1_redu, power = 2)
 plotlyBiomassRelative(simt1_redu)
```

```{r}
params_e3<-cm1const
#params_e3<-cm1
#species_params(params_e3)$gamma[6] <- species_params(params_e3)$gamma[6] *.8
species_params(params_e3)$gamma[4] <- species_params(params_e3)$gamma[4] *1.8
species_params(params_e3)$h[4] <- species_params(params_e3)$h[4] *1.04
#species_params(params_e3)$r_max[4] <- species_params(params_e3)$r_max[4]*100

species_params(params_e3)$gamma[14] <- species_params(params_e3)$gamma[14] *1.01

species_params(params_e3)$gamma[15] <- species_params(params_e3)$gamma[15] *1.05
species_params(params_e3)$h[15] <- species_params(params_e3)$h[15]*1.05

#reduce h - line goes up
#reduce gamma = line goes down

#increase gamma - line goes up

params_e3<- setParams(params_e3)


params_e3 <-  params_e3 |> steady() |> 
  matchBiomasses() |> steady() #|> matchBiomasses() |> steady()

 species_params(params_e3)
  plotGrowthCurves(params_e3, species_panel = TRUE)
  plotlyFeedingLevel(params_e3)
 
simte3 <- project(params_e3, effort=1, t_max = 100, t_save=5)
plotlyBiomassRelative(simte3)


 simte30 <- project(params_e3, effort=0, t_max = 100, t_save=5)
plotlyBiomassRelative(simte30)

```

```{r}
saveParams(params_e3, "cur_model_resilient_tunedMay25d.rds")
dfcm1<-(species_params(params_e3))

write.csv(dfcm1, "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_Jan25/ss_mizerout2011_pars_250523_fishing1_restune4.csv")
saveParams(params_e3, "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_Jan25/ss_mizerout2011_pars_250523_fishing1_restune4.rds")
```

```{r}
cm1@resource_params$kappa
#params_e4a@species_params$biomass_model[5]
```

```{r}

# then we replace our species' reproduction level with a new value 
rep_level["Other_fish"] <- 0.85
rep_level["Chinook_Hatch_Adult"] <- 0.4
rep_level["Invertebrates"] <- 0.6
rep_level["Hake"] <- 0.35
params_e3d <- setBevertonHolt(params_e3, reproduction_level = rep_level)

#params_e3d <- params_e3
species_params(params_e3d)$gamma[4] <- species_params(params_e3d)$gamma[4] *1.8
species_params(params_e3d)$h[4] <- species_params(params_e3d)$h[4] *1.04

#species_params(params_e3d)$erepro[4] <- 0.1
species_params(params_e3d)$gamma[14] <- species_params(params_e3d)$gamma[14]*1.04
species_params(params_e3d)$h[14] <- species_params(params_e3d)$h[14]*1.01

species_params(params_e3d)$gamma[23:24] <- species_params(params_e3d)$gamma[23:24]*0.9
species_params(params_e3d)$gamma[23:24] <- species_params(params_e3d)$gamma[23:24]*0.98

params_e3d<- setParams(params_e3d)
 
 params_e3d <-  params_e3d |> steady() |> 
 #  matchBiomasses() |> steady() |> matchBiomasses() |> steady() |> 
 # matchBiomasses() |> steady() |>  matchBiomasses() |> steady() |> 
 #     matchBiomasses() |> steady() |>  matchBiomasses() |> steady() |> 
#      matchBiomasses() |> steady() |>  matchBiomasses() |> steady() |> 
      matchBiomasses() |> steady() |>  matchBiomasses() |> steady() |> matchBiomasses() |> steady() 
 
#reduce h - line goes up
#reduce gamma = line goes down
#increase gamma - line goes up
 
 getReproductionLevel(params_e3d)
plotGrowthCurves(params_e3d, species_panel = TRUE)
plotlyFeedingLevel(params_e3d)

 species_params(params_e3d)
 
   simte30 <- project(params_e3d, t_max = 100, effort=0,t_save=5)
#animateSpectra(simte3, power = 2)
 plotlyBiomassRelative(simte30)
 
 simte3 <- project(params_e3d, t_max = 100, effort=1, t_save=5)
#animateSpectra(simte3, power = 2)
 plotlyBiomassRelative(simte3)
 


```



##### Setting up and running the historical simulation


```{r}
gear_params2011_allfisheries_250521 <- read.csv("~/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/fisheries/time series fisheries/gear_params2011_allfisheries_250521.csv")

new_model <- params_e3d

species_params(new_model)$gamma[25] <- species_params(new_model)$gamma[25] *1.05
species_params(new_model)$h[25] <- species_params(new_model)$h[25] *1.05

species_params(new_model)$gamma[19] <- species_params(new_model)$gamma[19] *1.5
species_params(new_model)$h[19] <- species_params(new_model)$h[19] *0.7

species_params(new_model)$gamma[4] <- species_params(new_model)$gamma[4] *0.2
species_params(new_model)$h[4] <- species_params(new_model)$h[4] *0.99

species_params(new_model)$gamma[14] <- species_params(new_model)$gamma[14] *0.9
species_params(new_model)$h[14] <- species_params(new_model)$h[14] *0.9

species_params(new_model)$gamma[6:7] <- species_params(new_model)$gamma[6:7] *0.8
species_params(new_model)$h[6:7] <- species_params(new_model)$h[6:7] *0.99

gear_params(new_model)<-gear_params2011_allfisheries_250521
#params_e3b1a<- setParams(params_e3b1a)

new_model<-setParams(new_model)
new_model<- setFishing(new_model, effort=1)
initial_effort(new_model)<-1

 new_model <-  new_model |> steady() |> 
   matchBiomasses() |> steady() 

 species_params(new_model)
 #gear_params(cm_cohoupd)
 getReproductionLevel(new_model)
 plotlyFeedingLevel(new_model)
# plotDiet(cm_fishingupd)
 
 sim_fish<- project(new_model, t_max = 100,effort=1,  t_save=5)
animateSpectra(sim_fish, power = 2)
 plotlyBiomassRelative(sim_fish)


```

#27 May 2025

## final tuning of best model

tuned_model \<- readRDS("\~/Downloads/tuned_params -
2025-05-27T051253.173.rds")

```{r}

#tuned_model2<-tuned_model2save

tuned_model2save<-tuned_model2


species_params(params_high_prod)$erepro[19] <- species_params(params_high_prod)$erepro[19] *1.01

tuned_model2<-setParams(tuned_model2)
tuned_model2<- setFishing(tuned_model2, effort=1)
#initial_effort(new_model)<-1

 tuned_model2 <-  tuned_model2 |> steady() |> matchBiomasses() |> steady() 

 species_params(tuned_model2)
 #gear_params(cm_cohoupd)
 getReproductionLevel(tuned_model2)
 plotlyFeedingLevel(tuned_model2)
 plotGrowthCurves(tuned_model2, species_panel=TRUE)
 
sim_fish<- project(tuned_model2, t_max = 100,effort=1,  t_save=5)
#animateSpectra(sim_fish, power = 2)
 plotlyBiomassRelative(sim_fish)


```

```{r}

tuned_model3<-tuned_model2

species_params(tuned_model3)$erepro[19] <- species_params(tuned_model3)$erepro[19] *1.5

tuned_model3<-setParams(tuned_model3)
tuned_model3<- setFishing(tuned_model3, effort=1)
#initial_effort(new_model)<-1

 tuned_model3 <-  tuned_model3 |> steady() |> matchBiomasses() |> steady() 

 species_params(tuned_model3)
 #gear_params(cm_cohoupd)
 getReproductionLevel(tuned_model3)
 plotlyFeedingLevel(tuned_model3)
 plotGrowthCurves(tuned_model3, species_panel=TRUE)
 
sim_fish3<- project(tuned_model3, t_max = 100,effort=1,  t_save=5)
#animateSpectra(sim_fish, power = 2)
 plotlyBiomassRelative(sim_fish3)


```

### TRY TO RUN HISTORICAL MODEL

```{r}
All_fisheries_effort_array <- as(read.csv("~/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/fisheries/time series fisheries/All_fisheries_effort_array_250526_modhake.csv", row.names = 1), "matrix")

relative_effort <- sweep(All_fisheries_effort_array, 2, All_fisheries_effort_array["2011", ], "/")
relative_effort[as.character(1986:2011), ]
relative_effort[is.nan(relative_effort)] <- 0

#remove years after 2011
new_rel_effort<-head(relative_effort,-7)
```

We could just project forward with these relative efforts. However, the
population dynamics in the early years will be strongly determined by
the initial population abundances (known as the transient behaviour -
essentially the initial behaviour before the long term dynamics are
reached). As this is ecology, we don’t know what the initial abundance
are. One way around this is to project forward at a constant fishing
mortality equal to the mortality in the first historical year until
equilibrium is reached. We then use this steady state as the initial
state for the simulation. This approach reduces the impact of transient
dynamics.

```{r}
#project to zero fishing rate 
new_model_hist0 <- projectToSteady(tuned_model3, effort = 0)
#new_model02 <- projectToSteady(new_model, effort = 0)
```

```{r}
t_per=0.9
#new_rel_effortX<-tail(new_rel_effort,-11)

new_model_hist <- projectToSteady(tuned_model3, 
                                #new_model01,
                                 distance_func = distanceSSLogN,
                                  t_per = 0.5,
                               # t_max = 100,
                              #  dt = 0.1,
                               # return_sim = FALSE,
                               #  progress_bar = TRUE,
                                tol = 0.5 * t_per,
                                effort = new_rel_effort["1986", ])
```

We now have our parameter object and out matrix of efforts relative to
1979. We use this effort matrix as the effort argument to the project()
function. We use dt = 0.25 (the simulation will run faster than with the
default value of 0.1, but tests show that the results are still stable)
and save the results every year.

```{r}
sim_hist <- project(new_model_hist, 
                  #new_model01,
                    effort = new_rel_effort, 
                   # t_max=50, 
                    dt = 0.1, t_save = 1)
plotlyBiomassRelative(sim_hist)
plotYield(sim_hist)
plotlyBiomass(sim_hist)

```

To explore the state of the community it is useful to calculate
indicators of the unexploited community. Therefore we also project
forward to the steady state with 0 fishing effort.

```{r}
sim0 <- project(new_model_hist0, 
                        effort = 0,  
                        t_max=100,
                        return_sim = TRUE)
plotlyBiomassRelative(sim0)
```

```{r}

saveParams(new_model_hist0, "ss_mizerout2011_pars_250527c_newsplitfishing_histeffort.rds")
dfnew<-(species_params(new_model_hist0))

write.csv((species_params(new_model_hist0)), 
          "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_May25/ss_mizerout2011_pars_250527c_newsplitfishing_histeffort.csv")

write.csv((gear_params(new_model_hist0)), 
          "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_May25/ss_mizerout2011_gears_250527c_newsplitfishing_histeffort.csv")
saveParams(new_model_hist0, "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_May25/ss_mizerout2011_pars_250527c_newsplitfishing_histeffort.rds")

```

########### NEED TO INCREASE MARINE MAMMAL PREDS

```{r}

cm_const2<-cm1const

species_params(cm_const2)$erepro[19:21] <- 0.008
species_params(cm_const2)$h[19:21] <- species_params(cm_const2)$h[19:21]*0.5
#species_params(cm_const2)$erepro[22] <- 0.09
species_params(cm_const2)$gamma[22] <- species_params(cm_const2)$gamma[22]*3
species_params(cm_const2)$h[22] <- species_params(cm_const2)$h[22]*1.5
species_params(cm_const2)$erepro[4] <- 0.7
species_params(cm_const2)$gamma[4] <- species_params(cm_const2)$gamma[4]*10
species_params(cm_const2)$h[4] <- species_params(cm_const2)$h[4]*1.2

cm_const2<-setParams(cm_const2)
cm_const2<- setFishing(cm_const2, effort=1)
#initial_effort(new_model)<-1

 cm_const2 <-  cm_const2 |> steady() |> matchBiomasses() |> steady() 
 #     matchBiomasses() |> steady() |>  matchBiomasses() |> steady() |> matchBiomasses() |> steady() |> 
     # matchBiomasses() |> steady() |>  matchBiomasses() |> steady() |> matchBiomasses() |> steady() |> 
    #  matchBiomasses() |> steady() |>  matchBiomasses() |> steady() |> matchBiomasses() |> steady() 

 species_params(cm_const2)
 #gear_params(cm_cohoupd)
 getReproductionLevel(cm_const2)
 plotlyFeedingLevel(cm_const2)
 plotGrowthCurves(cm_const2, species_panel=TRUE)
 
sim_fish3<- project(cm_const2, t_max = 100,effort=1,  t_save=5)
#animateSpectra(sim_fish, power = 2)
 plotlyBiomassRelative(sim_fish3)


```

```{r}

cm_const3<-cm_const2

#species_params(cm_const3)$r_max[19] <- species_params(cm_const3)$r_max[19]*5
species_params(cm_const3)$h[19] <- species_params(cm_const3)$h[19]*1#0.4
species_params(cm_const3)$gamma[19] <- species_params(cm_const3)$gamma[19]* 0.3 #3

#species_params(cm_const2)$erepro[20:21] <- 0.8
species_params(cm_const3)$h[20:21] <- species_params(cm_const3)$h[20:21]*1.4
species_params(cm_const3)$gamma[20:21] <- species_params(cm_const3)$gamma[20:21]*1.3

species_params(cm_const3)$gamma[22] <- species_params(cm_const3)$gamma[22]*0.5
#species_params(cm_const3)$h[22] <- species_params(cm_const3)$h[22]*1.2

species_params(cm_const3)$gamma[4] <- species_params(cm_const3)$gamma[4]/4
species_params(cm_const3)$h[4] <- species_params(cm_const3)$h[4]*1.2

species_params(cm_const3)$gamma[14] <- species_params(cm_const3)$gamma[14]*1.4
species_params(cm_const3)$h[14] <- species_params(cm_const3)$h[14]*1.5

species_params(cm_const3)$gamma[25] <- species_params(cm_const3)$gamma[25]*0.8
species_params(cm_const3)$h[25] <- species_params(cm_const3)$h[25]*1.2

#species_params(cm_const3)$gamma[23:24] <- species_params(cm_const3)$gamma[23:24]*0.5
#species_params(cm_const3)$h[23:24] <- species_params(cm_const3)$h[23:24]*0.5

cm_capacity <- resource_capacity(cm_const3)
cm_const3 <- setResource(cm_const3, 
                    resource_capacity = cm_capacity * 1.2)

cm_const3<-setParams(cm_const3)
cm_const3<- setFishing(cm_const3, effort=1)
#initial_effort(new_model)<-1


 cm_const3 <-  cm_const3 |> steady() |> matchBiomasses() |> steady() #|> 
#  matchBiomasses() |> steady() |>  matchBiomasses() |> steady() |> matchBiomasses() |> steady() 

 species_params(cm_const3)
 #gear_params(cm_cohoupd)
 getReproductionLevel(cm_const3)
 plotlyFeedingLevel(cm_const3)
 plotGrowthCurves(cm_const3, species_panel=TRUE)
 
sim_fish4<- project(cm_const3, t_max = 100,effort=1,  t_save=5)
#animateSpectra(sim_fish, power = 2)
 plotlyBiomassRelative(sim_fish4)


```

####################################################### 

###TRY USING cm1const

```{r}
#project to zero fishing rate 
new_model_histc <- projectToSteady(cm_const3, t_max=30,effort = 0)
new_model_histspin <- project(cm_const3, t_max=30,effort = 0)
#```
#```{r}
t_per=0.5
#new_rel_effortX<-tail(new_rel_effort,-11)

new_model_histc3 <- projectToSteady(#cm_const3, 
                                new_model_histc,
                                 distance_func = distanceSSLogN,
                                  t_per = 0.5,
                               # t_max = 100,
                              #  dt = 0.1,
                               # return_sim = FALSE,
                               #  progress_bar = TRUE,
                                tol = 0.5 * t_per,
                                effort = new_rel_effort["1986", ])
```

We now have our parameter object and out matrix of efforts relative to
1979. We use this effort matrix as the effort argument to the project()
function. We use dt = 0.25 (the simulation will run faster than with the
default value of 0.1, but tests show that the results are still stable)
and save the results every year.

```{r}
cm_capacity <- resource_capacity(new_model_histc)
new_model_histcR <- setResource(new_model_histc, 
                    resource_capacity = cm_capacity * 2)
species_params(new_model_histcR)$z0[19:21] <- species_params(new_model_histcR)$z0[19:21]*0.9
species_params(new_model_histcR)$z0[20:21] <- species_params(new_model_histcR)$z0[20:21]*0.2
species_params(new_model_histcR)$erepro[19:21] <- species_params(new_model_histcR)$erepro[19:21]*1.5

species_params(new_model_histcR)$erepro[24:25] <- species_params(new_model_histcR)$erepro[24:25]*2
species_params(new_model_histcR)$z0[24:25] <- species_params(new_model_histcR)$z0[24:25]*0.2

new_model_histcR<-setParams(new_model_histcR)
sim_histc <- project(#new_model_histc3, 
                  new_model_histcR,
                  #new_model_histspin,
                    effort = new_rel_effort, 
                   # t_max=50, 
                    dt = 0.1, t_save = 1)
plotlyBiomassRelative(sim_histc)
plotYield(sim_histc)
plotlyBiomass(sim_histc)
species_params(new_model_histcR)

plotlyBiomassRelative(sim_histc, species="Resident_Orca_S")
plotlyBiomassRelative(sim_histc, species="Harbor_seals")
plotlyBiomassRelative(sim_histc, species="Steller_sealions")

ggplot(new_model_histcR) +
    geom_line(aes(x = time, y = value)) +
    facet_wrap(~sp, scales = "free", nrow = 5) +
    theme(legend.position = "none")
```

```{r}

library(dplyr)

df<-read.csv("~/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/survey_MM_hist.csv")
df_rel<-read.csv("~/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/survey_MM_hist_rel.csv")

## GET SURVEY
library(reshape2)
df_surv <- melt(df_rel, id.vars = "time", variable.name = "sp", value.name = "value")

MMsp<- c("Harbor_seals","Steller_sealions", "California_sealions", "Resident_Orca_S", "Resident_Orca_N", "Transient_Orca")

#### GET RELATIVE BIOMASS PREDICTIONS
#ssb1_dfc <- melt(getN(sim_histc))

# Get the full biomass matrix (all species)
biomass <- getN(sim_histc)

# MMsp is a character vector of the species you want, e.g.:
# MMsp <- c("Herring", "Cod")

# Subset the matrix to keep only the desired species (columns)
biomass_selected <- biomass[, MMsp]

# Relative to initial biomass
B_initial <- biomass_selected ["2011", ]  # vector: species
relative_biomass <- sweep(biomass_selected , 2, B_initial, "/")

library(reshape2)
#convert to long for ggplot
relative_biomass_long <- melt(relative_biomass, varnames = c("time", "sp"), value.name = "relative_biomass")

relative_biomass_long <- relative_biomass_long %>%
  mutate(sp = recode(sp,
    "Harbor_seals" = "Harbor Seals",
    "Steller_sealions" = "Steller Sea Lions",
    "California_sealions" = "California Sea Lions",
    "Resident_Orca_S" = "SRKW",
    "Resident_Orca_N" = "NRKW",
    "Transient_Orca" = "TKW"
  ))

df_surv <- df_surv %>%
  mutate(sp = recode(sp,
    "Harbor_seals" = "Harbor Seals",
    "Steller_sealions" = "Steller Sea Lions",
    "California_sealions" = "California Sea Lions",
    "Resident_Orca_S" = "SRKW",
    "Resident_Orca_N" = "NRKW",
    "Transient_Orca" = "TKW"
  ))


ggplot(relative_biomass_long) +
    geom_line(aes(x = time, y = relative_biomass)) +
    geom_point(data = df_surv, aes(x = time, y = value), color = "blue", size = 0.8) +
    facet_wrap(~sp, scales = "free", nrow = 2) +
    theme(legend.position = "none") +
    labs(x = "Year", y = "Relative Biomass")

### add a trendline?
ggplot(relative_biomass_long) +
  geom_line(aes(x = time, y = relative_biomass)) +
  geom_point(data = df_surv, aes(x = time, y = value), color = "blue", size = 1.5) +
  geom_smooth(
    data = df_surv,
    aes(x = time, y = value),
    method = "lm",
    color = "blue",
    linetype = "dashed", # or linetype = 2
    size = 0.5,          # thinner line
    se = FALSE
  ) +
  facet_wrap(~sp, scales = "free", nrow = 2) +
  theme(legend.position = "none") +
  labs(x = "Year", y = "Relative Biomass")

```

```{r}
sim0c <- project(new_model_histc, 
                        effort = 0,  
                        t_max=100,
                        return_sim = TRUE)
plotlyBiomassRelative(sim0c)

ssb1_dfc <- melt(getN(sim0c))
ggplot(ssb1_dfc) +
    geom_line(aes(x = time, y = value)) +
    facet_wrap(~sp, scales = "free", nrow = 5) +
    theme(legend.position = "none")

simRc <- project(new_model_histc, 
                        effort = new_rel_effort,  
                        t_max=100,
                        return_sim = TRUE)
plotlyBiomassRelative(simRc)

ssbR_dfc <- melt(getBiomass(simRc))
ggplot(ssbR_dfc) +
    geom_line(aes(x = time, y = value)) +
    facet_wrap(~sp, scales = "free", nrow = 5) +
    theme(legend.position = "none")
```

#save params new_model_histc in ss_pars

```{r}

saveParams(new_model_histc, "ss_mizerout2011_pars_250602c_newsplitfishing_histeffort_updpinn.rds")
dfnewc<-(species_params(new_model_histc))

write.csv((species_params(new_model_histc)), 
          "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_May25/ss_mizerout2011_pars_250602c_newsplitfishing_histeffort_updpinn.csv")

write.csv((gear_params(new_model_histc)), 
          "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_May25/ss_mizerout2011_pars_250602c_newsplitfishing_histeffort_updpinn.csv")
saveParams(new_model_histc, "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_May25/ss_mizerout2011_pars_250602c_newsplitfishing_histeffort_updpinn.rds")

```

## save indicator outputs to output folder

```{r}
#cur_model = sim_hist
### FISHING=0

 
write.csv(getBiomass(sim_histc), "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250527/sim_fishing_hist_biomass_updpinn.csv") ##fishing=0

write.csv(getN(sim_histc), "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250527/sim_fishing_hist_N_updpinn.csv") ##fishing=0

#PROP LARGE FISH
write.csv(getProportionOfLargeFish(sim_histc), "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250527/sim_fishing_hist_proplrgfish_updpinn.csv") ##fishing=0

#SPAWNING STOCK BIOMASS
write.csv(getSSB(sim_histc), "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250527/sim_fishing_hist_SSB_updpinn.csv") ##

##predation mortality
write.csv(getM2(sim_histc), "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250527/sim_fishing_hist_predmort_updpinn.csv") 

## yield
write.csv(getYield(sim_histc), "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250527/sim_fishing_hist_yield_updpinn.csv")

```

## try something else - SPIN UP

Next we use the effort data to project the model forwards from it’s
steady state. But wait - we did not set up the model for the first year
of the data, when fishing only just began. It may make more sense to use
a steady state without fishing as the initial values for our projection.

```{r}
#project to zero fishing rate 
#new_model0 <- projectToSteady(tuned_params3,effort = 0)

#sim0spin<-project(new_model0,t_max=30, effort=0)
sim0spin<-project(cm_const3,t_max=20, effort=0)

plotlyBiomassRelative(sim0spin, species="Resident_Orca_S")
plotlyBiomassRelative(sim0spin, species="Harbor_seals")
```

```{r}
# Use the parameters from the last simulation
params2 <- getParams(sim0spin)
params2 <- setInitialValues(params2, sim0spin)

```

We now have our parameter object and out matrix of efforts relative to
1979. We use this effort matrix as the effort argument to the project()
function. We use dt = 0.25 (the simulation will run faster than with the
default value of 0.1, but tests show that the results are still stable)
and save the results every year.

```{r}
sim_histspin <- project(params2, 
                    effort = new_rel_effort, 
                   # t_max=50, 
                    dt = 0.1, t_save = 1)
plotlyBiomassRelative(sim_histspin)
plotYieldGear(sim_histspin)
plotlyBiomass(sim_histspin)

plotlyBiomassRelative(sim_histspin, species="Resident_Orca_S")
plotlyBiomassRelative(sim_histspin, species="Harbor_seals")
plotlyBiomassRelative(sim_histspin, species="Steller_sealions")

ssb1_dfc <- melt(getN(sim_histspin))
ggplot(ssb1_dfc) +
    geom_line(aes(x = time, y = value)) +
    facet_wrap(~sp, scales = "free", nrow = 5) +
    theme(legend.position = "none")

```

# save params in ss_pars_May25

```{r}

saveParams(new_model0, "ss_mizerout2011_pars_250602_newsplitfishing_spinupeffort0.rds")
dfnew0<-(species_params(new_model0))

write.csv((species_params(new_model0)), 
          "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_May25/ss_mizerout2011_pars_250602_newsplitfishing_spinupeffort0.rds")

write.csv((gear_params(new_model0)), 
          "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_May25/ss_mizerout2011_pars_250602_newsplitfishing_spinupeffort0.rds")
saveParams(new_model0, "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_May25/ss_mizerout2011_pars_250602_newsplitfishing_spinupeffort0.rds")


```



####################JUNE 30

```{r}
readParams( "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_May25/ss_mizerout2011_pars_250602_newsplitfishing_spinupeffort0.rds")

df<-read.csv("~/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/survey_MM_hist.csv")
df_rel<-read.csv("~/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/survey_MM_hist_rel.csv")

All_fisheries_effort_array <- as(read.csv("~/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/fisheries/time series fisheries/All_fisheries_effort_array_250526_modhake.csv", row.names = 1), "matrix")

relative_effort <- sweep(All_fisheries_effort_array, 2, All_fisheries_effort_array["2011", ], "/")
relative_effort[as.character(1986:2011), ]
relative_effort[is.nan(relative_effort)] <- 0

#remove years after 2011
new_rel_effort<-head(relative_effort,-7)
```


###Future projections As well as investigating the historical
simulations, we can run projections into the future. Here we run
twoprojections to 2050 with different fishing scenarios.

Continue fishing at 2010 levels (the status quo scenario). From 2010
to2015 linearly change the fishing mortality to approach and then
continueat until 2050. Rather than looking at community indicators here,
we willcalculate the SSB of each species in the model and compare the
projectedlevels to a biodiversity target based on the reference point

Before we can run the simulations, we need to set up arrays of
futureeffort. We will continue to use effort relative to the level in
1990.Here we build on our existing array of relative effort to make an
arrayfor the first scenario. Note the use of the t() command to
transpose thearray. This is needed because R recycles by rows, so we
need to buildthe array with the dimensions rotated to start with. We
make an array ofthe future effort, and then bind it underneath the
relative_effort arrayused in the previous section.

```{r}
library(abind)
# Step 1: Ensure it's an array and has year dimension names
# (Assume new_rel_effort is a 2D array with years as rownames)
dimnames(new_rel_effort)[[1]] <- as.character(dimnames(new_rel_effort)[[1]])

# Step 2: Subset to only 1986–2011
effort_base <- new_rel_effort[as.character(1986:2011), , drop = FALSE]

# Step 3: Get values for 2011 to use as reference
reference_2011 <- new_rel_effort["2011", ]

#reference_2011 <- 1.5

# Step 4: Create new array for 2012–2050, repeating 2011 values
n_years_new <- length(2012:2050)
effort_new <- array(rep(reference_2011, each = n_years_new),
                    dim = c(n_years_new, dim(new_rel_effort)[2]),
                    dimnames = list(as.character(2012:2050), dimnames(new_rel_effort)[[2]]))

# Step 5: Combine old and new arrays
scenario1 <- abind::abind(effort_base, effort_new, along = 1)

```

#scenario2

```{r}
library(abind)
# Step 1: Ensure it's an array and has year dimension names
# (Assume new_rel_effort is a 2D array with years as rownames)
dimnames(new_rel_effort)[[1]] <- as.character(dimnames(new_rel_effort)[[1]])

# Step 2: Subset to only 1986–2011
effort_base <- new_rel_effort[as.character(1986:2011), , drop = FALSE]

# Step 3: Get values for 2011 to use as reference
#reference_2011 <- new_rel_effort["2011", ]

reference2 <- 1.2

# Step 4: Create new array for 2012–2050, repeating 2011 values
n_years_new <- length(2012:2050)
effort_new2 <- array(rep(reference2, each = n_years_new),
                    dim = c(n_years_new, dim(new_rel_effort)[2]),
                    dimnames = list(as.character(2012:2050), dimnames(new_rel_effort)[[2]]))

# Step 5: Combine old and new arrays
scenario2 <- abind::abind(effort_base, effort_new2, along = 1)

```

NOW - lets decrease the catchability for salmon \# scenario 1

```{r}
#new_model_histS<-new_model_hist
#new_model_histS<-new_model01

# Step 1: Get dimensions from combined_effort
years_all <- rownames(combined_effort)        # "1986" to "2050"
sectors <- colnames(combined_effort)          # fleets/sectors

# Step 2: Create a baseline matrix of 1s
scenario2b <- scenario1

# Step 3: Create named vector of reduction multipliers
reducedcatchS <- c(
  Invertebrates_PS = 1.2,
  Pacific_Herring_PS = 1.2,
  Small_Planktivorous_Fish_PS = 1.2,
  Chinook_Hatch_Adult_PS = 0.5,
  Chinook_Wild_Adult_PS = 0.5,
  Coho_Hatch_Adult_PS = 0.5,
  Coho_Wild_Adult_PS = 0.5,
  Chum_Adult_PS = 0.5,
  Sockeye_Adult_PS = 0.5,
  Chinook_Hatch_Resident_PS = 0.5,
  Chinook_Wild_Resident_PS = 0.5,
  Coho_Hatch_Resident_PS = 0.5,
  Coho_Wild_Resident_PS = 0.5,
  Hake_PS = 1.2,
  Lingcod_PS = 1.2,
  Rockfish_PS = 1.2,
  Other_fish_PS = 1.2,
  Halibut_PS = 1.2,
  SOG_bottom_trawl = 1.2,
  SOG_hook_and_line = 1.2,
  SOG_midwater_trawl = 1.2,
  SOG_herring = 1.2,
  SOG_commercial = 1.2,
  SOG_recreational = 1.2,
  SOG_salmon = 0.5,
  SOG_recreational_salmon = 0.5,
  Seal_mort = 0,
  Pinniped_bycatch = 0,
  Cetacean_bycatch = 0,
  Incidental = 0,
  Other_fish = 1.2
)

# Step 4: Apply reductions from 2012 to 2050
years_to_modify <- as.character(2012:2050)

for (col in sectors) {
  if (col %in% names(reducedcatchS)) {
    scenario2b[years_to_modify, col] <- reducedcatchS[col]
  } else {
    warning(paste("No reduction specified for:", col, "- using 1"))
    scenario2b[years_to_modify, col] <- 1
  }
}


#scenario2 <- t(array(fmsy, dim = c(31, 40), 
#                     dimnames = list(NULL, year = 2011:2050)))
#scenario2 <- rbind(new_rel_effort, scenario2)
#for (sp in dimnames(scenario2)[[2]]) {
#    scenario2[as.character(2011:2015), sp] <- scenario2["2010", sp] +
#        (((scenario2["2015", sp] - scenario2["2010", sp]) / 5) * 1:5)
#}
```

#scenario 2

```{r}
scenario2c <- scenario1
targetF <- 0.05
select_gear <- c("SOG_salmon")
# reach target by 10 years
scenario2c[1:10,select_gear] <- 
    seq(from = scenario2c[1], to = targetF, length = 10)
# then hold at target
scenario2c[11:39, select_gear] <- targetF
# check it
ggplot(x = 2012:2050, y = scenario2c, ylab = "effort", xlab = "")
```

#scenario 2b

```{r}
#new_model_histS<-new_model_hist

# Step 1: Get dimensions from combined_effort
years_all <- rownames(combined_effort)        # "1986" to "2050"
sectors <- colnames(combined_effort)          # fleets/sectors

# Step 2: Create a baseline matrix of 1s
scenario2d <- scenario1

# Step 3: Create named vector of reduction multipliers
reducedcatchS <- c(
  Invertebrates_PS = 1.1,
  Pacific_Herring_PS = 1.1,
  Small_Planktivorous_Fish_PS = 1.1,
  Chinook_Hatch_Adult_PS = 0.5,
  Chinook_Wild_Adult_PS = 0.5,
  Coho_Hatch_Adult_PS = 0.5,
  Coho_Wild_Adult_PS = 0.5,
  Chum_Adult_PS = 0.5,
  Sockeye_Adult_PS = 0.5,
  Chinook_Hatch_Resident_PS = 0.5,
  Chinook_Wild_Resident_PS = 0.5,
  Coho_Hatch_Resident_PS = 0.5,
  Coho_Wild_Resident_PS = 0.5,
  Hake_PS = 1.1,
  Lingcod_PS = 1.1,
  Rockfish_PS = 1.1,
  Other_fish_PS = 1.1,
  Halibut_PS = 1.1,
  SOG_bottom_trawl = 1.1,
  SOG_hook_and_line = 1.1,
  SOG_midwater_trawl = 1.1,
  SOG_herring = 1.1,
  SOG_commercial = 1.1,
  SOG_recreational = 1.1,
  SOG_salmon = 0.5,
  SOG_recreational_salmon = 0.5,
  Seal_mort = 0,
  Pinniped_bycatch = 0,
  Cetacean_bycatch = 0,
  Incidental = 0,
  Other_fish = 1.1
)

# Step 4: Apply reductions from 2012 to 2050
years_to_modify <- as.character(2012:2050)

for (col in sectors) {
  if (col %in% names(reducedcatchS)) {
    scenario2d[years_to_modify, col] <- reducedcatchS[col]
  } else {
    warning(paste("No reduction specified for:", col, "- using 1"))
    scenario2d[years_to_modify, col] <- 1
  }
}

```

We are now ready to project the two scenarios.

```{r}
sim1 <- project(new_model_hist0, effort = scenario1, dt = 0.25)
sim2 <- project(new_model_hist0, effort = scenario2, dt = 0.25) ##increase effort across the board
sim2b <- project(new_model_hist0, effort = scenario2b, dt = 0.25) ##ddecrease salmon effort
sim2c <- project(new_model_hist0, effort = scenario2c, dt = 0.25) ##change salmon SOG gear catch
sim2d <- project(new_model_hist0, effort = scenario2d, dt = 0.25) ##change salmon SOG gear catch

```

We can now compare the projected SSB values in both scenarios to the
biodiversity reference points. First we calculate the biodiversity
reference points (from the final time step in the unexploited sim0
simulation): #ssb0

```{r}
ssb0 <- getSSB(sim0)[final, ]

```

Now we build a data.frame of the projected SSB for each species. We make
use of the melt() function to transform arrays into data frames. \##
plot the historical trajectories

```{r}
years <- 1986:2050
ssb1_df <- melt(getSSB(sim_histspin))
ssb2_df <- melt(getSSB(sim_hist))
ssb_df <- rbind(
    #transform(ssb1_df, scenario = "Unexploited"),
    transform(ssb2_df, scenario = "Historical fishing effort"))
ssb_unexploited_df <- cbind(expand.grid(
    sp = sim_species,  # Use simulation species names
  #sp = names(ssb0),
    time = 1986:2050),
   # value = as.numeric(ssb0),
    value = as.numeric(ssb0),
    scenario = "Unexploited")
ssb_reference_df <- cbind(expand.grid(
  sp = sim_species,  # Use simulation species names
   # sp = names(ssb0),
    time = 1986:2050),
    value = as.numeric(ssb0 * 0.5),
    scenario = "Reference")
#ssb_all_df <- rbind(ssb_df, ssb_unexploited_df, ssb_reference_df)
ssb_all_df <- rbind(ssb_df)#, ssb_unexploited_df)
colours <- c("Unexploited" = "orange", 
             "Historical fishing effort" = "blue"#,
            # "Unexploited" = "blue"#, 
            # "Reference" = "purple"
             )
ggplot(ssb_all_df) +
    geom_line(aes(x = time, y = value, colour = scenario)) +
    facet_wrap(~sp, scales = "free", nrow = 5) +
    theme(legend.position = "none") +
    scale_colour_manual(values = colours)

ggplot(ssb_df) +
    geom_line(aes(x = time, y = value, colour = scenario)) +
    facet_wrap(~sp, scales = "free", nrow = 5) +
    theme(legend.position = "none") +
    scale_colour_manual(values = colours)

```

Historical and projected SSB under two fishing scenarios. Status quo
(red), Fmsy (yellow). Unexploited (blue) and reference levels (purple)
are also shown.

######### USING CM CONST INSTEAD OF MANUALLY TUNED - WORKS BETTER

```{r}
ssb0c <- getSSB(sim0c)[final, ]

```

```{r}
years <- 1986:2050
ssb1_dfc <- melt(getSSB(sim0c))
ssb2_dfc <- melt(getSSB(sim_histc))
ssb_dfc <- rbind(
    #transform(ssb1_dfc, scenario = "Unexploited"),
    transform(ssb2_dfc, scenario = "Historical fishing effort"))
ssb_unexploited_dfc <- cbind(expand.grid(
    sp = sim_species,  # Use simulation species names
  #sp = names(ssb0),
    time = 1986:2050),
   # value = as.numeric(ssb0),
    value = as.numeric(ssb0c),
    scenario = "Unexploited")
ssb_reference_dfc <- cbind(expand.grid(
  sp = sim_species,  # Use simulation species names
   # sp = names(ssb0),
    time = 1986:2050),
    value = as.numeric(ssb0c * 0.5),
    scenario = "Reference")
#ssb_all_dfc <- rbind(ssb_dfc, ssb_unexploited_dfc, ssb_reference_dfc)
ssb_all_dfc <- rbind(ssb_dfc)#, ssb_unexploited_dfc)
colours <- c("Unexploited" = "orange", 
             "Historical fishing effort" = "blue"#,
            # "Unexploited" = "blue"#, 
            # "Reference" = "purple"
             )
ggplot(ssb_dfc) +
    geom_line(aes(x = time, y = value, colour = scenario)) +
    facet_wrap(~sp, scales = "free", nrow = 5) +
    theme(legend.position = "none") +
    scale_colour_manual(values = colours)

```

###### 2 June plotting adfd biomass to marine mamma;ls

```{r}
N0c <- getN(sim0c)[final, ]

```

##getN and plot

```{r}
years <- 1986:2050
ssb1_dfc <- melt(getN(sim0c))
ssb2_dfc <- melt(getN(sim_histspin))
ssb_dfc <- rbind(
    #transform(ssb1_dfc, scenario = "Unexploited"),
    transform(ssb2_dfc, scenario = "Historical fishing effort"))
ssb_unexploited_dfc <- cbind(expand.grid(
    sp = sim_species,  # Use simulation species names
  #sp = names(ssb0),
    time = 1986:2050),
   # value = as.numeric(ssb0),
    value = as.numeric(ssb0c),
    scenario = "Unexploited")
ssb_reference_dfc <- cbind(expand.grid(
  sp = sim_species,  # Use simulation species names
   # sp = names(ssb0),
    time = 1986:2050),
    value = as.numeric(ssb0c * 0.5),
    scenario = "Reference")
#ssb_all_dfc <- rbind(ssb_dfc, ssb_unexploited_dfc, ssb_reference_dfc)
ssb_all_dfc <- rbind(ssb_dfc)#, ssb_unexploited_dfc)
colours <- c("Unexploited" = "orange", 
             "Historical fishing effort" = "blue"#,
            # "Unexploited" = "blue"#, 
            # "Reference" = "purple"
             )
ggplot(ssb_dfc) +
    geom_line(aes(x = time, y = value, colour = scenario)) +
    facet_wrap(~sp, scales = "free", nrow = 5) +
    theme(legend.position = "none") +
    scale_colour_manual(values = colours)

```

### 2 June PLOTTING - points

```{r}
#cur_model = sim_hist
### FISHING=0

 
write.csv(getBiomass(sim_histc), "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250527/sim_fishing_histc_biomass2.csv") ##fishing=0

write.csv(getN(sim_histc), "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250527/sim_fishing_histc_N2.csv") ##fishing=0

#PROP LARGE FISH
write.csv(getProportionOfLargeFish(sim_histc), "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250527/sim_fishing_histc_proplrgfish2.csv") ##fishing=0

#SPAWNING STOCK BIOMASS
write.csv(getSSB(sim_histc), "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250527/sim_fishing_histc_SSB2.csv") ##

##predation mortality
write.csv(getM2(sim_histc), "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250527/sim_fishing_histc_predmort2.csv") 

## yield
write.csv(getYield(sim_histc), "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250527/sim_fishing_histc_yield2.csv")

```

##### PLOT MARINE MAMMALS RELATIVE CHANGE WITH BIOMASS

```{r}
library(ggplot2)
library(readr)
library(dplyr)

# Load and prepare the data
### add catches
dat<-read.csv("/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250527/sim_histfish_yieldsalmon_wcatches.csv")



dat <- dat %>%
  mutate(
    Year = as.numeric(Year),
    Yield = as.numeric(Yield),
    Catch = as.numeric(Catch)
  )

# Define selected gears
selected_gears <- c(
  "Chinook_Hatch_Adult_PS", "Chinook_Wild_Adult_PS",
  "Chinook_Hatch_Resident_PS", "Chinook_Wild_Resident_PS",
  "Coho_Hatch_Adult_PS", "Coho_Wild_Adult_PS",
  "Coho_Hatch_Resident_PS", "Coho_Wild_Resident_PS"
)

# Filter the data
dat_filtered <- dat %>%
  filter(New_Gear %in% selected_gears)

# Plot (correctly terminated)
plotPS<- ggplot(dat_filtered, aes(x = Year)) +
  geom_line(aes(y = Yield), color = "darkgreen") +
  geom_point(aes(y = Catch), color = "blue", size = 2) +
  facet_wrap(~New_Gear, scales = "free_y", ncol = 2) +
  labs(
    title = "Yield and Catch Over Time (Selected Gears)",
    y = "Value",
    x = "Year"
  ) +
  theme_minimal()
plotPS
```

###### Fishing through time: projecting into the future

Now let’s see what happens if we change fishing in the future. To do
this we set up two scenarios, one where the model starts with the last
time step of the fished scenario and continues into the future (the
“status quo”). The other will be designed to explore a “more
sustainable” scenario.

```{r}
# Use the parameters from the last simulation
params <- getParams(tuned_model)
params <- setInitialValues(params, sim_hist)
initial_effort(params)
```

Let’s start a new simulation that begins with the effort from 2020 and
projects forward for 50 years. We will apply a linear decrease in effort
for toothfish to a target value (here assumed for simplicity to be F =
0.2). To do this we need to work the effort array again (time x gear) to
enable changes in effort through time.

```{r}
proj_effort_scen1 <- effort_new

```

## MORE SUSTAINABLE - REDUCED CATCHABILI

```{r}
proj_effort_scen2 <- proj_effort_scen1
targetF <- 0.01
select_gear <- "SOG_salmon"
# reach target by 10 years
proj_effort_scen2[1:10,select_gear] <- 
    seq(from = proj_effort_scen2[1], to = targetF, length = 10)
# then hold at target
proj_effort_scen2[11:39, select_gear] <- targetF
# check it
ggplot(x = 2012:2050, y = proj_effort_scen2, ylab = "effort", xlab = "")
```

```{r}
# run the simulations forward, both using the 2020 abundances as initial values
sim_scen1 <- project(params, effort = proj_effort_scen1*1.5, t_max = 50)
sim_scen2 <- project(params, effort = proj_effort_scen2, t_max = 50)
```

```{r}
#set the scenario to examine relative to 2020 levels
scen <- sim_scen2
plotYield(scen)

# plot change in biomass under each scenario relative to current values
B_current <- getBiomass(scen)[1, ]
Brel_scen <- melt(sweep(getBiomass(scen), 2, B_current, "/"))
colnames(Brel_scen)[2] <- "Species"
legend_levels <- intersect(names(scen@params@linecolour), Brel_scen$Species)
ggplot(Brel_scen) + 
  geom_line(aes(x = time,y = value,color = Species), size = 1) + 
  geom_hline(yintercept = 1, linetype = 1, colour = "grey", size = 0.75) +
  scale_y_continuous(name = "Relative biomass") +
  scale_color_manual(values = params@linecolour[legend_levels]) +
  theme(legend.key = element_rect(fill = "white")) 

```

Let’s take a look at the relative exploitation status of the stocks
using the projected values for 2050. We will put the y-axis scale is
log10 to better visualise the differences across species. Species with
B/B_unfished values that are below the red dashed line imply the stock
is still collapsed. We can see that when we decrease fishing to the
targetF under scenario 2 this greatly improves the relative biomass
compared to the status quo. This is consistent with our expectations
from the equilibrium Fmsy that we tuned. Another thing to note is that,
relative to the unfished community, there are several species that
increase less under this fishing scenario - this is what happens when
account for food web interactions in models!

```{r}
# plot change in biomass under each scenario relative to unfished values
# get saved values from steady state without fishing that we generated earlier 
#sim0 
# get the unfished biomasses
B_unfished <- getBiomass(sim0)[1, ]
#scen 1
Brel_scen1_2050 <- getBiomass(sim1)["2050", ] / B_unfished

#scen 2
Brel_scen2_2050 <- getBiomass(sim2)["2050", ] / B_unfished

Brel_scens <- rbind(data.frame(species = names(Brel_scen1_2050),
                               value = Brel_scen1_2050, scen = "scen1"),
                    data.frame(species = names(Brel_scen2_2050),
                               value = Brel_scen2_2050, scen = "scen2"))

# barplot comparing the 2 scenarios by 2050
ggplot(Brel_scens, aes(fill = scen, y = value, x = species)) + 
    geom_bar(position = "dodge", stat = "identity") + 
     geom_hline(yintercept = 0.1, linetype = 2, colour = "red", size = 0.5) + 
    scale_y_log10(name = "log10(Biomass/Biomass Unfished)")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

#####FUTURE SIMULATIONS

### STATUS QUO

```{r}
# Create a high productivity scenario
params_quo<- new_model_hist0
#params_quo <- tuned_model3

# Run projection
sim_quo<- project(params_quo, effort=1, t_save=0.25)
```

### INCREASE PRODUCTIVITY OF SALMON

```{r}
# Create a high productivity scenario
params_high_prod <- new_model_hist0
#params_high_prod <- tuned_model3

# Combine multiple improvements
species_params(params_high_prod)$erepro[4] <- species_params(params_high_prod)$erepro[4] *1.03
#species_params(params_high_prod)$z0[19] <- species_params(params_high_prod)$z0[19] *0.99
species_params(params_high_prod)$z0[4:5] <- species_params(params_high_prod)$z0[4:5] * 0.9
species_params(params_high_prod)$z0[10:11] <- species_params(params_high_prod)$z0[10:11] * 0.9
#resource_params(params_high_prod)$kappa <- 114602882651 * 1.1
# Get current resource capacity
current_capacity <- resource_capacity(params_high_prod)
params_high_prod <- setResource(params_high_prod, 
                    resource_capacity = current_capacity * 1.2)

# Recalculate parameters
params_high_prod <- setParams(params_high_prod)

# Run projection
sim_high_prod <- project(params_high_prod, effort=1.01, t_save=0.25)
```

### DECREASE PRODUCTIVITY OF SALMON

```{r}
# Create a high productivity scenario
params_low_prod <- new_model_hist0
params_high_prod <- tuned_model3

# Combine multiple improvements
#species_params(params_high_prod)$erepro[4] <- species_params(params_high_prod)$erepro[4] *1.03
#species_params(params_high_prod)$z0[19] <- species_params(params_high_prod)$z0[19] *0.99
species_params(params_low_prod)$z0[4:5] <- species_params(params_low_prod)$z0[4:5] * 1.1
species_params(params_low_prod)$z0[10:11] <- species_params(params_low_prod)$z0[10:11] * 1.1
#resource_params(params_high_prod)$kappa <- 114602882651 * 1.1
# Get current resource capacity
#current_capacity <- resource_capacity(params_low_prod)
#params_low_prod <- setResource(params_low_prod, 
#                    resource_capacity = current_capacity * 1.2)

# Recalculate parameters
params_low_prod <- setParams(params_low_prod)

# Run projection
sim_low_prod <- project(params_low_prod, effort=1.01, t_save=0.25)
```

### DECREAESE PROD OF SEALS AND SEA LIONS

```{r}
# Create a high productivity scenario
params_pinn <- new_model_hist0
#params_high_prod <- tuned_model3

# Combine multiple improvements
#species_params(params_pinn)$erepro[19:21] <- species_params(params_pinn)$erepro[19:21] *0.99
species_params(params_pinn)$z0[19:21] <- species_params(params_pinn)$z0[19:21] *1.01

#species_params(params_pinn)$z0[4:5] <- species_params(params_pinn)$z0[4:5] * 1.1

#resource_params(params_high_prod)$kappa <- 114602882651 * 1.1
# Get current resource capacity
current_capacity <- resource_capacity(params_pinn)
params_pinn <- setResource(params_pinn, 
                    resource_capacity = current_capacity * 1.2)

# Recalculate parameters
params_pinn <- setParams(params_pinn)

# Run projection
sim_pinn <- project(params_pinn, effort=1.01, t_save=0.25)
```

```{r}
#years <- 1986:2050
ssb1f_df <- melt(getSSB(sim_quo))
ssb2f_df <- melt(getSSB(sim_high_prod))
ssb3f_df <- melt(getSSB(sim_low_prod))
ssb4f_df <- melt(getSSB(sim_pinn))
ssb_df <- rbind(
    transform(ssb1f_df, scenario = "Status quo"),
    transform(ssb2f_df, scenario = "Increase salmon productivity"),
  transform(ssb3f_df, scenario = "Decrease salmon productivity"),
  transform(ssb4f_df, scenario = "Decrease pinniped productivity"))
colours <- c("Status quo" = "orange", "Increase salmon productivity" = "blue"#,
            # "Unexploited" = "blue"#, 
            # "Reference" = "purple"
             )
ggplot(ssb_df) +
    geom_line(aes(x = time, y = value, colour = scenario)) +
    facet_wrap(~sp, scales = "free", nrow = 4) +
    theme(legend.position = "none") +
    scale_colour_manual(values = colours)

# Plot only specific species (e.g., Cod and Haddock)
target_species <- c("Chinook_Hatch_Adult","Chinook_Wild_Adult", "Coho_Hatch_Adult","Coho_Wild_Adult","Chinook_Hatch_Resident","Chinook_Wild_Resident", "Coho_Hatch_Resident","Coho_Wild_Resident",  "Harbor_seals", "Steller_sealions", "California_sealions", "Harbor_porpoise",  "Resident_Orca_S",  "Resident_Orca_N",   "Transient_Orca"  )



ggplot(ssb_df[ssb_df$sp %in% target_species, ]) +
    geom_line(aes(x = time, y = value, colour = scenario)) +
    facet_wrap(~sp, scales = "free", nrow = 2) +
    theme(legend.position = "none") +
    scale_colour_manual(values = colours)



```

### perfect - SRKW increase when we increase chinook stocks

```{r}
# Calculate relative values (as proportion of starting year)
ssb_relative <- ssb_df
ssb_relative$value <- with(ssb_relative, {
    ave(value, sp, scenario, FUN = function(x) x / x[1])
})

# Plot with y-axis starting at 0
ggplot(ssb_relative) +
    geom_line(aes(x = time, y = value, colour = scenario)) +
    facet_wrap(~sp, scales = "free_x", nrow = 4) +  # Only free x-axis
    #scale_y_continuous(limits = c(0, NA)) +  # Force y-axis to start at 0
    theme(legend.position = "none") +
    scale_colour_manual(values = colours) +
    labs(y = "Relative biomass (proportion of starting year)")


ggplot(ssb_relative[ssb_relative$sp %in% target_species, ]) +
    geom_line(aes(x = time, y = value, colour = scenario)) +
    facet_wrap(~sp, scales = "free", nrow = 3) +
    theme(legend.position = "none") +
    scale_colour_manual(values = colours)


```

######################################################### 

#### RUNNING SCENARIOS USING TUNED MODEL

### STATUS QUO

```{r}
# Create a high productivity scenario
#params_quo<- new_model_hist0
params_quo2 <- tuned_model3

# Run projection
sim_quo2<- project(params_quo2, effort=1, t_save=0.25)

# Run projection
sim_eff1.2<- project(tuned_model3, effort=1.2, t_save=0.25)


# Run projection
sim_0<- project(tuned_model3, effort=1, t_save=0.25)

########################################################################
### INCREASE PRODUCTIVITY OF SALMON

# Create a high productivity scenario
#params_high_prod <- new_model_hist0
params_high_prod2 <- tuned_model3

# Combine multiple improvements
#species_params(params_high_prod2)$erepro[4:5] <- species_params(params_high_prod2)$erepro[4:5] *1.03
#species_params(params_high_prod2)$erepro[10:11] <- species_params(params_high_prod2)$erepro[10:11] *1.03

species_params(params_high_prod2)$z0[4:5] <- species_params(params_high_prod2)$z0[4:5] * 0.9
species_params(params_high_prod2)$z0[10:11] <- species_params(params_high_prod2)$z0[10:11] * 0.9
#resource_params(params_high_prod)$kappa <- 114602882651 * 1.1
# Get current resource capacity
current_capacity <- resource_capacity(params_high_prod2)
params_high_prod2 <- setResource(params_high_prod2, 
                    resource_capacity = current_capacity * 1.2)

# Recalculate parameters
params_high_prod2 <- setParams(params_high_prod2)

# Run projection
sim_high_prod2 <- project(params_high_prod2, effort=1.01, t_save=0.25)


######################################
### DECREASE PRODUCTIVITY OF SALMON

#params_low_prod <- new_model_hist0
params_low_prod2 <- tuned_model3

# Combine multiple improvements
species_params(params_low_prod2)$z0[4:5] <- species_params(params_low_prod2)$z0[4:5] * 1.1
species_params(params_low_prod2)$z0[10:11] <- species_params(params_low_prod2)$z0[10:11] * 1.1
# Get current resource capacity
current_capacity <- resource_capacity(params_low_prod2)
params_low_prod2 <- setResource(params_low_prod2, 
                    resource_capacity = current_capacity * 1.2)

# Recalculate parameters
params_low_prod2 <- setParams(params_low_prod2)

# Run projection
sim_low_prod2 <- project(params_low_prod2, effort=1.01, t_save=0.25)

#############################################################################
### DECREAESE PROD OF SEALS AND SEA LIONS

#params_pinn <- new_model_hist0
params_pinn2 <- tuned_model3

# Combine multiple improvements
#species_params(params_pinn)$erepro[19:21] <- species_params(params_pinn)$erepro[19:21] *0.99
species_params(params_pinn2)$z0[19:21] <- species_params(params_pinn2)$z0[19:21] *1.5

#species_params(params_pinn)$z0[4:5] <- species_params(params_pinn)$z0[4:5] * 1.1

# Get current resource capacity
current_capacity <- resource_capacity(params_pinn2)
params_pinn2 <- setResource(params_pinn2, 
                    resource_capacity = current_capacity * 1.2)

# Recalculate parameters
params_pinn2 <- setParams(params_pinn2)

# Run projection
sim_pinn2 <- project(params_pinn2, effort=1.01, t_save=0.25)


#############################################################################
### INCREASE TRANSIENTS

#params_pinn <- new_model_hist0
params_trans2 <- tuned_model3

# Combine multiple improvements
#species_params(params_pinn)$erepro[19:21] <- species_params(params_pinn)$erepro[19:21] *0.99
species_params(params_trans2)$z0[25] <- species_params(params_trans2)$z0[25] *0.9

#species_params(params_pinn)$z0[4:5] <- species_params(params_pinn)$z0[4:5] * 1.1

# Get current resource capacity
current_capacity <- resource_capacity(params_trans2)
params_trans2 <- setResource(params_trans2, 
                    resource_capacity = current_capacity * 1.2)

# Recalculate parameters
params_trans2 <- setParams(params_trans2)

# Run projection
sim_trans2 <- project(params_trans2, effort=1.01, t_save=0.25)

########################################################################
### INCREASE HATCHERY PRODUCTIVITY OF SALMON

# Create a high productivity scenario
#params_high_prod <- new_model_hist0
params_high_prod2h <- tuned_model3

# Combine multiple improvements
#species_params(params_high_prod2)$erepro[4] <- species_params(params_high_prod2)$erepro[4] *1.03
#species_params(params_high_prod2)$erepro[10] <- species_params(params_high_prod2)$erepro[10] *1.03

species_params(params_high_prod2h)$z0[4] <- species_params(params_high_prod2h)$z0[4] * 0.99
species_params(params_high_prod2h)$z0[10] <- species_params(params_high_prod2h)$z0[10] * 0.99
species_params(params_high_prod2h)$z0[6] <- species_params(params_high_prod2h)$z0[6] * 0.99
species_params(params_high_prod2h)$z0[12] <- species_params(params_high_prod2h)$z0[12] * 0.99
#resource_params(params_high_prod)$kappa <- 114602882651 * 1.1
# Get current resource capacity
current_capacity <- resource_capacity(params_high_prod2h)
params_high_prod2h <- setResource(params_high_prod2h, 
                    resource_capacity = current_capacity * 1.2)

# Recalculate parameters
params_high_prod2h <- setParams(params_high_prod2h)

# Run projection
sim_high_prod2h <- project(params_high_prod2h, effort=1.01, t_save=0.25)




#############################################################################
### DECREAESE PROD OF SEALS AND SEA LIONS AND INCREASE SALMON HATCHERY

#params_pinn <- new_model_hist0
params_pinn2b <- tuned_model3

# Combine multiple improvements
#species_params(params_pinn)$erepro[19:21] <- species_params(params_pinn)$erepro[19:21] *0.99
#species_params(params_pinn2b)$z0[19:21] <- species_params(params_pinn2b)$z0[19:21] *1.5

#species_params(params_pinn2b)$z0[4] <- species_params(params_pinn2b)$z0[4] * 0.99
#species_params(params_pinn2b)$z0[10] <- species_params(params_pinn2b)$z0[10] * 0.99
#species_params(params_pinn2b)$z0[6] <- species_params(params_pinn2b)$z0[6] * 0.99
#species_params(params_pinn2b)$z0[12] <- species_params(params_pinn2b)$z0[12] * 0.99

#species_params(params_pinn2b)$z0[4:8] <- species_params(params_pinn2b)$z0[4:8] * 1.1
#species_params(params_pinn2b)$z0[10:13] <- species_params(params_pinn2b)$z0[10:13] * 1.1

gear_params(params_pinn2b)["Harbor_seals, Seal_mort", "catchability"] <- 0.1

#gear_params(params_pinn2b)$catchability[19] <-  0.25
#gear_params(params_pinn2b)$catchability[19] <-  0.25

# Get current resource capacity
current_capacity <- resource_capacity(params_pinn2b)
params_pinn2b <- setResource(params_pinn2b, 
                    resource_capacity = current_capacity * 1.2)

# Recalculate parameters
params_pinn2b <- setParams(params_pinn2b)
params_pinn2b <- setFishing(params_pinn2b, effort=1)

# Run projection
sim_pinn2b <- project(params_pinn2b, effort=1.1, t_save=0.25)

```

##PREDATION MORTALITY

```{r}
salmon_species <- c("Chinook_Hatch_Adult","Chinook_Wild_Adult", "Coho_Hatch_Adult","Coho_Wild_Adult","Chinook_Hatch_Resident","Chinook_Wild_Resident", "Coho_Hatch_Resident","Coho_Wild_Resident" )

plotFMort(sim_quo2, species = salmon_species)

```

```{r}
#years <- 1986:2050
ssb0_df2 <- melt(getSSB(sim_0))
ssb1.2_df2 <- melt(getSSB(sim_eff1.2))
ssb1f_df2 <- melt(getSSB(sim_quo2))
ssb2f_df2 <- melt(getSSB(sim_high_prod2))
ssb2hf_df2 <- melt(getSSB(sim_high_prod2h))
ssb3f_df2 <- melt(getSSB(sim_low_prod2))
ssb4f_df2 <- melt(getSSB(sim_pinn2))
ssb_df2 <- rbind(
     #transform(ssb1.5_df2 , scenario = "Fishing effort increase"),
      transform(ssb1f_df2, scenario = "Status quo"),
   #     transform(ssb4f_df2, scenario = "Decrease pinniped productivity"),
    transform(ssb2f_df2, scenario = "Increase salmon productivity"),
        transform(ssb2hf_df2, scenario = "Increase hatchery productivity"),
  transform(ssb3f_df2, scenario = "Decrease salmon productivity")
)
colours <- c("Status quo" = "black", 
            # "Fishing effort increase" = "grey", 
             "Increase salmon productivity" = "green", #BOTTOM UP
               "Increase hatchery productivity" = "green4", #BOTTOM UP
             # "Decrease pinniped productivity" = "purple" #TOP DOWN,
               "Decrease salmon productivity" = "red" #BOTTOM UP
             )
             
#ggplot(ssb_df2) +
#    geom_line(aes(x = time, y = value, colour = scenario)) +
#    facet_wrap(~sp, scales = "free", nrow = 4) +
#    theme(legend.position = "none") +
#    scale_colour_manual(values = colours)

# Plot only specific species (e.g., Cod and Haddock)
target_species <- c("Pacific_Herring", "Chinook_Hatch_Adult","Chinook_Wild_Adult", "Coho_Hatch_Adult","Coho_Wild_Adult","Chinook_Hatch_Resident","Chinook_Wild_Resident", "Coho_Hatch_Resident","Coho_Wild_Resident",  "Harbor_seals", "Steller_sealions", "California_sealions", "Harbor_porpoise",  "Resident_Orca_S",  "Resident_Orca_N",   "Transient_Orca"  )

##ALL SPECIES
#ggplot(ssb_df2[ssb_df2$sp %in% target_species, ]) +
#    geom_line(aes(x = time, y = value, colour = scenario)) +
#    facet_wrap(~sp, scales = "free", nrow = 2) +
#    theme(legend.position = "none") +
#    scale_colour_manual(values = colours)


# Calculate relative values (as proportion of starting year)
ssb_relative2 <- ssb_df2
ssb_relative2$value <- with(ssb_relative2, {
    ave(value, sp, scenario, FUN = function(x) x / x[1])
})

# Plot with y-axis starting at 0
ggplot(ssb_relative2) +
    geom_line(aes(x = time, y = value, colour = scenario)) +
    facet_wrap(~sp, scales = "free_x", nrow = 4) +  # Only free x-axis
    #scale_y_continuous(limits = c(0, NA)) +  # Force y-axis to start at 0
    theme(legend.position = "none") +
    scale_colour_manual(values = colours) +
    labs(y = "Relative biomass (proportion of starting year)")

###SPECIFIC SPECIES
ggplot(ssb_relative2[ssb_relative2$sp %in% target_species, ]) +
    geom_line(aes(x = time, y = value, colour = scenario)) +
    facet_wrap(~sp, scales = "free", nrow = 4) +
    theme(legend.position = "none") +
    scale_colour_manual(values = colours)


```

############### TOP DOWN CONTROLS

```{r}
#years <- 1986:2050
ssb0_df3 <- melt(getSSB(sim_0))
ssb1f_df3 <- melt(getSSB(sim_quo2))
ssb4f_df3 <- melt(getSSB(sim_pinn2))
ssb5f_df3 <- melt(getSSB(sim_trans2))
ssb4f_df3b <- melt(getSSB(sim_pinn2b))

ssb_df3 <- rbind(
      transform(ssb1f_df3, scenario = "Status quo"),
      transform(ssb4f_df3, scenario = "Decrease pinniped productivity"),
      transform(ssb4f_df3b, scenario = "Pinniped reduction and fishing")
)
colours <- c("Status quo" = "black", 
             "Decrease pinniped productivity" = "green3", 
             "Pinniped reduction and fishing" = "blue"
             )
             
#ggplot(ssb_df2) +
#    geom_line(aes(x = time, y = value, colour = scenario)) +
#    facet_wrap(~sp, scales = "free", nrow = 4) +
#    theme(legend.position = "none") +
#    scale_colour_manual(values = colours)

# Plot only specific species (e.g., Cod and Haddock)
target_species <- c("Pacific_Herring", "Chinook_Hatch_Adult","Chinook_Wild_Adult", "Coho_Hatch_Adult","Coho_Wild_Adult","Chinook_Hatch_Resident","Chinook_Wild_Resident", "Coho_Hatch_Resident","Coho_Wild_Resident",  "Harbor_seals", "Steller_sealions", "California_sealions", "Harbor_porpoise",  "Resident_Orca_S",  "Resident_Orca_N",   "Transient_Orca"  )

##ALL SPECIES
#ggplot(ssb_df2[ssb_df2$sp %in% target_species, ]) +
#    geom_line(aes(x = time, y = value, colour = scenario)) +
#    facet_wrap(~sp, scales = "free", nrow = 2) +
#    theme(legend.position = "none") +
#    scale_colour_manual(values = colours)


# Calculate relative values (as proportion of starting year)
ssb_relative3 <- ssb_df3
ssb_relative3$value <- with(ssb_relative3, {
    ave(value, sp, scenario, FUN = function(x) x / x[1])
})

# Plot with y-axis starting at 0
ggplot(ssb_relative3) +
    geom_line(aes(x = time, y = value, colour = scenario)) +
    facet_wrap(~sp, scales = "free_x", nrow = 4) +  # Only free x-axis
    scale_y_continuous(limits = c(0.5, 1.5)) +  # Force y-axis to start at 0
    theme(legend.position = "none") +
    scale_colour_manual(values = colours) +
    labs(y = "Relative biomass (proportion of starting year)")

###SPECIFIC SPECIES
ggplot(ssb_relative3[ssb_relative3$sp %in% target_species, ]) +
    geom_line(aes(x = time, y = value, colour = scenario)) +
    facet_wrap(~sp, scales = "free", nrow = 4) +
   #   scale_y_continuous(limits = c(0.8, 1.2)) +  # Force y-axis to start at 0
    theme(legend.position = "none") +
    scale_colour_manual(values = colours)


```

```{r}
# plot change in biomass under each scenario relative to unfished values
# get saved values from steady state without fishing that we generated earlier 
#sim0 
# get the unfished biomasses
B_unfished <- getBiomass(sim_0)[1, ]
#scen 1
Brel_scen1_2050 <- getBiomass(sim_eff1.2)["50", ] / B_unfished

#scen 2
Brel_scen2_2050 <- getBiomass(sim_quo)["50", ] / B_unfished

Brel_scens <- rbind(data.frame(species = names(Brel_scen1_2050),
                               value = Brel_scen1_2050, scen = "Increase fishing 20%"),
                    data.frame(species = names(Brel_scen2_2050),
                               value = Brel_scen2_2050, scen = "Status quo"))

# barplot comparing the 2 scenarios by 2050
ggplot(Brel_scens, aes(fill = scen, y = value, x = species)) + 
    geom_bar(position = "dodge", stat = "identity") + 
     geom_hline(yintercept = 1, linetype = 2, colour = "red", size = 0.5) + 
    scale_y_log10(name = "log10(Biomass/Biomass Unfished)")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

###Exploring the model outputs Here we look at some of the ways the
results of the simulation can be explored. We calculate the community
indicators mean maximum weight, mean individual weight, community slope
and the large fish indicator (LFI) over the simulation period, and
compare them to the unexploited values. We also compare the simulated
values of the LFI to a community target based on achieving a high
proportion of the unexploited value of the LFI of .

The indicators are calculated using the functions described in the
section about indicator functions. Here we calculate the LFI and the
other community indicators for the unexploited community. When
calculating these indicators we only include demersal species and
individuals in the size range 10 g to 100 kg, and the LFI is based on
species larger than 40 cm. Each of these functions returns a time
series. We are interested only in the equilibrium unexploited values so
we just select the final time step.

```{r}
salmon_species <- c(#"Chinook_Hatch_Adult","Chinook_Wild_Adult", "Coho_Hatch_Adult", "Coho_Wild_Adult",
                  "Chinook_Hatch_Resident","Chinook_Wild_Resident", "Coho_Hatch_Resident","Coho_Wild_Resident",
                    "Chum_Adult","Sockeye_Adult")
fishery_species <- c(#"Chinook_Hatch_Adult","Chinook_Wild_Adult", "Coho_Hatch_Adult", "Coho_Wild_Adult",
                     "Chinook_Hatch_Resident", "Chinook_Wild_Resident", "Coho_Hatch_Resident",  "Coho_Wild_Resident",
                   # "Chum_Adult","Sockeye_Adult",
                    "Halibut", 
                    "Rockfish",
                    "Lingcod", 
                    "Pacific_Herring",
                    "Small_Planktivorous_Fish",
                    "Other_fish",
                        "Hake")


final <- idxFinalT(sim0)
lfi0 <- getProportionOfLargeFish(sim0, 
                                 #species = salmon_species,
                                 species = fishery_species, 
                                 min_w = 10, max_w = 100e3, 
                                 threshold_l = 40)[[final]]
mw0 <- getMeanWeight(sim0, 
                     #species = salmon_species,
                     species = fishery_species, 
                     min_w = 100, 
                     max_w = 100e3)[[final]]
mmw0 <- getMeanMaxWeight(sim0, 
                         species = fishery_species, 
                         #species = salmon_species,
                         min_w = 10, max_w = 100e3)[final, "mmw_biomass"]
slope0 <- getCommunitySlope(sim0, 
                            species = fishery_species, 
                            #species = salmon_species,
                            min_w = 10, max_w = 100e2)[final, "slope"]

#We also calculate the time series of these indicators for the exploited community:
lfi <- getProportionOfLargeFish(sim_hist, #species = salmon_species,
                                species = fishery_species, 
                                min_w = 10, max_w = 100e3, 
                                threshold_l = 40
                                )
mw <- getMeanWeight(sim_hist,
                    species = fishery_species, 
                    min_w = 100, max_w = 100e3)
mmw <- getMeanMaxWeight(sim_hist, 
                        species = fishery_species, 
                        min_w = 10,
                        max_w = 100e3)[, "mmw_biomass"]
slope <- getCommunitySlope(sim_hist,  
                           species = fishery_species, 
                           min_w = 10,
                           max_w = 100e2)[, "slope"]
```

We can plot the exploited and unexploited indicators, along LFI
reference level. Here we do it using ggplot2 which uses data.frames. We
make three data.frames (one for the time series, one for the unexploited
levels and one for the reference level): Each data.frame is a data.frame
of each of the measures, stacked on top of each other.

```{r}
library(ggplot2)
years <- 1986:2011
# Simulated data
community_plot_data <- rbind(
    data.frame(year = years, measure = "LFI", data = lfi),
    data.frame(year = years, measure = "Mean Weight", data = mw),
    data.frame(year = years, measure = "Mean Max Weight", data = mmw),
    data.frame(year = years, measure = "Slope", data = slope))
# Unexploited data
community_unfished_data <- rbind(
    data.frame(year = years, measure = "LFI", data = lfi0),
    data.frame(year = years, measure = "Mean Weight", data = mw0),
    data.frame(year = years, measure = "Mean Max Weight", data = mmw0),
    data.frame(year = years, measure = "Slope", data = slope0))
# Reference level
community_reference_level <-
    data.frame(year = years, measure = "LFI", data = lfi0 * 0.9)
# Build up the plot
ggplot(community_plot_data) + 
    geom_line(aes(x = year, y = data)) +
    facet_wrap(~measure, scales = "free") + 
    geom_line(aes(x = year, y = data), linetype = "dashed",
              data = community_unfished_data) +
    geom_line(aes(x = year, y = data), linetype = "dotted",
              data = community_reference_level)

```

```{r}
salmon_species <- c(#"Chinook_Hatch_Adult","Chinook_Wild_Adult", "Coho_Hatch_Adult", "Coho_Wild_Adult",
                    # "Chum_Adult","Sockeye_Adult"
                     "Chinook_Hatch_Resident", "Chinook_Wild_Resident", 
                  "Coho_Hatch_Resident",  "Coho_Wild_Resident"
                )

final <- idxFinalT(sim0)
lfi0 <- getProportionOfLargeFish(sim0, 
                                 species = salmon_species,
                                 #species = fishery_species, 
                                 min_w = 10, max_w = 100e3, 
                                 threshold_l = 40)[[final]]
mw0 <- getMeanWeight(sim0, 
                     species = salmon_species,
                     #species = fishery_species, 
                     min_w = 10, max_w = 100e3)[[final]]
mmw0 <- getMeanMaxWeight(sim0, 
                         #species = fishery_species, 
                         species = salmon_species,
                         min_w = 10, max_w = 100e3)[final, "mmw_biomass"]
slope0 <- getCommunitySlope(sim0, 
                           # species = fishery_species, 
                            species = salmon_species,
                            min_w = 10, max_w = 100e3)[final, "slope"]

#We also calculate the time series of these indicators for the exploited community:
lfi <- getProportionOfLargeFish(sim_hist, 
                                species = salmon_species,
                                #species = fishery_species, 
                                min_w = 10, max_w = 100e3, 
                                threshold_l = 40
                                )
mw <- getMeanWeight(sim_hist, 
                    species = salmon_species,
                    #species = fishery_species, 
                    min_w = 10, max_w = 100e3)
mmw <- getMeanMaxWeight(sim_hist, 
                        species = salmon_species, 
                        #species = fishery_species, 
                        min_w = 10,
                        max_w = 100e3)[, "mmw_biomass"]
slope <- getCommunitySlope(sim_hist, 
                           species = salmon_species, 
                           #species = fishery_species, 
                           min_w = 10,
                           max_w = 100e3)[, "slope"]
```

We can plot the exploited and unexploited indicators, along LFI
reference level. Here we do it using ggplot2 which uses data.frames. We
make three data.frames (one for the time series, one for the unexploited
levels and one for the reference level): Each data.frame is a data.frame
of each of the measures, stacked on top of each other.

```{r}
library(ggplot2)
years <- 1986:2011
# Simulated data
community_plot_data <- rbind(
    data.frame(year = years, measure = "LFI", data = lfi),
    data.frame(year = years, measure = "Mean Weight", data = mw),
    data.frame(year = years, measure = "Mean Max Weight", data = mmw),
    data.frame(year = years, measure = "Slope", data = slope))
# Unexploited data
community_unfished_data <- rbind(
    data.frame(year = years, measure = "LFI", data = lfi0),
    data.frame(year = years, measure = "Mean Weight", data = mw0),
    data.frame(year = years, measure = "Mean Max Weight", data = mmw0),
    data.frame(year = years, measure = "Slope", data = slope0))
# Reference level
community_reference_level <-
    data.frame(year = years, measure = "LFI", data = lfi0 * 0.9)
# Build up the plot
ggplot(community_plot_data) + 
    geom_line(aes(x = year, y = data)) +
    facet_wrap(~measure, scales = "free") + 
    geom_line(aes(x = year, y = data), linetype = "dashed",
              data = community_unfished_data) +
    geom_line(aes(x = year, y = data), linetype = "dotted",
              data = community_reference_level)

```

Historical LFI in the region has been below the reference level

the function getBiomass() returns a two-dimensional array (matrix) with
one dimension corresponding to the time and the second dimension to the
species.

```{r}
library(dplyr)
library(plotly)
biomassh <- getBiomass(sim_hist)
str(biomassh)
biomassh_frame <- melt(biomassh)
str(biomassh_frame)
 pp <- plot_ly(biomassh_frame) %>% 
    add_lines(x = ~time, y = ~value, color = ~sp)
pp

pp %>% layout(
    title = "Biomass plot",
    xaxis = list(
        title = "Time [years]"
    ),
    yaxis = list(
        title = "Biomass [g]"
    )
)

fishery_species_biomass <- filter(biomass_frame, 
                              sp %in% c("Chinook_Hatch_Adult","Chinook_Wild_Adult", "Coho_Hatch_Adult", "Coho_Wild_Adult", "Chinook_Hatch_Resident", "Chinook_Wild_Resident", "Coho_Hatch_Resident",  "Coho_Wild_Resident",
                    "Chum_Adult","Sockeye_Adult"#,
                   # "Halibut", 
                  #  "Rockfish",
                   # "Lingcod", 
                   # "Pacific_Herring",
                   # "Small_Planktivorous_Fish",
                   # "Other_fish",
                   #     "Hake"
                   ))
ggplot(fishery_species_biomass) +
    geom_line(aes(x = time, y = value, color = sp))

#getColours(sim_hist)

plot_ly(fishery_species_biomass) %>% 
    add_lines(x = ~time, y = ~value, color = ~sp)#,
            #  colors = getColours(sim_hist))

```

gear_params(new_model_histS)["Chinook_Hatch_Adult,
Chinook_Hatch_Adult_PS", "catchability"] \<-
gear_params(new_model_histS)["Chinook_Hatch_Adult,
Chinook_Hatch_Adult_PS", "catchability"] /2
gear_params(new_model_histS)["Chinook_Wild_Adult,
Chinook_Wild_Adult_PS", "catchability"] \<-
gear_params(new_model_histS)["Chinook_Wild_Adult,
Chinook_Wild_Adult_PS", "catchability"] /2
gear_params(new_model_histS)["Coho_Hatch_Adult, Coho_Hatch_Adult_PS",
"catchability"] \<- gear_params(new_model_histS)["Coho_Hatch_Adult,
Coho_Hatch_Adult_PS", "catchability"] /2
gear_params(new_model_histS)["Coho_Wild_Adult, Coho_Wild_Adult_PS",
"catchability"] \<- gear_params(new_model_histS)["Coho_Wild_Adult,
Coho_Wild_Adult_PS", "catchability"]/2
gear_params(new_model_histS)["Chinook_Hatch_Resident,
Chinook_Hatch_Resident_PS", "catchability"] \<-
gear_params(new_model_histS)["Chinook_Hatch_Resident,
Chinook_Hatch_Resident_PS", "catchability"] /2
gear_params(new_model_histS)["Chinook_Wild_Resident,
Chinook_Wild_Resident_PS", "catchability"] \<-
gear_params(new_model_histS)["Chinook_Wild_Resident,
Chinook_Wild_Resident_PS", "catchability"]/2
gear_params(new_model_histS)["Coho_Hatch_Resident,
Coho_Hatch_Resident_PS", "catchability"] \<-
gear_params(new_model_histS)["Coho_Hatch_Resident,
Coho_Hatch_Resident_PS", "catchability"] /2
gear_params(new_model_histS)["Coho_Wild_Resident,
Coho_Wild_Resident_PS", "catchability"] \<-
gear_params(new_model_histS)["Coho_Wild_Resident,
Coho_Wild_Resident_PS", "catchability"]/2
gear_params(new_model_histS)["Sockeye_Adult, Sockeye_Adult_PS",
"catchability"] \<- gear_params(new_model_histS)["Sockeye_Adult,
Sockeye_Adult_PS", "catchability"] /2
gear_params(new_model_histS)["Chinook_Hatch_Adult, SOG_salmon",
"catchability"] \<- gear_params(new_model_histS)["Chinook_Hatch_Adult,
SOG_salmon", "catchability"] /2
gear_params(new_model_histS)["Chinook_Wild_Adult, SOG_salmon",
"catchability"] \<- gear_params(new_model_histS)["Chinook_Wild_Adult,
SOG_salmon", "catchability"] /2
gear_params(new_model_histS)["Coho_Hatch_Adult, SOG_salmon",
"catchability"] \<- gear_params(new_model_histS)["Coho_Hatch_Adult,
SOG_salmon", "catchability"] /2
gear_params(new_model_histS)["Coho_Wild_Adult, SOG_salmon",
"catchability"] \<- gear_params(new_model_histS)["Coho_Wild_Adult,
SOG_salmon", "catchability"] /2 \### THIS IS THE SYNTAX WE SHOULD BE
USING TO CHANGE PARS (not \@)

species_params(params)\$h[1] \<- 20

###################### 

## OLD CODING

##READ IN NEW GEAR PARAMS - PS ONLY

gear_params2011_allfisheries_250515_PS \<-
read.csv("\~/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/fisheries/time
series fisheries/gear_params2011_allfisheries_250515_noMM_PS.csv") \##
manually change the catchability to match the calibrated model

```{r}
gear_params2011_allfisheries_250515_PSonly <- read.csv("~/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/fisheries/time series fisheries/gear_params2011_allfisheries_250515_PSonly.csv")

new_modelPS <- cur_model

gear_params(new_modelPS)<-gear_params2011_allfisheries_250515_PSonly
#params_e3b1a<- setParams(params_e3b1a)

new_modelPS<- setFishing(new_modelPS)
new_modelPS<- setParams(new_modelPS)

 new_modelPS <-  new_modelPS |> steady() |> 
   matchBiomasses() |> steady() |> matchBiomasses() |> steady() |> 
      matchBiomasses() |> steady() |>  matchBiomasses() |> steady() |> matchBiomasses() |> steady() |> 
     # matchBiomasses() |> steady() |>  matchBiomasses() |> steady() |> matchBiomasses() |> steady() |> 
      matchBiomasses() |> steady() |>  matchBiomasses() |> steady() |> matchBiomasses() |> steady() 

 species_params(new_modelPS)
 #gear_params(cm_cohoupd)
# getReproductionLevel(new_model)
# plotDiet(cm_fishingupd)
 
 sim_fishPS<- project(new_modelPS, t_max = 100,  t_save=5)
animateSpectra(sim_fishPS, power = 2)
 plotlyBiomassRelative(sim_fishPS)

gear_params(new_modelPS       )
```

### TRY TO RUN HISTORICAL MODEL

```{r}
All_fisheries_effort_arrayPS <- as(read.csv("~/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/fisheries/time series fisheries/All_fisheries_effort_array_manualupd_PSonly.csv", row.names = 1), "matrix")

relative_effortPS <- sweep(All_fisheries_effort_arrayPS, 2, All_fisheries_effort_arrayPS["2011", ], "/")
relative_effortPS[as.character(1979:2011), ]

#remove years after 2011
new_rel_effortPS<-head(relative_effortPS,-12)
```

We could just project forward with these relative efforts. However, the
population dynamics in the early years will be strongly determined by
the initial population abundances (known as the transient behaviour -
essentially the initial behaviour before the long term dynamics are
reached). As this is ecology, we don’t know what the initial abundance
are. One way around this is to project forward at a constant fishing
mortality equal to the mortality in the first historical year until
equilibrium is reached. We then use this steady state as the initial
state for the simulation. This approach reduces the impact of transient
dynamics.

```{r}
t_per=5
new_rel_effortPSX<-tail(new_rel_effortPS,-11)
new_model_histPS <- projectToSteady(new_modelPS, 
                                  distance_func = distanceSSLogN,
                                  t_per = 1.5,
                                t_max = 100,
                                dt = 0.1,
                                return_sim = FALSE,
                                 progress_bar = TRUE,
                                tol = 0.79 * t_per,
                                effort = new_rel_effortPSX["1996", ])
```

We now have our parameter object and out matrix of efforts relative to
1979. We use this effort matrix as the effort argument to the project()
function. We use dt = 0.25 (the simulation will run faster than with the
default value of 0.1, but tests show that the results are still stable)
and save the results every year.

```{r}
sim <- project(new_model_histPS, effort = new_rel_effortPSX, t_max=20, dt = 0.1, t_save = 1)
plotlyBiomassRelative(sim)
plotYieldGear(simf)
```

best_model\<-tuned_params2

```{r}
best_model<-tuned_params2
saveParams(best_model, "ss_mizerout2011_pars_250521_newsplitfishing.rds")
dfnew<-(species_params(best_model))

write.csv((species_params(best_model)), 
          "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_Jan25/ss_mizerout2011_pars_250521_newsplitfishing.csv")

write.csv((gear_params(best_model)), 
          "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_Jan25/ss_mizerout2011_gears_250521_newsplitfishing.csv")
saveParams(best_model, "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_Jan25/ss_mizerout2011_pars_250521_newsplitfishing.rds")


```

### TRY TO RUN HISTORICAL MODEL

```{r}

## FIX GEAR PARAMS issues with matching names

#new gear and effort that splits canadian and US fisheries
gear_params2011_allfisheries_250521 <- read.csv("~/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/fisheries/time series fisheries/gear_params2011_allfisheries_250521.csv")
initial_effort(best_model)<-1
gear_params(best_model)<-gear_params2011_allfisheries_250521
best_model<- setParams(best_model)
best_model<- setFishing(best_model)

```

```{r}
#tuned_params3save<-tuned_params3
tuned_params3<-best_model
initial_effort<-1
species_params(tuned_params3)$gamma[1] <- species_params(tuned_params3)$gamma[1]*1.0001
#species_params(tuned_params3)$h[3] <- species_params(tuned_params3)$h[3]*0.999
#species_params(tuned_params3)$gamma[3] <- species_params(tuned_params3)$gamma[3]*1.001

gear_params(tuned_params3)<-gear_params2011_allfisheries_250521
tuned_params3<- setParams(tuned_params3)
tuned_params3<- setFishing(tuned_params3)

 #tuned_params3 <-  tuned_params3 |> steady() |> 
#   matchBiomasses() |> steady() |>  matchBiomasses() |> steady() |> matchBiomasses() #|> steady() |> steady() |> matchBiomasses()|> steady() |> matchBiomasses()|> steady() #|> matchBiomasses()|> steady() |> matchBiomasses()

 species_params(tuned_params3)
 #gear_params(tuned_params3)
 plotGrowthCurves(tuned_params3,species_panel = TRUE)
 getReproductionLevel(tuned_params3)
 plotlyFeedingLevel(tuned_params3)
# plotDiet(cm_fishingupd)
 
 sim_fish<- project(tuned_params3, t_max = 100,  t_save=5)
#animateSpectra(sim_fish, power = 2)
 plotlyBiomassRelative(sim_fish)


```

cur_model\<-tuned_params3

```{r}
All_fisheries_effort_array <- as(read.csv("~/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/fisheries/time series fisheries/All_fisheries_effort_array_250521.csv", row.names = 1), "matrix")

relative_effort <- sweep(All_fisheries_effort_array, 2, All_fisheries_effort_array["2011", ], "/")
relative_effort[as.character(1986:2018), ]

#remove years after 2011 ##33 rows,2011 is at 26 - remove 7 rows
new_rel_effort<-head(relative_effort,-7)
```

We could just project forward with these relative efforts. However, the
population dynamics in the early years will be strongly determined by
the initial population abundances (known as the transient behaviour -
essentially the initial behaviour before the long term dynamics are
reached). As this is ecology, we don’t know what the initial abundance
are. One way around this is to project forward at a constant fishing
mortality equal to the mortality in the first historical year until
equilibrium is reached. We then use this steady state as the initial
state for the simulation. This approach reduces the impact of transient
dynamics.

```{r}
t_per=149
#new_rel_effortX<-tail(new_rel_effort,-11)
new_model_hist <- projectToSteady(cur_model, 
                                  distance_func = distanceSSLogN,
                                 # t_per = 0.5,
                                t_max = 50,
                                dt = 0.1,
                                return_sim = FALSE,
                                 progress_bar = TRUE,
                                tol = 0.001 * t_per,
                                effort = new_rel_effort["1986", ])
```

We now have our parameter object and out matrix of efforts relative to
1979. We use this effort matrix as the effort argument to the project()
function. We use dt = 0.25 (the simulation will run faster than with the
default value of 0.1, but tests show that the results are still stable)
and save the results every year.

```{r}
sim <- project(new_model_hist, effort = new_rel_effort, t_max=20, dt = 0.1, t_save = 1)
plotlyBiomassRelative(sim)
plotYieldGear(simf)
```

## try something else - SPIN UP

Next we use the effort data to project the model forwards from it’s
steady state. But wait - we did not set up the model for the first year
of the data, when fishing only just began. It may make more sense to use
a steady state without fishing as the initial values for our projection.

```{r}
#project to zero fishing rate 
spinup_model<- projectToSteady(cur_model, effort = 0)
sim0<-project(spinup_model,t_max=100, effort=0, t_save=0.1)
plotlyBiomassRelative(sim0)
```

###### HERE 2 JUNE 2025

```{r}
#project with fishing effort

plotlyBiomassRelative(sim_hist, species_panel = TRUE)
plotlyYieldGear(sim_hist, species=salmon_species, total = TRUE, species_panel = TRUE) #+ 
  #  geom_point(data = dat, shape = 1, size = 1, 
  #             mapping = aes(x = Year, y = CatchPerArea))
fr <- plotYieldGear(sim_hist, species=salmon_species, return_data = TRUE)
str(fr)




##predation mortality
write.csv(getM2(sim_hist), "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250527/sim_histfish_predmort.csv") ##

write.csv(fr ,"/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250527/sim_histfish_yieldsalmon.csv")

write.csv(fr ,"/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250527/sim_histfish_yieldsalmon.csv")

### add catches
dat<-read.csv("/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250527/sim_histfish_yieldsalmon_wcatches.csv")

library(plotly)
p1<- pplot_ly(dat, x = ~year, y = ~yield, ) %>% 
  add_points(name = "catch")
subplot(p1, p2)


gg1 <- ggplot(dat, aes(Year, Yield)) + geom_line() +
  facet_wrap(~New_Gear, scales = "free_y", ncol = 1)

# Add markers to the line plot
gg1<- gg1%>% add_trace(x = "Year", y = "Catch", name = "Catch", mode = "markers")



gg1 <- ggplot(dat, aes(x = Year)) +
  geom_line(aes(y = Yield)) +
  geom_point(aes(y = Catch), color = "blue", shape = 16, size = 2) +  # Add points from "Catch"
  facet_wrap(~New_Gear, scales = "free_y", ncol = 1)


gg2 <- ggplot(economics_long, aes(factor(1), value)) +
  geom_violin() +
  facet_wrap(~variable, scales = "free_y", ncol = 1) + 
  theme(axis.text = element_blank(), axis.ticks = element_blank())
subplot(gg1, gg2)

```

### 2 June PLOTTING - points

```{r}
library(ggplot2)
library(readr)
library(dplyr)

# Load and prepare the data
### add catches
dat<-read.csv("/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250527/sim_histfish_yieldsalmon_wcatches.csv")



dat <- dat %>%
  mutate(
    Year = as.numeric(Year),
    Yield = as.numeric(Yield),
    Catch = as.numeric(Catch)
  )

# Define selected gears
selected_gears <- c(
  "Chinook_Hatch_Adult_PS", "Chinook_Wild_Adult_PS",
  "Chinook_Hatch_Resident_PS", "Chinook_Wild_Resident_PS",
  "Coho_Hatch_Adult_PS", "Coho_Wild_Adult_PS",
  "Coho_Hatch_Resident_PS", "Coho_Wild_Resident_PS"
)

# Filter the data
dat_filtered <- dat %>%
  filter(New_Gear %in% selected_gears)

# Plot (correctly terminated)
plotPS<- ggplot(dat_filtered, aes(x = Year)) +
  geom_line(aes(y = Yield), color = "darkgreen") +
  geom_point(aes(y = Catch), color = "blue", size = 2) +
  facet_wrap(~New_Gear, scales = "free_y", ncol = 2) +
  labs(
    title = "Yield and Catch Over Time (Selected Gears)",
    y = "Value",
    x = "Year"
  ) +
  theme_minimal()
plotPS

# Define selected gears
selected_gears3 <- c(
  "Chinook_Hatch_Adult-SOG_recreational", "Chinook_Wild_Adult-SOG_recreational",
  "Chinook_Hatch_Resident-SOG_recreational", "Chinook_Wild_Resident-SOG_recreational"#,
 # "Coho_Hatch_Adult-SOG_recreational", "Coho_Wild_Adult-SOG_recreational",
 # "Coho_Hatch_Resident-SOG_recreational", "Coho_Wild_Resident-SOG_recreational"
)

# Filter the data
dat_filtered <- dat %>%
  filter(New_Gear %in% selected_gears3)

# Plot (correctly terminated)
plot_SOGr<- ggplot(dat_filtered, aes(x = Year)) +
  geom_line(aes(y = Yield), color = "darkgreen") +
  geom_point(aes(y = Catch), color = "blue", size = 2) +
  facet_wrap(~New_Gear, scales = "free_y", ncol = 1, nrow=4) +
  labs(
    title = "Yield and Catch Over Time (Selected Gears)",
    y = "Value",
    x = "Year"
  ) +
  theme_minimal()

plot_SOGr


# Define selected gears
selected_gears2 <- c(
  "Chinook_Hatch_Adult-SOG_commercial", "Chinook_Wild_Adult-SOG_commercial",
  "Chinook_Hatch_Resident-SOG_commercial", "Chinook_Wild_Resident-SOG_commercial"#,
#  "Coho_Hatch_Adult-SOG_commercial", "Coho_Wild_Adult-SOG_commercial",
#  "Coho_Hatch_Resident-SOG_commercial", "Coho_Wild_Resident-SOG_commercial"
)


# Filter the data
dat_filtered <- dat %>%
  filter(New_Gear %in% selected_gears2)


# Plot (correctly terminated)
plot_SOGc <- ggplot(dat_filtered, aes(x = Year)) +
  geom_line(aes(y = Yield), color = "darkgreen") +
  geom_point(aes(y = Catch), color = "blue", size = 2) +
  facet_wrap(~New_Gear, scales = "free_y", ncol = 1, nrow = 4) +
  labs(
    title = "Yield and Catch Over Time (Selected Gears)",
    y = "Value",
    x = "Year"
  ) +
  theme_minimal()


plot_SOGc

subplot(plot_SOGc, plot_SOGr)
```

###sum across species

```{r}
library(ggplot2)
library(readr)
library(dplyr)

# Load and prepare the data
#dat <- read_csv("sim_histfish_yieldsalmon_wcatches.csv")

# Define selected gears
selected_gears <- c(
  "Chinook_Hatch_Adult_PS", "Chinook_Wild_Adult_PS",
  "Chinook_Hatch_Resident_PS", "Chinook_Wild_Resident_PS",
  "Coho_Hatch_Adult_PS", "Coho_Wild_Adult_PS",
  "Coho_Hatch_Resident_PS", "Coho_Wild_Resident_PS"
)

# Summarize by Species and Year
dat_summary <- dat %>%
  filter(New_Gear %in% selected_gears) %>%
  group_by(Species, Year) %>%
  summarise(
    Yield = sum(Yield, na.rm = TRUE),
    Catch = sum(Catch, na.rm = TRUE),
    .groups = "drop"
  )

# Plot: one column, 4 rows (one per species)
plot_species <- ggplot(dat_summary, aes(x = Year)) +
  geom_line(aes(y = Yield), color = "darkgreen") +
  geom_point(aes(y = Catch), color = "blue", size = 2) +
  facet_wrap(~Species, ncol = 2, nrow = 4, scales = "free_y") +
  labs(
    title = "Total Yield and Catch Over Time by Species",
    y = "Total Value",
    x = "Year"
  ) +
  theme_minimal()

plot_species
```

```{r}
library(ggplot2)
library(readr)
library(dplyr)

# Load and prepare the data
#dat <- read_csv("sim_histfish_yieldsalmon_wcatches.csv")

# Define selected gears
selected_gears <- c(
  "Chinook_Hatch_Adult_PS", "Chinook_Wild_Adult_PS",
  "Chinook_Hatch_Resident_PS", "Chinook_Wild_Resident_PS",
  "Coho_Hatch_Adult_PS", "Coho_Wild_Adult_PS",
  "Coho_Hatch_Resident_PS", "Coho_Wild_Resident_PS"
)

# Summarize by Species and Year
dat_summary <- dat %>%
  filter(New_Gear %in% selected_gears) %>%
  group_by(Species, Year) %>%
  summarise(
    Yield = sum(Yield, na.rm = TRUE),
    Catch = sum(Catch, na.rm = TRUE),
    .groups = "drop"
  )

# Plot with bars for Catch and line for Yield
plot_species <- ggplot(dat_summary, aes(x = Year)) +
  geom_col(aes(y = Catch), fill = "blue", alpha = 0.3) +  # faded bars for Catch
  geom_line(aes(y = Yield), color = "darkgreen", size = 1) +  # line for Yield
  facet_wrap(~Species, ncol = 2, nrow = 4, scales = "free_y") +
  labs(
    title = "Total Yield and Catch Over Time by Species",
    y = "Total Value",
    x = "Year"
  ) +
  theme_minimal()

plot_species
```

```{r}
#cur_model = sim_hist
### FISHING=0

 
write.csv(getBiomass(sim_hist), "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250527/sim_fishing_hist_biomass.csv") ##fishing=0

write.csv(getN(sim_hist), "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250527/sim_fishing_hist_N.csv") ##fishing=0

#PROP LARGE FISH
write.csv(getProportionOfLargeFish(sim_hist), "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250527/sim_fishing_hist_proplrgfish.csv") ##fishing=0

#SPAWNING STOCK BIOMASS
write.csv(getSSB(sim_hist), "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250527/sim_fishing_hist_SSB.csv") ##

##predation mortality
write.csv(getM2(sim_hist), "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250527/sim_fishing_hist_predmort.csv") 

## yield
write.csv(getYield(sim_hist), "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250527/sim_fishing_hist_yield.csv")

```

```{r}
#project with fishing effort
#new_rel_effortX<-tail(new_rel_effort,-17)
simf <- project(spinup_model, effort = (new_rel_effort*0.1))
plotlyBiomassRelative(simf)
plotlyYieldGear(simf) #+ 
   # geom_point(data = dat, shape = 1, size = 1, 
    #           mapping = aes(x = Year, y = CatchPerArea))
```

###NEXT STEPS - PLOT WITH CATCHES TO SEE FIT!!!

```{r}
#project with fishing effort
new_rel_effortX<-tail(new_rel_effort,-17)
params3 <- setInitialValues(new_model0, sim0)
simf3 <- project(params3, effort = new_rel_effortX)
plotlyBiomassRelative(simf3)
plotlyYieldGear(simf3) #+ 
   # geom_point(data = dat, shape = 1, size = 1, 
    #           mapping = aes(x = Year, y = CatchPerArea))
```

##14 May 2025

What if we only have catch data? What if there was no effort data and
only catch data? This is the case for many data-poor fisheries or for
fisheries where there is only restricted access to effort data.

Many fisheries develop through time according to phases: an exponential
growth period, following either a peak and subsequent decline and a
plateau, if stocks drop below sustainable levels and management kicks in
(see here for example). These different types of development can be
represented by a function, logistic_effort(), and can be used to help
estimate the fishing parameters given the the model parameters and data
you may have. This is the approach used here. Here, we will use this
function to explore effort through time.

```{r}
logistic_effort <- function(effort_array,
                           # gear = "longline",
                            time = 1979:2011,
                            Fmax = 1.5,
                            steepness = 0.2,
                            midpoint = 2005) {
    effort_array[, gear] <- Fmax / (1 + exp(-steepness*(time - midpoint)))
    return(effort_array)
}
```

After using the above function we can scale the effort up to the effort
units we used in our base model. We do this by setting the Fmax in the
logistic equation to the desired level of fishing mortality rate (e.g.
0.005 was used above but for this example we will plug in a different
value to explore heavier fishing). We then divide Fmax by our estimated
catchability coefficient (which was estimated to be a very small number)
to get effort in the correct ballpark and units as the data we used
above. If you want to run the model directly with fishing mortality rate
as the “effort” driver, you would need to set the catchability
coefficient to 1 in this example. If no effort exists for your system,
we would need to estimate the catchability coefficient (either by hand
tuning or statistical time-series fitting).

```{r}
neweffort <- logistic_effort(effort_time, time = 1979:2011, Fmax = 0.5,
                             steepness = 0.9, midpoint = 1995)

#rescale to get effort in same units as our example
neweffort <- neweffort / gear_params(params_e1)$catchability[1]

# or if you want to just use fishing mortality only in your model, 
# overwrite the catchability to 1:
 gear_params(params_e1)$catchability[1] <- 1

year = 1979:2011
qplot(year, neweffort, ylab = "effort", xlab = "")

```

##### MORE SCENARIOS AND OUTPUTS

```{r}
cur_model = params_e1
### FISHING=0

 
 sim_4a0 <- project(cur_model, effort=0, t_max = 100)
animateSpectra(sim_4a0, power = 2)
 plotlyBiomassRelative(sim_4a0)


write.csv(getBiomass(sim_4a0), "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250422/sim_fishing0_biomass.csv") ##fishing=0

write.csv(getN(sim_4a0), "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250422/sim_fishing0_N.csv") ##fishing=0

#PROP LARGE FISH
write.csv(getProportionOfLargeFish(sim_4a0), "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250422/sim_fishing0_proplrgfish.csv") ##fishing=0

#SPAWNING STOCK BIOMASS
write.csv(getSSB(sim_4a0), "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250422/sim_fishing0_SSB.csv") ##

##predation mortality
write.csv(getM2(sim_4a0), "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250422/sim_fishing0_predmort.csv") 

## yield
write.csv(getYield(sim_4a0), "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250422/sim_fishing0_yield.csv")





### SIM - INCREASE FISHING
 
 sim_4a1 <- project(cur_model, effort=1.5, t_max = 100)
animateSpectra(sim_4a1, power = 2)
 plotlyBiomassRelative(sim_4a1)


write.csv(getBiomass(sim_4a1), "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250422/sim_fishing1.5_biomass.csv") ##fishing=0
write.csv(getN(sim_4a1), "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250422/sim_fishing1.5_N.csv") ##

#PROP LARGE FISH
write.csv(getProportionOfLargeFish(sim_4a1), "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250422/sim_fishing1.5_proplrgfish.csv") ##

#SPAWNING STOCK BIOMASS
write.csv(getSSB(sim_4a1), "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250422/sim_fishing1.5_SSB.csv") ##

##predation mortality
write.csv(getM2(sim_4a1), "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250422/sim_fishing1.5_predmort.csv") ##

## yield
write.csv(getYield(sim_4a1), "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250422/sim_fishing1.5_yield.csv") 

```

### 

write.csv(getBiomass(simte3b1a),
"/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250221/sim_fishing1.5_incrsalmInitbiom_biomass.csv")
##fishing=0

dat\<-
read.csv("/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250221/sim_fishing1.2_nosalmcatch_biomass.csv")
#simte3b1a2 dat\<-
read.csv("/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250221/sim_fishing1.2_nosalmcatch_predmort.csv")

datN\<-
read.csv("/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250221/sim_fishing1.2_nosalmcatch_proplrgfish.csv")

#read.csv("/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250221/plots.csv")

# Create a side-by-side layout

par(mfrow = c(1,1))

# Create the first plot

plot(dat$Year, dat$Prop.Lrg.Fish, type = 'l', col = 'purple', xlab =
'Year', ylab = 'biomass',main="Prop Lrg Fish")
#points(daty$Year, daty$Invertebrates, type = 'l', col = 'red')

# Create a side-by-side layout

par(mfrow = c(4,4))

# Create the first plot

plot(dat$Year, dat$Invertebrates, type = 'l', col = 'blue', xlab =
'Year', ylab = 'biomass',main="Invertebrates")
points(daty$Year, daty$Invertebrates, type = 'l', col = 'red')

plot(dat$Year, dat$Chinook_Hatch_Adult, type = 'l', col = 'blue', xlab =
'Year', ylab = 'biomass', main="Chinook_Hatch_Adult")

plot(dat$Year, dat$Chinook_Hatch_Resident, type = 'l', col = 'blue',
xlab = 'Year', ylab = 'biomass', main="Chinook_Hatch_Resident")

plot(dat$Year, dat$Chinook_Wild_Adult, type = 'l', col = 'blue', xlab =
'Year', ylab = 'biomass',main="Chinook_Wild_Adult")

plot(dat$Year, dat$Chinook_Wild_Resident, type = 'l', col = 'blue', xlab
= 'Year', ylab = 'biomass',main="Chinook_Wild_Resident")

plot(dat$Year, dat$Coho_Hatch_Adult, type = 'l', col = 'blue', xlab =
'Year', ylab = 'biomass',main="Coho_Hatch_Adult")

plot(dat$Year, dat$Coho_Hatch_Resident, type = 'l', col = 'blue', xlab =
'Year', ylab = 'biomass',main="Coho_Hatch_Resident")

plot(dat$Year, dat$Coho_Wild_Adult, type = 'l', col = 'blue', xlab =
'Year', ylab = 'biomass',main="Coho_Wild_Adult")

plot(dat$Year, dat$Coho_Wild_Resident, type = 'l', col = 'blue', xlab =
'Year', ylab = 'biomass',main="Coho_Wild_Resident")

plot(dat$Year, dat$Hake, type = 'l', col = 'blue', xlab = 'Year', ylab =
'biomass',main="Hake")

plot(dat$Year, dat$Rockfish, type = 'l', col = 'blue', xlab = 'Year',
ylab = 'biomass',main="Rockfish")

plot(dat$Year, dat$Harbor_seals, type = 'l', col = 'blue', xlab =
'Year', ylab = 'biomass',main="Harbor_seals")

plot(dat$Year, dat$Steller_sealions, type = 'l', col = 'blue', xlab =
'Year', ylab = 'biomass',main="Steller_sealions")

plot(dat$Year, dat$Resident_Orca_S, type = 'l', col = 'blue', xlab =
'Year', ylab = 'biomass',main="SRKW")

plot(dat$Year, dat$Resident_Orca_N, type = 'l', col = 'blue', xlab =
'Year', ylab = 'biomass',main="NRKW")

### INCREASE HATCHERY PRODUCTION - PULSE

```{r}
params_e3b1a<-cur_model

#species_params(params_e3b1)$h[4] <- species_params(params_e3b1)$h[5]
species_params(params_e3b1a)$biomass_observed[4] <- species_params(params_e3b1a)$biomass_observed[4]*2
species_params(params_e3b1a)$biomass_observed[6] <- species_params(params_e3b1a)$biomass_observed[6]*2
species_params(params_e3b1a)$biomass_observed[10] <- species_params(params_e3b1a)$biomass_observed[10]*2
species_params(params_e3b1a)$biomass_observed[12] <- species_params(params_e3b1a)$biomass_observed[12]*2
species_params(params_e3b1a)$biomass_observed[9] <- species_params(params_e3b1a)$biomass_observed[9]*2
gear_params(params_e3b1a)["Sockeye_Adult, knife_edge_gear", "catchability"] <- gear_params(params_e3b1a)["Sockeye_Adult, knife_edge_gear", "catchability"]*0.9

params_e3b1a<- setParams(params_e3b1a)
 params_e3b1a<- setFishing(params_e3b1a)
# params_e3b1a <-  params_e3b1a |> steady() |> 
 #  matchBiomasses() |> steady() |> matchBiomasses() |> steady() |> 
 #     matchBiomasses() |> steady() |>  matchBiomasses() |> steady() |> matchBiomasses() |> steady() 

 species_params(params_e3b1a)
 #getReproductionLevel(params_e3b1a)
 #plotDiet(params_e3b1a)
 
 
 
 simte3b1a <- project(params_e3b1a, effort=1.5, t_max = 100)
animateSpectra(simte3b1a, power = 2)
 plotlyBiomassRelative(simte3b1a)

```

```{r}
### SIM - INCREASE SALMON ADULT RETURNS (CHINOOK PRODUCTIVITY)
 
write.csv(getBiomass(simte3b1a), "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250221/sim_ChinAincrease10x_biomass.csv") ##fishing=0
write.csv(getN(simte3b1a), "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250221/ChinAincrease10x_N.csv") ##

#PROP LARGE FISH
write.csv(getProportionOfLargeFish(simte3b1a), "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250221/sim_ChinAincrease10x_proplrgfish.csv") ##

#SPAWNING STOCK BIOMASS
write.csv(getSSB(simte3b1a), "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250221/sim_ChinAincrease10x_SSB.csv") ##

##predation mortality
write.csv(getM2(simte3b1a), "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250221/sim_ChinAincrease10x_predmort.csv") ##

## yield
write.csv(getYield(simte3b1a), "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/outputs_250221/sim_ChinAincrease10x_yield.csv") 
```

### INCREASE HATCHERY PRODUCTION - PULSE

```{r}
params_e3b1a2<-cur_model

#species_params(params_e3b1)$h[4] <- species_params(params_e3b1)$h[5]
#species_params(params_e3b1a)$biomass_observed[4] <- species_params(params_e3b1a)$biomass_observed[4]*2
#species_params(params_e3b1a)$biomass_observed[6] <- species_params(params_e3b1a)$biomass_observed[6]*2
#species_params(params_e3b1a)$biomass_observed[10] <- species_params(params_e3b1a)$biomass_observed[10]*2
#species_params(params_e3b1a)$biomass_observed[12] <- species_params(params_e3b1a)$biomass_observed[12]*2
#species_params(params_e3b1a)$biomass_observed[10:11] <- species_params(params_e3b1a)$biomass_observed[10:11]*2

gear_params(params_e3b1a2)["Chinook_Hatch_Adult, knife_edge_gear", "catchability"] <- 0
gear_params(params_e3b1a2)["Chinook_Wild_Adult, knife_edge_gear", "catchability"] <- 0
gear_params(params_e3b1a2)["Coho_Hatch_Adult, knife_edge_gear", "catchability"] <- 0
gear_params(params_e3b1a2)["Coho_Wild_Adult, knife_edge_gear", "catchability"] <- 0
gear_params(params_e3b1a2)["Chinook_Hatch_Resident, knife_edge_gear", "catchability"] <- 0
gear_params(params_e3b1a2)["Chinook_Wild_Resident, knife_edge_gear", "catchability"] <- 0
gear_params(params_e3b1a2)["Coho_Hatch_Resident, knife_edge_gear", "catchability"] <- 0
gear_params(params_e3b1a2)["Coho_Wild_Resident, knife_edge_gear", "catchability"] <- 0
gear_params(params_e3b1a2)["Sockeye_Adult, knife_edge_gear", "catchability"] <- gear_params(params_e3b1a2)["Sockeye_Adult, knife_edge_gear", "catchability"]/2



params_e3b1a2<- setParams(params_e3b1a2)
 params_e3b1a2<- setFishing(params_e3b1a2)
# params_e3b1a <-  params_e3b1a |> steady() |> 
 #  matchBiomasses() |> steady() |> matchBiomasses() |> steady() |> 
 #     matchBiomasses() |> steady() |>  matchBiomasses() |> steady() |> matchBiomasses() |> steady() 

 #species_params(params_e3b1a)
 #getReproductionLevel(params_e3b1a)
 #plotDiet(params_e3b1a)
 
 
 
 simte3b1a2 <- project(params_e3b1a2, effort=1.2, t_max = 100)
animateSpectra(simte3b1a2, power = 2)
 plotlyBiomassRelative(simte3b1a2)

```

```{r}

 
 simte3b1b <- project(params_e3b1a, effort=1.1,
                      t_max = 100)
animateSpectra(simte3b1b, power = 2)
 plotlyBiomassRelative(simte3b1b)

```

### ADD SEAL FISHING

```{r}
params_e3b1b<-params_e4a1b


gear_params(params_e3b1b)$yield_observed[19] <-  (species_params(params_e3b1b)$biomass_observed[19])/2
gear_params(params_e3b1b)$catchability[19] <- 0.5
gear_params(params_e3b1b)$knife_edge[19] <- 40000
gear_params(params_e3b1b)$knife_edge_size[19] <- 40000
gear_params(params_e3b1b)$rec_age_fish[19]<-4

species_params(params_e3b1b)$erepro[25] <- 0.08
species_params(params_e3b1b)$gamma[25] <- species_params(params_e3b1b)$gamma[25]*1.8 #2
species_params(params_e3b1b)$h[25] <- species_params(params_e3b1b)$h[25]*0.95 #0.95

params_e3b1b<- setParams(params_e3b1b)
 
# params_e3b1b <-  params_e3b1b |> steady() |> 
#   matchBiomasses() |> steady() |> matchBiomasses() |> steady() |> 
#      matchBiomasses() |> steady() |>  matchBiomasses() |> steady() |> matchBiomasses() |> steady() 

 species_params(params_e3b1b)
 getReproductionLevel(params_e3b1b)
 plotFeedingLevel(params_e3b1b)
 plotGrowthCurves(params_e3b1b,species_panel = TRUE)
 
 
 simte3b1b <- project(params_e3b1b, effort=1, t_max = 50,  t_save=5)
animateSpectra(simte3b1b, power = 2)
 plotlyBiomassRelative(simte3b1b)

```

```{r}
#params_e3b1b<-cur_model

simte3b1b <- project(params_e3b1b, effort=1.05, t_max = 50,  t_save=5)
animateSpectra(simte3b1b, power = 2)
 plotlyBiomassRelative(simte3b1b)
 plotlyBiomass(simte3b1b)

```

### CHANGE FISHING EFFORT FOR SALMON

```{r}

ss_gear_params_new =  read.csv("/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_Jan25/gear_params_Feb2025.csv")


```

#### NEW GEARS?????

```{r}
cm_fishing<- params_sealupd
#effort <- c(Industrial = 0, Pelagic = 1, Beam = 0.3, Otter = 0.7)

gear_params(cm_fishing)<-ss_gear_params_new 


cm_fishing<- setFishing(cm_fishing)
initial_effort(cm_fishing)=1
 
cm_fishing <-  cm_fishing |> steady() |> 
    matchBiomasses() |> steady() |> matchBiomasses() |> steady()  |> 
      matchBiomasses() |> steady() |>  matchBiomasses() |> steady() |> matchBiomasses() |> steady()  |> 
      matchBiomasses() |> steady() |>  matchBiomasses() |> steady() |> matchBiomasses() |> steady() |> 
      matchBiomasses() |> steady() |>  matchBiomasses() |> steady() |> matchBiomasses() |> steady() 

summary(cm_fishing)
species_params(cm_fishing)
gear_params(cm_fishing)
```

<https://sizespectrum.org/mizer/articles/a_multispecies_model_of_the_north_sea.html#future-projections>

### NO FISHING OF CHINOOK

some ecamples #effort \<- c(Industrial = 0, Pelagic = 1, Beam = 0.3,
Otter = 0.7)

```{r}

cm_fishing=params_sealupd

# Change the catchability of salmon
gear_params(cm_fishing)["Chinook_Hatch_Adult, knife_edge_gear", "catchability"] <- 0
gear_params(cm_fishing)["Chinook_Wild_Adult, knife_edge_gear", "catchability"] <- 0
gear_params(cm_fishing)["Coho_Hatch_Adult, knife_edge_gear", "catchability"] <- 0
gear_params(cm_fishing)["Coho_Wild_Adult, knife_edge_gear", "catchability"] <- 0
gear_params(cm_fishing)["Chinook_Hatch_Resident, knife_edge_gear", "catchability"] <- 0
gear_params(cm_fishing)["Chinook_Wild_Resident, knife_edge_gear", "catchability"] <- 0
gear_params(cm_fishing)["Coho_Hatch_Resident, knife_edge_gear", "catchability"] <- 0
gear_params(cm_fishing)["Coho_Wild_Resident, knife_edge_gear", "catchability"] <- 0

cm_fishing<- setFishing(cm_fishing)

 simcmf <- project(cm_fishing, t_max = 50, effort=1.5, t_save=5)
animateSpectra( simcmf , power = 2)
 plotlyBiomassRelative( simcmf )

```

```{r}

 simcmf <- project(cm_fishing, t_max = 100, effort=1.5, t_save=0.5)
animateSpectra( simcmf , power = 2)
 plotlyBiomassRelative( simcmf )

```

### REMOVE SALMON REMOVALS

```{r}

### REMOVE SALMON FISHING 
effort_new <- c( Invertebrates = 1,
Pacific_Herring= 1,
Small_Planktivorous_Fish= 1,
Salmon_chinook= 0,
Salmon_chinook= 0,
Salmon_coho= 0,
Salmon_coho= 0,
Salmon_chum= 1,
Salmon_sockeye= 1,
Salmon_chinook= 0,
Salmon_chinook= 0,
Salmon_coho= 0,
Salmon_coho= 0,
Hake= 1,
Lingcod= 1,
Rockfish= 1,
Other_fish= 1,
Halibut= 1,
Seal_mort = 0,
Pinniped_bycatch = 0,
Pinniped_bycatch = 0,
Cetacean_bycatch = 0,
Incidental = 0,
Incidental = 0,
Incidental = 0)

 simcmf <- project(cm_fishing, t_max = 50, effort=effort_new, t_save=5)
animateSpectra( simcmf , power = 2)
 plotlyBiomassRelative( simcmf )
  plotlyBiomass( simcmf )

```

### ADD SEAL FISHING

```{r}

cm_fishing_updseal<- cm_fishing

### REMOVE SALMON FISHING 
effort_new <- c( Invertebrates = 1,
Pacific_Herring= 1,
Small_Planktivorous_Fish= 1,
Salmon_chinook= 1,

Salmon_coho= 1,

Salmon_chum= 1,
Salmon_sockeye= 1,

Hake= 1,
Lingcod= 1,
Rockfish= 1,
Other_fish= 1,
Halibut= 1,
Seal_mort = 0.5,
Pinniped_bycatch = 0,
Pinniped_bycatch = 0,
Cetacean_bycatch = 0,
Incidental = 0,
Incidental = 0,
Incidental = 0)

gear_params(cm_fishing_updseal)$yield_observed[19] <-  (species_params(cm_fishing_updseal)$biomass_observed[19])/20
gear_params(cm_fishing_updseal)$catchability[19] <- 0.05
gear_params(cm_fishing_updseal)$knife_edge[19] <- 40000
gear_params(cm_fishing_updseal)$knife_edge_size[19] <- 40000
gear_params(cm_fishing_updseal)$rec_age_fish[19]<-4


cm_fishing_updseal<- setParams(cm_fishing_updseal)

 simcmf <- project(cm_fishing_updseal, t_max = 50, effort=effort_new*1.01, t_save=0.5)
animateSpectra( simcmf , power = 2)
 plotlyBiomassRelative( simcmf )
  plotlyBiomass( simcmf )

```

```{r}
params_1979<-params_e3b1
  
params_1979@species_params$biomass_observed[1:24]<- c(
45458680000,
350000000000,
179541020000,
303660000,
997740000,
331800000,
1090200000,
6738318097,
51740152331,
187272655,
536436688,
37614570,
173027022,
1.09633E+11,
1678320000,
17954102000,
20030200000,
465595200,
411148936,
1285000000,
224426275,
203803320,
419460000,
104930000)


params_1979<- setParams(params_1979)
 
 params_1979<-  params_1979 |> steady() |> 
   matchBiomasses() |> steady() |> matchBiomasses() |> steady() |> 
   matchBiomasses() |> steady() |>  matchBiomasses() |> steady() |> 
     matchBiomasses() |> steady() |>  matchBiomasses() |> steady() |> matchBiomasses() |> steady() 
 

 getReproductionLevel(params_1979)
 plotDiet(params_1979)#, species = "California_sea_lions")
plotGrowthCurves(params_1979, species_panel = TRUE)
plotlyFeedingLevel(params_1979)

 
 species_params(params_1979)
 sim1979 <- project(params_1979, t_max = 40)
animateSpectra(sim1979, power = 2)
 plotlyBiomassRelative(sim1979)

```

```{r}
 species_params(params_1979)
 sim1979_e1 <- project(params_1979, effort=1.05 , t_max = 40)
animateSpectra(sim1979_e1, power = 2)
 plotlyBiomassRelative(sim1979_e1)

```

### PROJECTING HISTORIC LEVELS

In this model we are interested in projecting forward using historical
fishing mortalities. The historical fishing mortality from 1967 to 2010
for each species is stored in the csv file NS_f_history.csv included in
the package. As before, we can use read.csv() to read in the data. This
reads the data in as a data.frame. We want this to be a matrix so we use
the as() function:

```{r}
f_location <- system.file("extdata", "NS_f_history.csv", package = "mizer")
f_history <- as(read.csv(f_location, row.names = 1), "matrix")
#We can take a look at the first years of the data:

head(f_history)

```

Fishing mortality is calculated as the product of selectivity,
catchability and fishing effort. The values in f_history are absolute
levels of fishing mortality. We have seen that the fishing mortality in
the mizer simulations is driven by the fishing effort argument passed to
the project() function. Therefore if we want to project forward with
historical fishing levels, we need to provide project() with effort
values that will result in these historical fishing mortality levels.

One of the model parameters that we have not really considered so far is
catchability. Catchability is a scalar parameter used to modify the
fishing mortality at size given the selectivity at size and effort of
the fishing gear. By default catchability has a value of 1, meaning that
an effort of 1 results in a fishing mortality of 1 for a fully selected
species. When considering the historical fishing mortality, one option
is therefore to leave catchability at 1 for each species and then use
the f_history matrix as the fishing effort. However, an alternative
method is to use the effort relative to a chosen reference year. This
can make the effort levels used in the model more meaningful. Here we
use the year 1990 as the reference year. If we set the catchability of
each species to be the same as the fishing mortality in 1990 then an
effort of 1 in 1990 will result in the fishing mortality being what it
was in 1990. The effort in the other years will be relative to the
effort in 1990.

```{r}
gear_params$catchability <- as.numeric(f_history["1990", ])


```

Considering the other model parameters, we will use default values for
all of the other parameters apart from kappa, the carrying capacity of
the resource spectrum (see see the section on resource density). This
was estimated along with the values R_max as part of the calibration
process.

We now have all the information we need to create the MizerParams object
using the species parameters data.frame.

```{r}
params <- newMultispeciesParams(NS_species_params, 
                                interaction = inter, 
                                kappa = 9.27e10,
                                gear_params = gear_params)
## Because you have n != p, the default value for `h` is not very good.
## Because the age at maturity is not known, I need to fall back to using
## von Bertalanffy parameters, where available, and this is not reliable.
## No ks column so calculating from critical feeding level.
## Using z0 = z0pre * w_max ^ z0exp for missing z0 values.
## Using f0, h, lambda, kappa and the predation kernel to calculate gamma.

```

Setting up and running the simulation As we set our catchability to be
the level of fishing mortality in 1990, before we can run the projection
we need to rescale the effort matrix to get a matrix of efforts relative
to 1990. To do this we want to rescale the f_history object to 1990 so
that the relative fishing effort in 1990 = 1. This is done using R
function sweep(). We then check a few rows of the effort matrix to check
this has happened:
```{r}
relative_effort \<- sweep(f_history, 2, f_history["1986", ], "/")

params \<- projectToSteady(params, effort = relative_effort["1986", ])


sim \<- project(params, effort = relative_effort, dt = 0.25, t_save = 1)
Plotting the results, we can see how the biomasses of the stocks change
over time.

plotBiomass(sim)

Read in new biomass 1979

45458680000, 350000000000, 179541020000, 303660000, 997740000,
331800000, 1090200000, 6738318097, 51740152331, 187272655, 536436688,
37614570, 173027022, 72175490040, 1678320000, 17954102000, 20030200000,
465595200, 411148936, 1285000000, 224426275, 203803320, 72112600,
41570000

```{r}
params_1979<-params_e2
  
params_1979@species_params$biomass_observed[1:24]<- c(
45458680000,
350000000000,
179541020000,
303660000,
997740000,
331800000,
1090200000,
6738318097,
51740152331,
187272655,
536436688,
37614570,
173027022,
8896090040,
1678320000,
17954102000,
20030200000,
465595200,
411148936,
1285000000,
224426275,
203803320,
72112600,
41570000)


params_1979<- setParams(params_1979)
 
 params_1979<-  params_1979 |> steady() |> 
  # matchBiomasses() |> steady() |> matchBiomasses() |> steady() |> 
 #  matchBiomasses() |> steady() |>  matchBiomasses() |> steady() |> 
     matchBiomasses() |> steady() |>  matchBiomasses() |> steady() |> matchBiomasses() |> steady() 
 

 getReproductionLevel(params_1979)
 plotDiet(params_1979)#, species = "California_sea_lions")
plotGrowthCurves(params_1979, species_panel = TRUE)
plotlyFeedingLevel(params_1979)

 
 species_params(params_1979)
 sim1979 <- project(params_1979, t_max = 40)
animateSpectra(sim1979, power = 2)
 plotlyBiomassRelative(sim1979)

```

```{r}
 species_params(params_1979)
 sim1979_e1 <- project(params_1979, effort=1.05 , t_max = 40)
animateSpectra(sim1979_e1, power = 2)
 plotlyBiomassRelative(sim1979_e1)

```

```{r}
 species_params(cm2)
 simtcm21 <- project(cm2, effort=1.1, t_max = 30,t_save=3)
animateSpectra(simtcm21, power = 2)
 plotlyBiomassRelative(simtcm21)
 
dftcm21_biomass<-as.data.frame(getBiomass(simtcm21))
write.csv(dftcm21_biomass, "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_May24/ss_mizer_output_getBioSim_240617.csv")

# Calculate relative proportional biomass
biomass1<-getBiomass(simtcm21)
rel_biom <- dftcm21_biomass %>%
group_by(names(dftcm21_biomass)) %>%
  mutate(rel_chng=(x/first(x)-1))


write.csv(dftcm21_biomass_rel, "/Users/vivtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Salish_Sea/ss_pars_May24/ss_mizer_output_getBioRelSim_240617.csv")

dftcm21_biomass$time<-c(0,3,6,9,12,15,18,21,24,27,30)

new_bio<- dftcm21_biomass %>%
  pivot_longer(!time,
               names_to = "species", 
               values_to = "biomass")  
c25 <- c(
  "dodgerblue2", "#E31A1C", # red
  "green4",
  "#6A3D9A", # purple
  "#FF7F00", # orange
  "black", "gold1",
  "skyblue2", "#FB9A99", # lt pink
  "palegreen2",
  "#CAB2D6", # lt purple
  "#FDBF6F", # lt orange
  "gray70", "khaki2",
  "maroon", "orchid1", "deeppink1", "blue1", "steelblue4",
  "darkturquoise", "green1", "yellow4", "yellow3",
  "darkorange4", "brown"
)

ggplot(data=new_bio, aes( x=time, y=biomass, group=species))+
   geom_line(aes(color=species))+
   #  geom_line(aes(color=species))+
   scale_color_manual(values=c25) #+
 # geom_point(data=observed_biom,aes(x=time,y=biomass, group=species))


new_bio %>%
  #pivot_longer(Q1:Q6, names_to = "question", values_to = "response") %>%
  ggplot(aes(x = time, y=biomass)) +
  geom_line() +
  facet_wrap(vars(species))#, ncol = 3) +
  #labs(x = "Response (on a 1 to 5 scale)", y = "Number of respondents")

```

### PLAYING WITH CLIMATE CHANGE

<https://mizer.course.aug22.sizespectrum.org/use/change-resources.html>
#Scenario 1: Changes in resource replenishment rate

By default, mizer uses a semichemostat model to describe the resource
dynamics in each size class independently

Scenario 1: Changes in resource replenishment rate We will now change
the resource replenishment rate for plankton to see how that affects the
resource level for plankton and how that affects the system’s response
to changes in fishing. We change the value of the r_pp for the plankton
resource and choose the two values 10 and 1 for the high and the low
replenishment rate.

```{r}
# Create new data frame for high and low plankton replenishment
cm<-cur_model

rp <- resource_params(cm)

rp_Pl_high <- rp
rp_Pl_high["n"] <- 0.8

rp_Pl_curr <- rp
rp_Pl_curr["n"]<-0.75

rp_Pl_low <- rp
rp_Pl_low["n"] <- 0.7

cm_Pl_high <- setResource(cm, 
                      resource_dynamics = "resource_semichemostat", 
                      resource_rate = 10*(resource_rate(cur_model)))

cm_Pl_curr <- setResource(cm, 
                      resource_dynamics = "resource_semichemostat", 
                       resource_rate = resource_rate(cur_model))

cm_Pl_low <- setResource(cm, 
                      resource_dynamics = "resource_semichemostat", 
                      resource_rate = 0.1*resource_rate(cur_model))

#cm_Pl_high <- resource_semichemostat(cm, rp_Pl_high)
#cm_Pl_curr<- setResource(cm, rp_Pl_curr)
#cm_Pl_low <- setResource(cm, rp_Pl_low)

plotResourceLevel(cm_Pl_low)
plotResourceLevel(cm_Pl_curr)
plotResourceLevel(cm_Pl_high)
```

The changed resource level should lead to differences when we perturb
the system away from its steady state. We will perturb the system by
imposing a higher fishing effort.We will run simulations with the
reduced and the increased replenishment rate with a fishing effort of
0.7. As a result of that higher fishing effort, the fish biomasses will
change and hence resource consumption will change. The resource level
will determine how sensitive the system is to that change.

```{r}
# Lower replenishment, higher effort 
sim_lower <- project(cm_Pl_low, effort = 1.05, t_max = 30,t_save=3)
plotlyBiomassRelative(sim_lower)
# Higher replenishment, higher effort 
sim_higher <- project(cm_Pl_high, effort = 1.05, t_max = 30,t_save=3)
plotlyBiomassRelative(sim_higher)
plotlyBiomassRelative(sim_lower, sim_higher)
```

Very tiny differences -

The differences in the response of the system to the higher fishing
effort are not very different for the two different resource
replenishment rates. To see the differences better we plot their
relative difference.

We can see that in this case the differences are never much more than
4%, which is very little considering all the uncertainties in the model.
We conclude that for our model, when we want to explore increases in
fishing effort, the choice of value for r_pp may not be so important, as
the model is not very sensitive to it. However, that may be an artefact
of how we have set up external mortality in our model. In our model,
mortalities on small individuals are very low and we didn’t bother to
fix them with additional mortality to get the allometric mortality rates
observed in nature. Had we done that, even small changes in the resource
and hence in the larval feeding levels might be important. This is
because lower feeding by larvae will make them grow slower, they will
spend more time in smallest size classes with very high mortality, and
this will affect the entire ecosystem. You can read about it, in this
study. And if you want to explore it further and implement it to your
model, the mizer code is here.

the system is to that change.

```{r}
# Lower replenishment, higher effort 
sim_lower <- project(cm_Pl_low, effort = 1.01, t_max = 30,t_save=3)
plotlyBiomassRelative(sim_lower)
# Higher replenishment, higher effort 
sim_higher <- project(cm_Pl_high, effort = 1.01, t_max = 30,t_save=3)
plotlyBiomassRelative(sim_higher)
plotlyBiomassRelative(sim_lower, sim_higher)
```

###Scenario 2: Changes in total plankton abundance Now we want to
explore how our ecosystem might respond to the overall changes in
resource abundance. Perhaps due to climate change the overall resource
abundance will increase or decrease. We can explore this in a simple way
by changing the kappa parameter.

Now we will change plankton kappa in the same way as we changed r_pp in
the previous scenario. Just to make sure we see some impact, let’s
increase or decrease kappa by 50% and project to a new state.

```{r}
# Create new resource parameter data frames for more and less plankton 
rp_more_pl <- rp
rp_less_pl <- rp

# Increase kappa by 50%
rp_more_pl$kappa  <- rp_more_pl$kappa * 1.5

# Decrease kappa by 50% 
rp_less_pl$kappa  <- rp_less_pl$kappa  / 1.5

cm_more_pl<- setResource(cm, rp_more_pl)


plotSpectra2(cm_more_pl, "More", cm, "Less", power = 2)
```

```{r}
remotes::install_github("sizespectrum/therMizer")
library(therMizer)
```

params \<- upgradeTherParams(params = params, temp_min = temp_min,
temp_max = temp_max, ocean_temp_array = ocean_temp_array, n_pp_array =
n_pp_array, vertical_migration_array = vertical_migration_array,
exposure_array = exposure_array, aerobic_effect = TRUE,
metabolism_effect = TRUE)
